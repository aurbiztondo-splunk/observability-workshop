<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.12.2+tip"><meta name=description content="Splunk Observability ワークショップ"><title>OpenTelemetry Collector を Kubernetes に導入する :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.84/en/imt/gdi/index.html rel=alternate hreflang=x-default><link href=https://splunk.github.io/observability-workshop/v4.84/en/imt/gdi/index.html rel=alternate hreflang=en><link href=https://splunk.github.io/observability-workshop/v4.84/ja/imt/gdi/index.html rel=alternate hreflang=ja><link href=https://splunk.github.io/observability-workshop/v4.84/ja/imt/gdi/index.html rel=canonical type=text/html title="OpenTelemetry Collector を Kubernetes に導入する :: Splunk Observability Cloud Workshops"><link href=../../../ja/imt/gdi/index.xml rel=alternate type=application/rss+xml title="OpenTelemetry Collector を Kubernetes に導入する :: Splunk Observability Cloud Workshops"><link href=../../../images/favicon.ico?1683738330 rel=icon type=image/x-icon><link href=../../../css/fontawesome-all.min.css?1683738330 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fontawesome-all.min.css?1683738330 rel=stylesheet></noscript><link href=../../../css/nucleus.css?1683738330 rel=stylesheet><link href=../../../css/auto-complete.css?1683738330 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/auto-complete.css?1683738330 rel=stylesheet></noscript><link href=../../../css/perfect-scrollbar.min.css?1683738330 rel=stylesheet><link href=../../../css/fonts.css?1683738330 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fonts.css?1683738330 rel=stylesheet></noscript><link href=../../../css/theme.css?1683738330 rel=stylesheet><link href=../../../css/theme-splunk-light.css?1683738330 rel=stylesheet id=variant-style><link href=../../../css/variant.css?1683738330 rel=stylesheet><link href=../../../css/print.css?1683738330 rel=stylesheet media=print><link href=../../../css/format-print.css?1683738330 rel=stylesheet><link href=../../../css/ie.css?1683738330 rel=stylesheet><script src=../../../js/url.js?1683738330></script>
<script src=../../../js/variant.js?1683738330></script>
<script>window.index_js_url="../../../ja/index.search.js";var root_url="../../../",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="クリップボードにコピー",window.T_Copied_to_clipboard="クリップボードにコピー!",window.T_Copy_link_to_clipboard="リンクをクリップボードにコピー",window.T_Link_copied_to_clipboard="リンクをクリップボードにコピーしました!",window.T_No_results_found="\u0022{0}\u0022 の結果が見つかりません",window.T_N_results_found="\u0022{0}\u0022 で {1} 件の結果が見つかりました",baseUriFull="https://splunk.github.io/observability-workshop/v4.84/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script><style>@media screen and (min-width:1300px){#body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1300px;width:100%}}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../ja/imt/gdi/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='メニュー (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../ja/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../ja/imt/index.html><span itemprop=name>Splunk IM</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>OpenTelemetry Collector を Kubernetes に導入する</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=opentelemetry-collector-を-kubernetes-に導入する>OpenTelemetry Collector を Kubernetes に導入する</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
15分</button></span><ul><li>Splunk Helm chartを使用して、K3s に OpenTelemetry Collector をインストールします</li><li>Kubernetes Navigatorでクラスタを探索します</li></ul><hr><h2 id=1-access-tokenの取得>1. Access Tokenの取得</h2><p>Kubernetes が起動したら、Splunk の UI から Access Token<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> を取得する必要があります。Access Token は、左下にある <strong>&#187;</strong> を開き、 <strong>Settings → Access Tokens</strong> を選択すると表示されます。</p><p>主催者が指示したワークショップトークン（例： <strong>O11y-Workshop-ACCESS</strong> 等）を開き、 <strong>Show Token</strong> をクリックしてトークンを公開します。
<span class="btn cstyle grey"><button type=button>
Copy</button></span> ボタンをクリックし、クリップボードにコピーしてください。 <strong>Default</strong> のトークンは使用しないでください。</p><p><a href=#image-ffa273e59f85d6a6f5b5f1ee9d1602c4 class=lightbox-link><img src=../../../ja/imt/gdi/../images/access-token.png alt="Access Token" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ffa273e59f85d6a6f5b5f1ee9d1602c4><img src=../../../ja/imt/gdi/../images/access-token.png alt="Access Token" class=lightbox-image loading=lazy></a></p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:warning><div class=box-label>独自のトークンを新たに作成しないようにしてください</div><div class=box-content><p>このワークショップのために設定のトークンを作成し、IngestとAPIの両方の権限を割り当てています。実運用でのベストプラクティスは、1つのTokenにはIngestまたはAPIまたはRUMのような単一のパーミッションを割り当て、必要な場合は複数のトークンを使用することです。</p></div></div><p>また、Splunk アカウントの Realm<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> の名前を取得する必要があります。サイドメニューの最上部の名前をクリックし、<strong>Account Settings</strong> ページに移動します。Organizations タブをクリックします。Realm はページの中央に表示されています。 この例では「us0」となっています。</p><p><a href=#image-e2021a71f70c676064dd4e4afddc1c81 class=lightbox-link><img src=../../../ja/imt/gdi/../images/account-settings.png alt="Account Settings" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e2021a71f70c676064dd4e4afddc1c81><img src=../../../ja/imt/gdi/../images/account-settings.png alt="Account Settings" class=lightbox-image loading=lazy></a></p><h2 id=2-helmによるインストール>2. Helmによるインストール</h2><p>環境変数 <code>ACCESS_TOKEN</code> と <code>REALM</code> を作成して、進行中の Helm のインストールコマンドで使用します。例えば、Realm が <code>us1</code> の場合は、<code>export REALM=us1</code> と入力し、<code>eu0</code> の場合は、<code>export REALM=eu0</code> と入力します。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Export ACCESS TOKEN" class="tab-nav-button active" onclick='switchTab("default","Export ACCESS TOKEN")'>
<span>Export ACCESS TOKEN</span></button></div><div class=tab-content><div data-tab-item="Export ACCESS TOKEN" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ACCESS_TOKEN</span><span class=o>=</span><span class=s2>&#34;&lt;replace_with_O11y-Workshop-ACCESS_TOKEN&gt;&#34;</span>
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Export REALM" class="tab-nav-button active" onclick='switchTab("default","Export REALM")'>
<span>Export REALM</span></button></div><div class=tab-content><div data-tab-item="Export REALM" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>REALM</span><span class=o>=</span><span class=s2>&#34;&lt;replace_with_REALM&gt;&#34;</span>
</span></span></code></pre></div></div></div></div><p>Splunk Helm チャートを使って OpenTelemetry Collector をインストールします。まず、Splunk Helm chart のリポジトリを Helm に追加してアップデートします。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Repo Add" class="tab-nav-button active" onclick='switchTab("default","Helm Repo Add")'>
<span>Helm Repo Add</span></button>
<button data-tab-item="Helm Repo Add Output" class=tab-nav-button onclick='switchTab("default","Helm Repo Add Output")'>
<span>Helm Repo Add Output</span></button></div><div class=tab-content><div data-tab-item="Helm Repo Add" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update
</span></span></code></pre></div></div><div data-tab-item="Helm Repo Add Output" class=tab-content-text><p>Using ACCESS_TOKEN={REDACTED}
Using REALM=eu0
&ldquo;splunk-otel-collector-chart&rdquo; has been added to your repositories
Using ACCESS_TOKEN={REDACTED}
Using REALM=eu0
Hang tight while we grab the latest from your chart repositories&mldr;
&mldr;Successfully got an update from the &ldquo;splunk-otel-collector-chart&rdquo; chart repository
Update Complete. ⎈Happy Helming!⎈</p></div></div></div><p>以下のコマンドでOpenTelemetry Collector Helmチャートをインストールします。これは <strong>変更しないでください</strong>。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Install" class="tab-nav-button active" onclick='switchTab("default","Helm Install")'>
<span>Helm Install</span></button>
<button data-tab-item="Helm Install Output" class=tab-nav-button onclick='switchTab("default","Helm Install Output")'>
<span>Helm Install Output</span></button>
<button data-tab-item="Install Network Explorer" class=tab-nav-button onclick='switchTab("default","Install Network Explorer")'>
<span>Install Network Explorer</span></button></div><div class=tab-content><div data-tab-item="Helm Install" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=k>$(</span>hostname<span class=k>)</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.logsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.profilingEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=</span><span class=k>$(</span>hostname<span class=k>)</span><span class=s2>-apm-env&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml
</span></span></code></pre></div></div><div data-tab-item="Helm Install Output" class=tab-content-text><p>Using ACCESS_TOKEN={REDACTED}
Using REALM=eu0
NAME: splunk-otel-collector
LAST DEPLOYED: Fri May 7 11:19:01 2021
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None</p></div><div data-tab-item="Install Network Explorer" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=k>$(</span>hostname<span class=k>)</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.logsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;networkExplorer.enabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;networkExplorer.podSecurityPolicy.enabled=false&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;agent.enabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;gateway.replicaCount=1&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;gateway.resources.limits.cpu=500m&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;gateway.resources.limits.memory=1Gi&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterReceiver.enabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=</span><span class=k>$(</span>hostname<span class=k>)</span><span class=s2>-apm-env&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml
</span></span></code></pre></div></div></div></div><p>約30秒程度待ってから <code>kubectl get pods</code> を実行すると、新しいポッドが稼働していることが報告され、デプロイメントの進捗を監視することができます。</p><p>続行する前に、ステータスがRunningと報告されていることを確認してください。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Kubectl Get Pods" class="tab-nav-button active" onclick='switchTab("default","Kubectl Get Pods")'>
<span>Kubectl Get Pods</span></button>
<button data-tab-item="Kubectl Get Pods Output" class=tab-nav-button onclick='switchTab("default","Kubectl Get Pods Output")'>
<span>Kubectl Get Pods Output</span></button></div><div class=tab-content><div data-tab-item="Kubectl Get Pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods
</span></span></code></pre></div></div><div data-tab-item="Kubectl Get Pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-2sk6k                             0/1     Running   0          10s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6956d4446f-gwnd7   0/1     Running   0          10s
</span></span></code></pre></div></div></div></div><p>OpenTelemetry Collector podのログを確認して、エラーがないことを確認します。出力は、以下の出力例にあるログに似ているはずです。</p><p>ログを確認するには、<code>helm</code> のインストールで設定したラベルを使用してください（終了するには <strong>ctrl+c</strong> を押します）。もしくは、インストールされている <code>k9s</code> ターミナル UI を使うとボーナスポイントがもらえます！</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Kubectl Logs" class="tab-nav-button active" onclick='switchTab("default","Kubectl Logs")'>
<span>Kubectl Logs</span></button>
<button data-tab-item="Kubectl Logs Output" class=tab-nav-button onclick='switchTab("default","Kubectl Logs Output")'>
<span>Kubectl Logs Output</span></button></div><div class=tab-content><div data-tab-item="Kubectl Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector
</span></span></code></pre></div></div><div data-tab-item="Kubectl Logs Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    service/service.go:364  Starting receivers...
</span></span><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/watcher.go:195       Configured Kubernetes MetadataExporter  {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;, &#34;exporter_name&#34;: &#34;signalfx&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    healthcheck/handler.go:128      Health Check state change       {&#34;component_kind&#34;: &#34;extension&#34;, &#34;component_type&#34;: &#34;health_check&#34;, &#34;component_name&#34;: &#34;health_check&#34;, &#34;status&#34;: &#34;ready&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    service/service.go:267  Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:59       Starting shared informers and wait for initial cache sync.      {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.281Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:75       Completed syncing shared informer caches.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span></code></pre></div></div></div></div><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>インストールに失敗した場合に削除する</div><div class=box-content><p>OpenTelemetry Collectorのインストールに失敗した場合は、次のようにしてインストールを削除することで、最初からやり直すことができます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm delete splunk-otel-collector
</span></span></code></pre></div></div></div><hr><h2 id=3-ui-でメトリクスを確認する>3. UI でメトリクスを確認する</h2><p>Splunk の UI で左下の <strong>&#187;</strong> を開いて <strong>Infrastructure</strong> をクリックします。</p><p><a href=#image-f9c13191777f02aaaceb74ef73339fe8 class=lightbox-link><img src=../../../ja/imt/gdi/../images/clustermap-nav.png alt="Kubernetes Navigator Mapの選択" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f9c13191777f02aaaceb74ef73339fe8><img src=../../../ja/imt/gdi/../images/clustermap-nav.png alt="Kubernetes Navigator Mapの選択" class=lightbox-image loading=lazy></a></p><p><strong>Containers</strong> の下にある <strong>Kubernetes</strong> をクリックして Kubernetes Navigator Cluster Map を開き、メトリクスが送信されていることを確認します。</p><p>クラスタが検出され、レポートされていることを確認するには、自分のクラスタを探します（ワークショップでは、他の多くのクラスタが表示されます）。クラスタ名を見つけるには、以下のコマンドを実行し、出力をクリップボードにコピーしてください。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Echo Cluster Name" class="tab-nav-button active" onclick='switchTab("default","Echo Cluster Name")'>
<span>Echo Cluster Name</span></button></div><div class=tab-content><div data-tab-item="Echo Cluster Name" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=k>$(</span>hostname<span class=k>)</span>-k3s-cluster
</span></span></code></pre></div></div></div></div><p>次に、UIで、Splunkロゴのすぐ下にある「Cluster: - 」メニューをクリックし、先程コピーしたクラスタ名を検索ボックスに貼り付け、チェックボックスをクリックしてクラスタを選択し、最後にメニューのその他の部分をクリックしてフィルタを適用します。</p><p><a href=#image-b8801c1b7350786feff554d1ac5be9fe class=lightbox-link><img src=../../../ja/imt/gdi/../images/search-k3s-cluster.png alt="K8S Clusters Filter" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b8801c1b7350786feff554d1ac5be9fe><img src=../../../ja/imt/gdi/../images/search-k3s-cluster.png alt="K8S Clusters Filter" class=lightbox-image loading=lazy></a></p><p><a href=#image-7a976ac2ad7a4083ecff588a640e288a class=lightbox-link><img src=../../../ja/imt/gdi/../images/selecting-k3s-cluster.png alt="Select K8S Cluster" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7a976ac2ad7a4083ecff588a640e288a><img src=../../../ja/imt/gdi/../images/selecting-k3s-cluster.png alt="Select K8S Cluster" class=lightbox-image loading=lazy></a></p><p><a href=#image-89579b67aec506df01ac57ebcb796ce6 class=lightbox-link><img src=../../../ja/imt/gdi/../images/filtered-k3s-cluster.png alt="Filtered K8S Cluster" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-89579b67aec506df01ac57ebcb796ce6><img src=../../../ja/imt/gdi/../images/filtered-k3s-cluster.png alt="Filtered K8S Cluster" class=lightbox-image loading=lazy></a></p><p>ノードの状態を確認するには、クラスターの淡いブルーの背景にカーソルを置き、左上に表示される青い虫眼鏡をクリックしてください 。
<a href=#image-f121cb786aaad6f627afcc487ccef521 class=lightbox-link><img src=../../../ja/imt/gdi/../images/blue-cross.png alt="Magnifying Glass" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f121cb786aaad6f627afcc487ccef521><img src=../../../ja/imt/gdi/../images/blue-cross.png alt="Magnifying Glass" class=lightbox-image loading=lazy></a></p><p>これで、ノードレベルまでドリルダウンできます。 次に、サイドバーボタンをクリックしてサイドバーを開き、Metricsサイドバーを開きます。</p><p>サイドのスライダーを使って、CPU、メモリ、ネットワーク、イベントなど、クラスタ/ノードに関連する様々なチャートを見ることができます。</p><p><a href=#image-bdeb93553e4c4c8eecf164ff0353ce87 class=lightbox-link><img src=../../../ja/imt/gdi/../images/explore-metrics.png alt="Sidebar metrics" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-bdeb93553e4c4c8eecf164ff0353ce87><img src=../../../ja/imt/gdi/../images/explore-metrics.png alt="Sidebar metrics" class=lightbox-image loading=lazy></a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Access Tokens (Org Tokensと呼ばれることもあります)は、長期間利用を前提とした組織レベルのトークンです。デフォルトでは、これらのトークンは 5 年間保存されます。そのため、長期間にわたってデータポイントを送信するエミッターに組み込んだり、Splunk API を呼び出す長期的なスクリプトに使用したりするのに適しています。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Realm とは、Splunk内部の管理単位ので、その中で組織がホストされます。異なる Realm には異なる API エンドポイントがあります (たとえば、データを送信するためのエンドポイントは、<strong><code>us1</code></strong> realm では <code>ingest.us1.signalfx.com</code> 、<strong><code>eu0</code></strong> レルムでは <code>ingest.eu0.signalfx.com</code> となります)。このrealm名は、Splunk UI のプロファイルページに表示されます。エンドポイントを指定する際にレルム名を含めない場合、Splunk は <strong><code>us0</code></strong> レルムを指していると解釈します。&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article><section><h1 class=a11y-only>OpenTelemetry Collector を Kubernetes に導入するのサブセクション</h1><article class=default><h1 id=k3s-に-nginx-をデプロイする>K3s に NGINX をデプロイする</h1><ul><li>NGINX ReplicaSet を K3s クラスタにデプロイし、NGINX デプロイメントのディスカバリーを確認します。</li><li>負荷テストを実行してメトリクスを作成し、Splunk Observability Cloudにストリーミングすることを確認します！</li></ul><hr><h2 id=1-nginx-の起動>1. NGINX の起動</h2><p>Splunk UI で <strong>WORKLOADS</strong> タブを選択して、実行中の Pod の数を確認します。これにより、クラスタ上のワークロードの概要がわかるはずです。</p><p><a href=#image-f7fdcf74a5aa76f073424f78d8ca22a8 class=lightbox-link><img src=../../../ja/imt/gdi/nginx/../../images/k8s-workloads.png alt="Workload Agent" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f7fdcf74a5aa76f073424f78d8ca22a8><img src=../../../ja/imt/gdi/nginx/../../images/k8s-workloads.png alt="Workload Agent" class=lightbox-image loading=lazy></a></p><p>デフォルトの Kubernetes Pod のうち、ノードごとに実行されている単一のエージェントコンテナに注目してください。この1つのコンテナが、このノードにデプロイされているすべての Pod とサービスを監視します！</p><p>次に、<strong>MAP</strong> タブを選択してデフォルトのクラスタノードビューに戻し、再度クラスタを選択します。</p><p>Multipass または AWS/EC2 のシェルセッションで、<code>nginx</code> ディレクトリに移動します。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Change Directory" class="tab-nav-button active" onclick='switchTab("default","Change Directory")'>
<span>Change Directory</span></button></div><div class=tab-content><div data-tab-item="Change Directory" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/workshop/k3s/nginx
</span></span></code></pre></div></div></div></div><hr><h2 id=2-nginxのデプロイメント作成>2. NGINXのデプロイメント作成</h2><p>NGINX の ConfigMap<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> を <code>nginx.conf</code> ファイルを使って作成します。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Kubectl Configmap Create" class="tab-nav-button active" onclick='switchTab("default","Kubectl Configmap Create")'>
<span>Kubectl Configmap Create</span></button>
<button data-tab-item="Kubectl Create Configmap Output" class=tab-nav-button onclick='switchTab("default","Kubectl Create Configmap Output")'>
<span>Kubectl Create Configmap Output</span></button></div><div class=tab-content><div data-tab-item="Kubectl Configmap Create" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create configmap nginxconfig --from-file<span class=o>=</span>nginx.conf
</span></span></code></pre></div></div><div data-tab-item="Kubectl Create Configmap Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>configmap/nginxconfig created
</span></span></code></pre></div></div></div></div><p>続いて、デプロイメントを作成します。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Kubectl Create Deployment" class="tab-nav-button active" onclick='switchTab("default","Kubectl Create Deployment")'>
<span>Kubectl Create Deployment</span></button>
<button data-tab-item="Kubectl Create Deployment Output" class=tab-nav-button onclick='switchTab("default","Kubectl Create Deployment Output")'>
<span>Kubectl Create Deployment Output</span></button></div><div class=tab-content><div data-tab-item="Kubectl Create Deployment" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f nginx-deployment.yaml
</span></span></code></pre></div></div><div data-tab-item="Kubectl Create Deployment Output" class=tab-content-text><p>deployment.apps/nginx created
service/nginx created</p></div></div></div><p>次に、NGINXに対する負荷テストを作成するため、 Locust<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> をデプロイします。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Kubectl Create Deployment" class="tab-nav-button active" onclick='switchTab("default","Kubectl Create Deployment")'>
<span>Kubectl Create Deployment</span></button>
<button data-tab-item="Kubectl Create Deployment Output" class=tab-nav-button onclick='switchTab("default","Kubectl Create Deployment Output")'>
<span>Kubectl Create Deployment Output</span></button></div><div class=tab-content><div data-tab-item="Kubectl Create Deployment" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f locust-deployment.yaml
</span></span></code></pre></div></div><div data-tab-item="Kubectl Create Deployment Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/nginx-loadgenerator created
</span></span><span class=line><span class=cl>service/nginx-loadgenerator created
</span></span></code></pre></div></div></div></div><p>デプロイメントが成功し、Locust と NGINX Pod が動作していることを確認しましょう。</p><p>Splunk UI を開いていれば、新しい Pod が起動し、コンテナがデプロイされているのがわかるはずです。</p><p>Pod が実行状態に移行するまでには 20 秒程度しかかかりません。Splunk UIでは、以下のようなクラスタが表示されます。</p><p><a href=#image-3eb4b4559ad1f093dcd6b8a3f252a757 class=lightbox-link><img src=../../../ja/imt/gdi/nginx/../../images/cluster.png alt="Back to Cluster" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-3eb4b4559ad1f093dcd6b8a3f252a757><img src=../../../ja/imt/gdi/nginx/../../images/cluster.png alt="Back to Cluster" class=lightbox-image loading=lazy></a></p><p>もう一度 <strong>WORKLOADS</strong> タブを選択すると、新しい ReplicaSet と NGINX 用のデプロイメントが追加されていることがわかります。</p><p><a href=#image-3b3c233af8992f5bbe5f6bdfa22dd0a4 class=lightbox-link><img src=../../../ja/imt/gdi/nginx/../../images/k8s-workloads-nginx.png alt="NGINX loaded" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-3b3c233af8992f5bbe5f6bdfa22dd0a4><img src=../../../ja/imt/gdi/nginx/../../images/k8s-workloads-nginx.png alt="NGINX loaded" class=lightbox-image loading=lazy></a></p><hr><p>これをシェルでも検証してみましょう。</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Kubectl Get Pods" class="tab-nav-button active" onclick='switchTab("default","Kubectl Get Pods")'>
<span>Kubectl Get Pods</span></button>
<button data-tab-item="Kubectl Get Pods Output" class=tab-nav-button onclick='switchTab("default","Kubectl Get Pods Output")'>
<span>Kubectl Get Pods Output</span></button></div><div class=tab-content><div data-tab-item="Kubectl Get Pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods
</span></span></code></pre></div></div><div data-tab-item="Kubectl Get Pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-77784c659c-ttmpk   1/1     Running   0          9m19s
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-249rd                             1/1     Running   0          9m19s
</span></span><span class=line><span class=cl>svclb-nginx-vtnzg                                             1/1     Running   0          5m57s
</span></span><span class=line><span class=cl>nginx-7b95fb6b6b-7sb9x                                        1/1     Running   0          5m57s
</span></span><span class=line><span class=cl>nginx-7b95fb6b6b-lnzsq                                        1/1     Running   0          5m57s
</span></span><span class=line><span class=cl>nginx-7b95fb6b6b-hlx27                                        1/1     Running   0          5m57s
</span></span><span class=line><span class=cl>nginx-7b95fb6b6b-zwns9                                        1/1     Running   0          5m57s
</span></span><span class=line><span class=cl>svclb-nginx-loadgenerator-nscx4                               1/1     Running   0          2m20s
</span></span><span class=line><span class=cl>nginx-loadgenerator-755c8f7ff6-x957q                          1/1     Running   0          2m20s
</span></span></code></pre></div></div></div></div><hr><h2 id=3-locust-の負荷テストの実行>3. Locust の負荷テストの実行</h2><p>Locust はオープンソースの負荷テストツールで、EC2 インスタンスの IP アドレスの8080番ポートで Locust が利用できるようになりました。Webブラウザで新しいタブを開き、<code>http://{==EC2-IP==}:8080/</code>にアクセスすると、Locust が動作しているのが確認できます。</p><p><a href=#image-1715ed974f0763ef8f3fe61287a4e430 class=lightbox-link><img src=../../../ja/imt/gdi/nginx/../../images/nginx-locust.png alt=Locust style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1715ed974f0763ef8f3fe61287a4e430><img src=../../../ja/imt/gdi/nginx/../../images/nginx-locust.png alt=Locust class=lightbox-image loading=lazy></a></p><p><strong>Spawn rate</strong> を 2 に設定し、<strong>Start Swarming</strong> をクリックします。</p><p><a href=#image-a1d43bb3c7b7b9177654340d5b1b57a8 class=lightbox-link><img src=../../../ja/imt/gdi/nginx/../../images/nginx-locust-spawn-rate.png alt="Locust Spawn Rate" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a1d43bb3c7b7b9177654340d5b1b57a8><img src=../../../ja/imt/gdi/nginx/../../images/nginx-locust-spawn-rate.png alt="Locust Spawn Rate" class=lightbox-image loading=lazy></a></p><p>これにより、アプリケーションに緩やかな連続した負荷がかかるようになります。</p><p><a href=#image-bf76d8a9608d62ead5e1b64501260bad class=lightbox-link><img src=../../../ja/imt/gdi/nginx/../../images/nginx-locust-statistics.png alt="Locust Statistics" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-bf76d8a9608d62ead5e1b64501260bad><img src=../../../ja/imt/gdi/nginx/../../images/nginx-locust-statistics.png alt="Locust Statistics" class=lightbox-image loading=lazy></a></p><p>上記のスクリーンショットからわかるように、ほとんどのコールは失敗を報告しています。これはアプリケーションをまだデプロイしていないため予想されることですが、NGINXはアクセス試行を報告しており、これらのメトリックも見ることができます。</p><p>サイドメニューから <strong>Dashboards → Built-in Dashboard Groups → NGINX → NGINX Servers</strong> を選択して、UIにメトリクスが表示されていることを確認します。さらに <strong>Overrides</strong> フィルターを適用して、 <code>k8s.cluster.name:</code> に、ターミナルの <code>echo $(hostname)-k3s-cluster</code> で返されるクラスタの名前を見つけます。</p><p><a href=#image-11cc00e33a4924a40ea1e77853e01daa class=lightbox-link><img src=../../../ja/imt/gdi/nginx/../../images/nginx-dashboard.png alt=NGINXダッシュボード style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-11cc00e33a4924a40ea1e77853e01daa><img src=../../../ja/imt/gdi/nginx/../../images/nginx-dashboard.png alt=NGINXダッシュボード class=lightbox-image loading=lazy></a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>ConfigMap とは、キーと値のペアで非機密データを保存するために使用される API オブジェクトです。Pod は、環境変数、コマンドライン引数、またはボリューム内の構成ファイルとして ConfigMap を利用することができます。ConfigMap を使用すると、環境固有の構成をコンテナイメージから切り離すことができるため、アプリケーションの移植が容易になります。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://locust.io/ target=_blank>Locust とは？</a>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article></section></div></main></div><script src=../../../js/clipboard.min.js?1683738331 defer></script>
<script src=../../../js/perfect-scrollbar.min.js?1683738331 defer></script>
<script src=../../../js/theme.js?1683738331 defer></script></body></html>