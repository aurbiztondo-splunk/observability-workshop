<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.16.2+tip"><meta name=description content="This workshop will equip you with how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis"><title>Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.90/en/other/lambda-kinesis/index.html rel=canonical type=text/html title="Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops"><link href=../../../en/other/lambda-kinesis/index.xml rel=alternate type=application/rss+xml title="Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops"><link href=../../../images/favicon.ico?1686840499 rel=icon type=image/x-icon sizes=any><link href=../../../css/fontawesome-all.min.css?1686840503 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fontawesome-all.min.css?1686840503 rel=stylesheet></noscript><link href=../../../css/nucleus.css?1686840503 rel=stylesheet><link href=../../../css/auto-complete.css?1686840503 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/auto-complete.css?1686840503 rel=stylesheet></noscript><link href=../../../css/perfect-scrollbar.min.css?1686840503 rel=stylesheet><link href=../../../css/fonts.css?1686840503 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fonts.css?1686840503 rel=stylesheet></noscript><link href=../../../css/theme.css?1686840503 rel=stylesheet><link href=../../../css/theme-splunk-light.css?1686840503 rel=stylesheet id=variant-style><link href=../../../css/variant.css?1686840503 rel=stylesheet><link href=../../../css/print.css?1686840503 rel=stylesheet media=print><link href=../../../css/format-print.css?1686840503 rel=stylesheet><link href=../../../css/ie.css?1686840503 rel=stylesheet><script src=../../../js/url.js?1686840503></script>
<script src=../../../js/variant.js?1686840503></script>
<script>window.index_js_url="../../../en/index.search.js";var root_url="../../../",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.90/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script><style>@media screen and (min-width:1300px){#body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1300px;width:100%}}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../en/other/lambda-kinesis/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../en/other/index.html><span itemprop=name>Other Workshops</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Build a Distributed Trace in Lambda and Kinesis</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=build-a-distributed-trace-in-lambda-and-kinesis>Build a Distributed Trace in Lambda and Kinesis</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>This workshop will equip you with how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis.</p><p>We will see how auto-instrumentation works with manual steps to force a Producer function&rsquo;s context to be sent to Consumer function via a Record put on a Kinesis stream.</p><p>For this workshop Splunk has prepared an Ubuntu Linux instance in AWS/EC2 all pre-configured for you.</p><p>To get access to the instance that you will be using in the workshop, please visit the URL provided by the workshop leader.d</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Build a Distributed Trace in Lambda and Kinesis</h1><article class=default><header class=headline></header><h1 id=setup>Setup</h1><p>This lab will make a tracing superhero out of you!</p><p>In this lab you will learn how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming your message via AWS Kinesis.</p><p><a href=#image-bd44f588b295bd0b9fe3b48ce16fa364 class=lightbox-link><img src=../../../en/other/lambda-kinesis/1-setup/../images/1-architecture.png alt=1-architecture style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-bd44f588b295bd0b9fe3b48ce16fa364><img src=../../../en/other/lambda-kinesis/1-setup/../images/1-architecture.png alt=1-architecture class=lightbox-image loading=lazy></a></p><h2 id=pre-requisites>Pre-requisites</h2><p>You should already have the lab content available on your EC2 lab host.</p><p>Ensure that this lab&rsquo;s required folder o11y-lambda-lab is on your home directory:</p><div class=tab-panel data-tab-group=aae21fd71ab0e66e2d4b6e2ed56dfb81><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("aae21fd71ab0e66e2d4b6e2ed56dfb81","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button>
<button data-tab-item=Output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("aae21fd71ab0e66e2d4b6e2ed56dfb81","Output")'><div><div class=tab-nav-hidden>Output</div><div class=tab-nav-text>Output</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~ <span class=o>&amp;&amp;</span> ls
</span></span></code></pre></div></div></div><div data-tab-item=Output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>o11y-lambda-lab
</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>If you don&rsquo;t see it, fetch the lab contents by running the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/kdroukman/o11y-lambda-lab.git
</span></span></code></pre></div></div></div><h2 id=set-environment-variables>Set Environment Variables</h2><p>In your Splunk Observability Cloud Organisation (Org) obtain your Access Token and Realm Values.</p><p>Please reset your environment variables from the earlier lab. Take care that for this lab we may be using different names - make sure to match the Environment Variable names bellow.</p><div class=tab-panel data-tab-group=d23e595776496bc84c32b1955f8d30a0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Export Environment Variables" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("d23e595776496bc84c32b1955f8d30a0","Export Environment Variables")'><div><div class=tab-nav-hidden>Export Environment Variables</div><div class=tab-nav-text>Export Environment Variables</div></div></button></div><div class=tab-content-container><div data-tab-item="Export Environment Variables" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>export ACCESS_TOKEN</span><span class=o>=</span><span class=s>CHANGE_ME \</span>
</span></span><span class=line><span class=cl><span class=na>export REALM</span><span class=o>=</span><span class=s>CHANGE_ME \</span>
</span></span><span class=line><span class=cl><span class=na>export PREFIX</span><span class=o>=</span><span class=s>$(hostname)</span>
</span></span></code></pre></div></div></div></div></div><h2 id=update-auto-instrumentation-serverless-template>Update Auto-instrumentation serverless template</h2><p>Update your auto-instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=36072235c6d4deef0a9f87c9ff078ebd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Substitute Environment Variables" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("36072235c6d4deef0a9f87c9ff078ebd","Substitute Environment Variables")'><div><div class=tab-nav-hidden>Substitute Environment Variables</div><div class=tab-nav-text>Substitute Environment Variables</div></div></button></div><div class=tab-content-container><div data-tab-item="Substitute Environment Variables" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/auto/serverless_unset.yml <span class=p>|</span> envsubst &gt; ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=184bd11661d3e4c08de2bcf35844c210><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Check file contents" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("184bd11661d3e4c08de2bcf35844c210","Check file contents")'><div><div class=tab-nav-hidden>Check file contents</div><div class=tab-nav-text>Check file contents</div></div></button>
<button data-tab-item="Expected Content" class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("184bd11661d3e4c08de2bcf35844c210","Expected Content")'><div><div class=tab-nav-hidden>Expected Content</div><div class=tab-nav-text>Expected Content</div></div></button></div><div class=tab-content-container><div data-tab-item="Check file contents" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div></div><div data-tab-item="Expected Content" class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># USER SET VALUES =====================              </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>custom</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessToken</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Access Token&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>realm</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Realm&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Hostname&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#====================================== </span><span class=w>
</span></span></span></code></pre></div></div></div></div></div><h2 id=update-manual-instrumentation-template>Update Manual instrumentation template</h2><p>Update your manual instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=c46cbc71295ac4804a74d408658e6bde><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Substitute Environment Variables" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("c46cbc71295ac4804a74d408658e6bde","Substitute Environment Variables")'><div><div class=tab-nav-hidden>Substitute Environment Variables</div><div class=tab-nav-text>Substitute Environment Variables</div></div></button></div><div class=tab-content-container><div data-tab-item="Substitute Environment Variables" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/manual/serverless_unset.yml <span class=p>|</span> envsubst &gt; ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=cd634d83f041600c07fb450adaea24d5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Check file contents" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("cd634d83f041600c07fb450adaea24d5","Check file contents")'><div><div class=tab-nav-hidden>Check file contents</div><div class=tab-nav-text>Check file contents</div></div></button>
<button data-tab-item="Expected Content" class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("cd634d83f041600c07fb450adaea24d5","Expected Content")'><div><div class=tab-nav-hidden>Expected Content</div><div class=tab-nav-text>Expected Content</div></div></button></div><div class=tab-content-container><div data-tab-item="Check file contents" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div></div><div data-tab-item="Expected Content" class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># USER SET VALUES =====================              </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>custom</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessToken</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Access Token&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>realm</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Realm&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Hostname&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#====================================== </span><span class=w>
</span></span></span></code></pre></div></div></div></div></div><h2 id=set-your-aws-credentials>Set your AWS Credentials</h2><p>You will be provided with AWS Access Key ID and AWS Secret Access Key values - substitue these values in place of AWS_ACCESS_KEY_ID and AWS_ACCESS_KEY_SECRET in the bellow command:</p><div class=tab-panel data-tab-group=45983eb69ec3d1a24da02174c5b04a48><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Set AWS Credentials" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("45983eb69ec3d1a24da02174c5b04a48","Set AWS Credentials")'><div><div class=tab-nav-hidden>Set AWS Credentials</div><div class=tab-nav-text>Set AWS Credentials</div></div></button></div><div class=tab-content-container><div data-tab-item="Set AWS Credentials" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls config credentials --provider aws --key AWS_ACCCESS_KEY_ID --secret AWS_ACCESS_KEY_SECRET
</span></span></code></pre></div></div></div></div></div><p>This command will create a file <code>~/.aws/credentials</code> with your AWS Credentials populated.</p><p>Note that we are using sls here, which is a Serverless framework for developing and deploying AWS Lambda functions. We will be using this command throughout the lab.</p><p>Now you are set up and ready go!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=auto-instrumentation>Auto-Instrumentation</h1><h2 id=auto-instrumentation>Auto-Instrumentation</h2><p>Navigate to the auto directory that contains auto-instrumentation code.</p><div class=tab-panel data-tab-group=f7183096b3a5b7e8a9b6f6185904f8e1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("f7183096b3a5b7e8a9b6f6185904f8e1","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>cd ~/o11y-lambda-lab/auto
</code></pre></div></div></div></div><p>Inspect the contents of the files in this directory. Take a look at the serverless.yml template.</p><div class=tab-panel data-tab-group=181c4c770dbe6df48171ef98bbb79556><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("181c4c770dbe6df48171ef98bbb79556","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>cat serverless.yml
</code></pre></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><ul><li>Can you identify which AWS entities are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?</li><li>Can you determine which instrumentation information is being provided by the Environment Variables?</li></ul></div></div><p>You should see the Splunk OpenTelemetry Lambda layer being added to each fuction.</p><pre tabindex=0><code>layers:
      - arn:aws:lambda:us-east-1:254067382080:layer:splunk-apm:70
</code></pre><p>You can see the relevant layer ARNs (Amazon Resource Name) and latest versions for each AWS region here: <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md target=_blank>https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md</a></p><p>You should also see a section where the Environment variables that are being set.</p><pre tabindex=0><code>environment:
  AWS_LAMBDA_EXEC_WRAPPER: /opt/nodejs-otel-handler
  OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${self:custom.prefix}-apm-lambda
  OTEL_SERVICE_NAME: consumer-lambda
  SPLUNK_ACCESS_TOKEN: ${self:custom.accessToken}
  SPLUNK_REALM: ${self:custom.realm}
</code></pre><p>Using the environment variables we are configuring and enriching our auto-instrumentation.</p><p>Here we provide minimum information, such as NodeJS wrapper location in the Splunk APM Layer, environment name, service name, and our Splunk Org credentials. We are sending trace data directly to Splunk Observability Cloud. You could alternatively export traces to an OpenTelemetry Collector set up in Gateway mode.</p><p>Take a look at the function code.</p><div class=tab-panel data-tab-group=17da4126c9eee7202180a40895d62c74><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("17da4126c9eee7202180a40895d62c74","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>cat handler.js
</code></pre></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><ul><li>Can you identify the code for producer function?</li><li>Can you identify the code for consumer function?</li></ul></div></div><p>Notice there is no mention of Splunk or OpenTelemetry in the code. We are adding the instrumentation using the Lambda layer and Environment Variables only.</p><h2 id=deploy-your-lambdas>Deploy your Lambdas</h2><p>Run the following command to deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=d0675423c140fa2a20789bd4fd2d2d2b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Deploy Command" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("d0675423c140fa2a20789bd4fd2d2d2b","Deploy Command")'><div><div class=tab-nav-hidden>Deploy Command</div><div class=tab-nav-text>Deploy Command</div></div></button>
<button data-tab-item="Expected Output" class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("d0675423c140fa2a20789bd4fd2d2d2b","Expected Output")'><div><div class=tab-nav-hidden>Expected Output</div><div class=tab-nav-text>Expected Output</div></div></button></div><div class=tab-content-container><div data-tab-item="Deploy Command" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>sls deploy
</code></pre></div></div><div data-tab-item="Expected Output" class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><pre tabindex=0><code>Deploying hostname-lambda-lab to stage dev (us-east-1)
...
...
endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
functions:
  producer: hostname-lambda-lab-dev-producer (1.6 kB)
  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)
</code></pre></div></div></div></div><p>This command will follow the instructions in your serverless.yml template to create your Lambda functions and your Kinesis stream. Note it may take a 1-2 minutes to execute.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>serverless.yml is in fact a CloudFormation template. CloudFormation is an infrastructure as code service from AWS. You can read more about it here - <a href=https://aws.amazon.com/cloudformation/ target=_blank>https://aws.amazon.com/cloudformation/</a></div></div><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=3c50344a1c3f8d5e8fa7bd613e121854><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("3c50344a1c3f8d5e8fa7bd613e121854","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>sls info
</code></pre></div></div></div></div><p>Take note of your endpoint value:
<a href=#image-33f9376e48d4430dfdaf7a4e865b0f9b class=lightbox-link><img src=../../../en/other/lambda-kinesis/2-auto-instrumentation/../images/2-auto-1-endpoint-value.png alt=2-auto-1-endpoint-value style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-33f9376e48d4430dfdaf7a4e865b0f9b><img src=../../../en/other/lambda-kinesis/2-auto-instrumentation/../images/2-auto-1-endpoint-value.png alt=2-auto-1-endpoint-value class=lightbox-image loading=lazy></a></p><h2 id=send-some-traffic>Send some Traffic</h2><p>Use the curl command to send a payload to your producer function. Note the command option -d is followed by your message payload.</p><p>Try changing the value of name to your name and telling the Lambda function about your superpower. Replace YOUR_ENDPOINT with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=80c5a36329a3a2b4a348c4680955b075><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("80c5a36329a3a2b4a348c4680955b075","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>curl -d &#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39; YOUR_ENDPOINT
</code></pre></div></div></div></div><p>For example:</p><pre tabindex=0><code>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</code></pre><p>You should see the following output if your message is successful:</p><pre tabindex=0><code>{&#34;message&#34;:&#34;Message placed in the Event Stream: hostname-eventSteam&#34;}
</code></pre><p>If unsuccessful, you will see:</p><pre tabindex=0><code>{&#34;message&#34;: &#34;Internal server error&#34;}
</code></pre><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: re-send that messate 5+ times. You should keep seeing a success message after each send.</p><p>Check the lambda logs output:</p><p>Producer function logs:</p><div class=tab-panel data-tab-group=5c9c122c9a787caaee20740a9d397047><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Producer Function Logs" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("5c9c122c9a787caaee20740a9d397047","Producer Function Logs")'><div><div class=tab-nav-hidden>Producer Function Logs</div><div class=tab-nav-text>Producer Function Logs</div></div></button></div><div class=tab-content-container><div data-tab-item="Producer Function Logs" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>sls logs -f producer
</code></pre></div></div></div></div><p>Consumer function logs:</p><div class=tab-panel data-tab-group=6c72ad51e37383568227aa8845973823><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Consumer Function Logs" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("6c72ad51e37383568227aa8845973823","Consumer Function Logs")'><div><div class=tab-nav-hidden>Consumer Function Logs</div><div class=tab-nav-text>Consumer Function Logs</div></div></button></div><div class=tab-content-container><div data-tab-item="Consumer Function Logs" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><pre tabindex=0><code>sls logs -f consumer
</code></pre></div></div></div></div><p>Examine the logs carefully.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Do you see OpenTelemetry being loaded? Look out for lines with splunk-extension-wrapper.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=lambdas-in-splunk-apm>Lambdas in Splunk APM</h1><h2 id=lambdas-in-splunk-apm>Lambdas in Splunk APM</h2><p>Now it&rsquo;s time to check how your Lambda traffic has been captured in Splunk APM.</p><h2 id=navigate-to-your-splunk-observability-cloud>Navigate to your Splunk Observability Cloud</h2><p>Select APM from the Main Menu and then select your APM Environment. Your APM environment should be in the format <code>$(hostname)-apm-lambda</code> where the hostname value is a four letter name of your lab host. (Check it by looking at your command prompt, or by running <code>echo $(hostname)</code>).</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>It may take a few minutes for you traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environement name in the list of Envrionments</div></div><p><a href=#image-fc63d107c168b1a3ef33d8f0cc6124e0 class=lightbox-link><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-1-filter.png alt=3-splunk-1-filter style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-fc63d107c168b1a3ef33d8f0cc6124e0><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-1-filter.png alt=3-splunk-1-filter class=lightbox-image loading=lazy></a></p><p>Go to <code>Explore</code> the Service Map to see the Dependencies between your Lambda Functions.</p><p><a href=#image-5a006a9ee230b256910ce45c94018707 class=lightbox-link><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-2-explore.png alt=3-splunk-2-explore style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5a006a9ee230b256910ce45c94018707><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-2-explore.png alt=3-splunk-2-explore class=lightbox-image loading=lazy></a></p><p>You should be able to see the <code>producer-lambda</code> and the call it is making to <code>Kinesis</code> service.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What about your <code>consumer-lambda</code>?</p></div></div><p><a href=#image-d35a9bf2c722816745eb7170836e3f21 class=lightbox-link><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-3-map-producer.png alt=3-splunk-3-map-producer style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d35a9bf2c722816745eb7170836e3f21><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-3-map-producer.png alt=3-splunk-3-map-producer class=lightbox-image loading=lazy></a></p><p>Click into <code>Traces</code> and examine some traces that container procuder function calls and traces with consumer function calls.</p><p><a href=#image-d3d3198e134394c76b1433025c4b0745 class=lightbox-link><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-4-trace-producer.png alt=3-splunk-4-trace-producer.png style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d3d3198e134394c76b1433025c4b0745><img src=../../../en/other/lambda-kinesis/3-lambdas-in-splunk/../images/3-splunk-4-trace-producer.png alt=3-splunk-4-trace-producer.png class=lightbox-image loading=lazy></a></p><p>We can see the <code>producer-lambda</code> putting a Record on the Kinesis stream. But the action of <code>consumer-function</code> is disconnected!</p><p>This is because the Trace Context is not being propagated.</p><p>This is not something that is supported automatically Out-of-the-Box by Kinesis service at the time of this lab. Our Distributed Trace stops at Kinesis inferred service, and we can&rsquo;t see the propagation any further.</p><p>Not yet&mldr;</p><p>Let&rsquo;s see how we work around this in the next section of this lab.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=manual-instrumentation>Manual Instrumentation</h1><h2 id=manual-instrumentation>Manual Instrumentation</h2><p>Navigate to the manual directory that contains manually instrumentated code.</p><div class=tab-panel data-tab-group=f3ce69e56ca8f4fadc64554fbffac0f8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("f3ce69e56ca8f4fadc64554fbffac0f8","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-lab/manual
</span></span></code></pre></div></div></div></div></div><p>Inspect the contents of the files in this directory. Take a look at the serverless.yml template.</p><div class=tab-panel data-tab-group=e4509a4e31af81865e8373233db7a2be><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("e4509a4e31af81865e8373233db7a2be","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat serverless.yml
</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Do you see any difference from the same file in your auto directory?</p></div></div><p>You can try to compare them with a diff command:</p><div class=tab-panel data-tab-group=22878dc95a37633eaa5f4935c79107e1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Diff Command" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("22878dc95a37633eaa5f4935c79107e1","Diff Command")'><div><div class=tab-nav-hidden>Diff Command</div><div class=tab-nav-text>Diff Command</div></div></button>
<button data-tab-item="Expected Output" class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("22878dc95a37633eaa5f4935c79107e1","Expected Output")'><div><div class=tab-nav-hidden>Expected Output</div><div class=tab-nav-text>Expected Output</div></div></button></div><div class=tab-content-container><div data-tab-item="Diff Command" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-lab/auto/serverless.yml ~/o11y-lambda-lab/manual/serverless.yml 
</span></span></code></pre></div></div></div><div data-tab-item="Expected Output" class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>19c19
</span></span><span class=line><span class=cl>&lt; #======================================    
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>&gt; #======================================   
</span></span></code></pre></div></div></div></div></div><p>There is no difference! (Well, there shouldn&rsquo;t be. Ask your lab facilitator to assist you if there is)</p><p>Now compare handler.js it with the same file in auto directory using the diff command:</p><div class=tab-panel data-tab-group=d55db878303cf5e971af022398fc1c54><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Diff Command" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("d55db878303cf5e971af022398fc1c54","Diff Command")'><div><div class=tab-nav-hidden>Diff Command</div><div class=tab-nav-text>Diff Command</div></div></button></div><div class=tab-content-container><div data-tab-item="Diff Command" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-lab/auto/handler.js ~/o11y-lambda-lab/manual/handler.js 
</span></span></code></pre></div></div></div></div></div><p>Look at all these differences!</p><p>You may wish to view the entire file with <code>cat handler.js</code> command and examine its content.</p><p>Notice how we are now importing some OpenTelemetry libraries directly into our function to handle some of the manual instrumenation tasks we require.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>otelapi</span>  <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;@opentelemetry/api&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>otelcore</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;@opentelemetry/core&#39;</span><span class=p>);</span>
</span></span></code></pre></div><p>We are using <a href=https://www.npmjs.com/package/@opentelemetry/api target=_blank>https://www.npmjs.com/package/@opentelemetry/api</a> to manipulate the tracing logic in our functions. We are using <a href=https://www.npmjs.com/package/@opentelemetry/core target=_blank>https://www.npmjs.com/package/@opentelemetry/core</a> to access the Propagator objects that we will use to manually propagate our context with.</p><h2 id=inject-trace-context-in-producer-function>Inject Trace Context in Producer Function</h2><p>The below code executes the following steps inside the Producer function:</p><ol><li>Get the current Active Span.</li><li>Create a Propagator.</li><li>Initialize a context carrier object.</li><li>Inject the context of the active span into the carrier object.</li><li>Modify the record we are about to put on our Kinesis stream to include the carrier that will carry the active span&rsquo;s context to the consumer.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>activeSpan</span> <span class=o>=</span> <span class=nx>otelapi</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nx>getSpan</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>active</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>propagator</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>otelcore</span><span class=p>.</span><span class=nx>W3CTraceContextPropagator</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=nx>propagator</span><span class=p>.</span><span class=nx>inject</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nx>setSpanContext</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>activeSpan</span><span class=p>.</span><span class=nx>spanContext</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>    <span class=nx>carrier</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>otelapi</span><span class=p>.</span><span class=nx>defaultTextMapSetter</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=s2>&#34;{\&#34;tracecontext\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>carrier</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;, \&#34;record\&#34;:&#34;</span> <span class=o>+</span> <span class=nx>event</span><span class=p>.</span><span class=nx>body</span> <span class=o>+</span> <span class=s2>&#34;}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Record with Trace Context added: 
</span></span></span><span class=line><span class=cl><span class=sb>  </span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span></code></pre></div><h2 id=extract-trace-context-in-consumer-function>Extract Trace Context in Consumer Function</h2><p>The bellow code executes the following steps inside the Consumer function:</p><ol><li>Extract the context that we obtained from the Producer into a carrier object.</li><li>Create a Propagator.</li><li>Extract the context from the carrier object in Customer function&rsquo;s parent span context.</li><li>Start a new span with the parent span context.</li><li>Bonus: Add extra attributes to your span, including custom ones with the values from your message!</li><li>Once completed, end the span.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>tracecontext</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>propagator</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>otelcore</span><span class=p>.</span><span class=nx>W3CTraceContextPropagator</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parentContext</span> <span class=o>=</span> <span class=nx>propagator</span><span class=p>.</span><span class=nx>extract</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>carrier</span><span class=p>,</span> <span class=nx>otelapi</span><span class=p>.</span><span class=nx>defaultTextMapGetter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>otelapi</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OTEL_SERVICE_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startSpan</span><span class=p>(</span><span class=s2>&#34;Kinesis.getRecord&#34;</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>parentContext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                         
</span></span><span class=line><span class=cl><span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;span.kind&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.name&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.superpower&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>---</span> <span class=kd>function</span> <span class=nx>does</span> <span class=nx>some</span> <span class=nx>work</span>
</span></span><span class=line><span class=cl> <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span></code></pre></div><p>Now let&rsquo;s see the difference this makes.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=redeploy-lambdas>Redeploy Lambdas</h1><h2 id=re-deploy-your-lambdas>Re-deploy your Lambdas</h2><p>While remaining in your manual directory, run the following commandd to re-deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=d3360588e2582327a3e318289c0b033c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Deploy Producer Code" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("d3360588e2582327a3e318289c0b033c","Deploy Producer Code")'><div><div class=tab-nav-hidden>Deploy Producer Code</div><div class=tab-nav-text>Deploy Producer Code</div></div></button>
<button data-tab-item="Expected Output" class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("d3360588e2582327a3e318289c0b033c","Expected Output")'><div><div class=tab-nav-hidden>Expected Output</div><div class=tab-nav-text>Expected Output</div></div></button></div><div class=tab-content-container><div data-tab-item="Deploy Producer Code" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls deploy -f producer
</span></span></code></pre></div></div></div><div data-tab-item="Expected Output" class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Deploying function producer to stage dev (us-east-1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✔ Function code deployed (6s)
</span></span><span class=line><span class=cl>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=6efa574ee6a41c130dd3749c3bc2ba6f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Deploy Consumer Code" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("6efa574ee6a41c130dd3749c3bc2ba6f","Deploy Consumer Code")'><div><div class=tab-nav-hidden>Deploy Consumer Code</div><div class=tab-nav-text>Deploy Consumer Code</div></div></button>
<button data-tab-item="Expected Output" class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("6efa574ee6a41c130dd3749c3bc2ba6f","Expected Output")'><div><div class=tab-nav-hidden>Expected Output</div><div class=tab-nav-text>Expected Output</div></div></button></div><div class=tab-content-container><div data-tab-item="Deploy Consumer Code" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls deploy -f consumer
</span></span></code></pre></div></div></div><div data-tab-item="Expected Output" class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Deploying function consumer to stage dev (us-east-1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✔ Function code deployed (6s)
</span></span><span class=line><span class=cl>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div></div><p>Note that this deployment now only updates the code changes within the function. Our configuration remains the same.</p><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=4cf65f08297464c9c8326d2ef985d774><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("4cf65f08297464c9c8326d2ef985d774","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls info
</span></span></code></pre></div></div></div></div></div><p>You endpoint value should remain the same:</p><p><a href=#image-8bc08a24c394108de36d69e0ab93c3ee class=lightbox-link><img src=../../../en/other/lambda-kinesis/5-redeploy-lambdas/../images/5-redeploy-1-endpoint-value.png alt=5-redeploy-1-endpoint-value style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8bc08a24c394108de36d69e0ab93c3ee><img src=../../../en/other/lambda-kinesis/5-redeploy-lambdas/../images/5-redeploy-1-endpoint-value.png alt=5-redeploy-1-endpoint-value class=lightbox-image loading=lazy></a></p><h2 id=send-some-traffic-again>Send some Traffic again</h2><p>Use the <code>curl</code> command to send a payload to your producer function. Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of name to your name and telling the Lambda function about your superpower. Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=95c882ca4a0ecdc4cc19a95e92cb6d61><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=Command class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("95c882ca4a0ecdc4cc19a95e92cb6d61","Command")'><div><div class=tab-nav-hidden>Command</div><div class=tab-nav-text>Command</div></div></button></div><div class=tab-content-container><div data-tab-item=Command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -d <span class=s1>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div></div></div></div></div><p>For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -d <span class=s1>&#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39;</span> https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span><span class=s2>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Internal server error&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: re-send that messate 5+ times. You should keep seeing a success message after each send.</p><p>Check the lambda logs output:</p><div class=tab-panel data-tab-group=7e3ef19504b36549d4a576f62f467ec0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Producer Function Logs" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("7e3ef19504b36549d4a576f62f467ec0","Producer Function Logs")'><div><div class=tab-nav-hidden>Producer Function Logs</div><div class=tab-nav-text>Producer Function Logs</div></div></button></div><div class=tab-content-container><div data-tab-item="Producer Function Logs" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f producer
</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=40ab763901609fd8b51d8bb86e84b685><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Consumer Function Logs" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("40ab763901609fd8b51d8bb86e84b685","Consumer Function Logs")'><div><div class=tab-nav-hidden>Consumer Function Logs</div><div class=tab-nav-text>Consumer Function Logs</div></div></button></div><div class=tab-content-container><div data-tab-item="Consumer Function Logs" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f consumer
</span></span></code></pre></div></div></div></div></div><p>Examine the logs carefully.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Do you notice the difference?</p></div></div><p>Note that we are logging our Record together with the Trace context that we have added to it. Copy one of the underlined sub-sections of your trace parent context, and save it for later.</p><p><a href=#image-d7191ddc01396cdaa753b88765689914 class=lightbox-link><img src=../../../en/other/lambda-kinesis/5-redeploy-lambdas/../images/5-redeploy-2-logs.png alt=5-redeploy-2-logs style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d7191ddc01396cdaa753b88765689914><img src=../../../en/other/lambda-kinesis/5-redeploy-lambdas/../images/5-redeploy-2-logs.png alt=5-redeploy-2-logs class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=updated-lambdas-in-splunk-apm>Updated Lambdas in Splunk APM</h1><p>Navigate back to APM in <a href=https://app.us1.signalfx.com/#/apm target=_blank>Splunk Observabilty Cloud</a></p><p>Go back to your Service Dependency map.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Notice the difference?</p></div></div><p><a href=#image-ce43b2fd3c39f2f54343746f90c189a7 class=lightbox-link><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-1-map.png alt=6-updated-1-map style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ce43b2fd3c39f2f54343746f90c189a7><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-1-map.png alt=6-updated-1-map class=lightbox-image loading=lazy></a></p><p>You should be able to see the <code>consumer-lambda</code> now clearly connected to the <code>producer-lambda</code>.</p><p>Remember the value you copied from your producer logs? You can run <code>sls logs -f consumer</code> command again on your EC2 lab host to fetch one.</p><p>Take that value, and paste it into trace search:</p><p><a href=#image-1491c9e10ebee75ff9c9d9ddb88b0a62 class=lightbox-link><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-2-trace-search.png alt=6-updated-2-trace-search style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1491c9e10ebee75ff9c9d9ddb88b0a62><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-2-trace-search.png alt=6-updated-2-trace-search class=lightbox-image loading=lazy></a></p><p>Click on Go and you should be able to find the logged Trace:</p><p><a href=#image-0f8a6df57bb001138ac03031e9aff9e1 class=lightbox-link><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-3-trace.png alt=6-updated-3-trace style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0f8a6df57bb001138ac03031e9aff9e1><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-3-trace.png alt=6-updated-3-trace class=lightbox-image loading=lazy></a></p><p>Notice that the <code>Trace ID</code> is something that makes up the trace context that we propagated.</p><p>You can read up on the two common propagation standards:</p><ol><li>W3C: <a href=https://www.w3.org/TR/trace-context/#traceparent-header target=_blank>https://www.w3.org/TR/trace-context/#traceparent-header</a></li><li>B3: <a href=https://github.com/openzipkin/b3-propagation#overall-process target=_blank>https://github.com/openzipkin/b3-propagation#overall-process</a></li></ol><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Which one are we using?</p></div></div><p>It should be self-explanatory from the Propagator we are creating in the Functions</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Bonus Question: What happens if we mix and match the W3C and B3 headers?</p></div></div><p>Expand the <code>consumer-lambda</code> span.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Can you find the attributes from your message?</p></div></div><p><a href=#image-3fd83663308651b71c3601b5ea211ba4 class=lightbox-link><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-4-attributes.png alt=6-updated-4-attributes style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-3fd83663308651b71c3601b5ea211ba4><img src=../../../en/other/lambda-kinesis/6-updated-in-splunk/../images/6-updated-4-attributes.png alt=6-updated-4-attributes class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><h2 id=before-you-go>Before you Go</h2><p>Please kindly clean up your lab using the following command:</p><div class=tab-panel data-tab-group=cc9aaabe51b7ddf3b9cd9feb80f21689><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item="Remove Functions" class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("cc9aaabe51b7ddf3b9cd9feb80f21689","Remove Functions")'><div><div class=tab-nav-hidden>Remove Functions</div><div class=tab-nav-text>Remove Functions</div></div></button></div><div class=tab-content-container><div data-tab-item="Remove Functions" class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls remove
</span></span></code></pre></div></div></div></div></div><h2 id=conclusion>Conclusion</h2><p>Congratuations on finishing the lab. You have seen how we complement auto-instrumentation with manual steps to force <code>Producer</code> function&rsquo;s context to be sent to <code>Consumer</code> function via a Record put on a Kinesis stream. This allowed us to build the expected Distributed Trace.</p><p><a href=#image-c385b43fe7636a4f77b23faf18343be9 class=lightbox-link><img src=../../../en/other/lambda-kinesis/7-summary/../images/7-conclusion-1-architecture.png alt=7-conclusion-1-architecture style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-c385b43fe7636a4f77b23faf18343be9><img src=../../../en/other/lambda-kinesis/7-summary/../images/7-conclusion-1-architecture.png alt=7-conclusion-1-architecture class=lightbox-image loading=lazy></a></p><p>You can now build out a Trace manually by linking two different functions together. This is very powerful when your auto-instrumenation, or third-party systems, do not support context propagation out of the box.</p><footer class=footline></footer></article></section></div></main></div><script src=../../../js/clipboard.min.js?1686840504 defer></script>
<script src=../../../js/perfect-scrollbar.min.js?1686840504 defer></script>
<script src=../../../js/theme.js?1686840504 defer></script></body></html>