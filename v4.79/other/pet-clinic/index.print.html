<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.12.2+tip"><meta name=description content="A workshop using Zero Configuration Auto-Instrumentation for Java"><title>PetClinic Java Workshop :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.79/other/pet-clinic/index.html rel=alternate hreflang=x-default><link href=https://splunk.github.io/observability-workshop/v4.79/other/pet-clinic/index.html rel=alternate hreflang=en><link href=https://splunk.github.io/observability-workshop/v4.79/ja/other/pet-clinic/index.html rel=alternate hreflang=ja><link href=https://splunk.github.io/observability-workshop/v4.79/other/pet-clinic/index.html rel=canonical type=text/html title="PetClinic Java Workshop :: Splunk Observability Cloud Workshops"><link href=../../other/pet-clinic/index.xml rel=alternate type=application/rss+xml title="PetClinic Java Workshop :: Splunk Observability Cloud Workshops"><link href=../../images/favicon.ico?1682429824 rel=icon type=image/x-icon><link href=../../css/fontawesome-all.min.css?1682429826 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/fontawesome-all.min.css?1682429826 rel=stylesheet></noscript><link href=../../css/nucleus.css?1682429826 rel=stylesheet><link href=../../css/auto-complete.css?1682429826 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/auto-complete.css?1682429826 rel=stylesheet></noscript><link href=../../css/perfect-scrollbar.min.css?1682429826 rel=stylesheet><link href=../../css/fonts.css?1682429826 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/fonts.css?1682429826 rel=stylesheet></noscript><link href=../../css/theme.css?1682429826 rel=stylesheet><link href=../../css/theme-splunk-light.css?1682429826 rel=stylesheet id=variant-style><link href=../../css/variant.css?1682429826 rel=stylesheet><link href=../../css/print.css?1682429826 rel=stylesheet media=print><link href=../../css/format-print.css?1682429826 rel=stylesheet><link href=../../css/ie.css?1682429826 rel=stylesheet><script src=../../js/url.js?1682429826></script>
<script src=../../js/variant.js?1682429826></script>
<script>window.index_js_url="../../index.search.js";var root_url="../../",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.79/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script><style>@media screen and (min-width:1300px){#body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1300px;width:100%}}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../other/pet-clinic/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../other/index.html><span itemprop=name>Other Workshops</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>PetClinic Java Workshop</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=petclinic-java-workshop>PetClinic Java Workshop</h1><p>The goal is to walk through the basic steps to configure the following components of the Splunk Observability platform:</p><ul><li>Splunk Infrastructure Monitoring (IM)</li><li>Splunk Zero Configuration Auto Instrumentation for Java (APM)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Real User Monitoring (RUM)</li><li>RUM spans to APM spans</li><li>Splunk LogsObserver (LO)</li></ul><p>We will also show the steps about how to clone (download) a sample Java application (Spring PetClinic), as well as how to compile, package and run the application.</p><p>Once the application is up and running, we will instantly start seeing metrics and traces via the Zero Configuration Auto Instrumentation for Java that will be used by the Splunk APM product.</p><p>After that, we will instrument the PetClinic&rsquo;s end user interface (HTML pages rendered by the application) with the Splunk OpenTelemetry Javascript Libraries (RUM) that will generate RUM traces around all the individual clicks and page loads executed by an end user.</p><p>Lastly, we will configure the Spring PetClinic application to write application logs to the filesystem and also configure the Splunk OpenTelemetry Collector to read (tail) the logs and report to Splunk Observability Cloud.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Prerequisites</div><div class=box-content><p>A Splunk run workshop where an host/instance is provided <strong>OR</strong> a self led workshop on own host / <a href=https://github.com/splunk/observability-workshop/tree/main/multipass target=_blank>multipass instance</a></p><p>For your own system you will need the following installed and enabled:</p><ol><li>JDK 17 installed</li><li>Maven</li><li>Port <code>8080</code> open inbound/outbound</li></ol></div></div><p><a href=#image-dc66db9c4fb82ea6c38f1ee684d8267f class=lightbox-link><img src=../../other/pet-clinic/images/petclinic-exercise.png alt="PetClinic Exercise" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-dc66db9c4fb82ea6c38f1ee684d8267f><img src=../../other/pet-clinic/images/petclinic-exercise.png alt="PetClinic Exercise" class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of PetClinic Java Workshop</h1><article class=default><h1 id=installing-the-opentelemetry-collector>Installing the OpenTelemetry Collector</h1><h2 id=1-introduction>1. Introduction</h2><p>The OpenTelemetry Collector is the core component of instrumenting infrastructure and applications. Its role is to collect and send:</p><ul><li>Infrastructure metrics (disk, cpu, memory, etc)</li><li>Application Performance Monitoring (APM) traces</li><li>Profiling data</li><li>Host and application logs</li></ul><p>Splunk Observability Cloud offers wizards to walk you through the setup of the Collector on both your infrastructure and applications. By default, the wizard will only provide the commands to only install the collector.</p><h2 id=2-configure-environment-variables>2. Configure environment variables</h2><p>If you have already completed the <strong>Splunk IM</strong> workshop you can take advantage of the existing environment variables. Otherwise, create the <code>ACCESS_TOKEN</code> and <code>REALM</code> environment variables to use in the proceeding OpenTelemetry Collector install command.</p><p>For instance, if your realm is <code>us1</code>, you would type <code>export REALM=us1</code> and for <code>eu0</code> type <code>export REALM=eu0</code> etc.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Export ACCESS TOKEN" class="tab-nav-button active" onclick='switchTab("default","Export ACCESS TOKEN")'>
<span>Export ACCESS TOKEN</span></button></div><div class=tab-content><div data-tab-item="Export ACCESS TOKEN" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ACCESS_TOKEN</span><span class=o>=</span><span class=s2>&#34;&lt;replace_with_O11y-Workshop-ACCESS_TOKEN&gt;&#34;</span>
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Export REALM" class="tab-nav-button active" onclick='switchTab("default","Export REALM")'>
<span>Export REALM</span></button></div><div class=tab-content><div data-tab-item="Export REALM" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>REALM</span><span class=o>=</span><span class=s2>&#34;&lt;replace_with_REALM&gt;&#34;</span>
</span></span></code></pre></div></div></div></div><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Delete any existing OpenTelemetry Collectors</div><div class=box-content><p>If you have completed the Splunk IM workshop, please ensure you have deleted the collector running in Kubernetes before continuing. This can be done by running the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector
</span></span></code></pre></div></div></div><h2 id=3-install-the-opentelemetry-collector>3. Install the OpenTelemetry Collector</h2><p>We can then go ahead and install the Collector. There are two additional parameters passed to the install script, they are <code>--with-instrumentation</code> and <code>--deployment-environment</code>. The <code>--with-instrumentation</code> option the installer will install the agent from the Splunk distribution of OpenTelemetry Java, which is then loaded automatically when the PetClinic Java application starts up. No configuration required!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo sh /tmp/splunk-otel-collector.sh --with-instrumentation --deployment-environment <span class=k>$(</span>hostname<span class=k>)</span>-petclinic --realm <span class=nv>$REALM</span> -- <span class=nv>$ACCESS_TOKEN</span>
</span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> AWS/EC2 instances</div><div class=box-content><p>If you are attempting this workshop on an AWS/EC2 instance you will have to patch the collector to expose the hostname of the instance:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sed -i <span class=s1>&#39;s/gcp, ecs, ec2, azure, system/system, gcp, ecs, ec2, azure/g&#39;</span> /etc/otel/collector/agent_config.yaml
</span></span></code></pre></div><p>Once the <code>agent_config.yaml</code> has been patched, you will need to restart the collector:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector
</span></span></code></pre></div></div></div><p>Once the install is completed, you can navigate to the <strong>Hosts with agent installed</strong> dashboard to see the data from your host, <strong>Dashboards → Hosts with agent installed</strong>.</p><p>Use the dashboard filter and select <code>host.name</code> and type or select the hostname of your virtual machine. Once you see data flowing for your host, we are then ready to get started with the APM component.</p><footer class=footline></footer></article><article class=default><h1 id=zero-configuration-auto-instrumentation-for-java>Zero Configuration Auto Instrumentation for Java</h1><h2 id=1-spring-petclinic-application>1. Spring PetClinic Application</h2><p>First thing we need to setup APM is&mldr; well, an application. For this exercise, we will use the Spring PetClinic application. This is a very popular sample java application built with Spring framework (Springboot).</p><p>Next we will clone the PetClinic repository, then we will compile, build, package and test the application.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/spring-projects/spring-petclinic
</span></span></code></pre></div><p>Change into the <code>spring-petclinic</code> directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> spring-petclinic <span class=o>&amp;&amp;</span> git checkout 276880e
</span></span></code></pre></div><p>Start a MySQL database for PetClinic to use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -e <span class=nv>MYSQL_USER</span><span class=o>=</span>petclinic -e <span class=nv>MYSQL_PASSWORD</span><span class=o>=</span>petclinic -e <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span>root -e <span class=nv>MYSQL_DATABASE</span><span class=o>=</span>petclinic -p 3306:3306 docker.io/mysql:5.7.8
</span></span></code></pre></div><p>Next, run the <code>maven</code> command to compile/build/package PetClinic:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Note</div><div class=box-content><p>This will take a few minutes the first time you run, <code>maven</code> will download a lot of dependencies before it actually compiles the application. Future executions will be a lot shorter.</p></div></div><p>Once the compilation is complete, you can run the application with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql
</span></span></code></pre></div><p>If you check the logs of the Splunk OpenTelemetry collector you will see that the collector automatically detected the application running and auto-instrumented it. You can view the logs using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo tail -f /var/log/syslog
</span></span></code></pre></div><p>You can validate if the application is running by visiting <code>http://&lt;VM_IP_ADDRESS>:8080</code>.</p><p>Once your validation is complete you can stop the application by pressing <code>Ctrl-c</code>.</p><h2 id=2-generating-traffic>2. Generating Traffic</h2><p>Next we will start a Docker container running Locust that will generate some simple traffic to the PetClinic application. Locust is a simple load testing tool that can be used to generate traffic to a web application.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --network<span class=o>=</span><span class=s2>&#34;host&#34;</span> -d -p 8089:8089 -v /home/ubuntu/workshop/petclinic:/mnt/locust docker.io/locustio/locust -f /mnt/locust/locustfile.py --headless -u <span class=m>10</span> -r <span class=m>3</span> -H http://127.0.0.1:8080
</span></span></code></pre></div><h2 id=3-enabling-alwayson-profiling-and-metrics>3. Enabling AlwaysOn Profiling and Metrics</h2><p>To enable CPU and Memory Profiling on the application we can start the application by passing <code>splunk.profiler.enabled=true</code> and for metrics pass <code>splunk.metrics.enabled=true</code>. Make sure the application is stopped and run the following command to enable metrics and profiling.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.profiler.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.metrics.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql
</span></span></code></pre></div><p>You can now visit the Splunk APM UI and examine the application components, traces, profiling, DB Query performance and metrics <strong>Hamburger Menu → APM → Explore</strong>.</p><p>Once your validation is complete you can stop the application by pressing <code>Ctrl-c</code>.</p><h2 id=4-adding-resource-attributes-to-spans>4. Adding Resource Attributes to Spans</h2><p>Resource attributes can be added to every reported span. For example <code>version=0.314</code>. A comma separated list of resource attributes can also be defined e.g. <code>key1=val1,key2=val2</code>.</p><p>Let&rsquo;s launch the PetClinic again using a new resource attribute. Note, that adding resource attributes to the run command will override what was defined when we installed the collector. So, we also need to specify our <code>deployment.environment</code> resource attribute along with our new resource attribute. Below you will see we are setting <code>deployment.environment=$(hostname)-petclinic</code> and <code>version=0.314</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.profiler.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.metrics.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql
</span></span></code></pre></div><p>Back in the Splunk APM UI we can drill down on a recent trace and see the new <code>version</code> attribute in a span.</p><footer class=footline></footer></article><article class=default><h1 id=3-real-user-monitoring>3. Real User Monitoring</h1><h2 id=1-enable-rum>1. Enable RUM</h2><p>For the Real User Monitoring (RUM) instrumentation, we will add the Open Telemetry Javascript <a href=https://github.com/signalfx/splunk-otel-js-web target=_blank>https://github.com/signalfx/splunk-otel-js-web</a> snippet in the pages, we will use the wizard again <strong>Data Management → Add Integration → RUM Instrumentation → Browser Instrumentation</strong>.</p><p>Select the preconfigured <strong>RUM ACCESS TOKEN</strong> from the dropdown, click <strong>Next</strong>. Enter <strong>App name</strong> and <strong>Environment</strong> using the following syntax:</p><ul><li><code>[hostname]-petclinic-service</code> - replacing <code>[hostname]</code> with your actual hostname.</li><li><code>[hostname]-petclinic-env</code> - replacing <code>[hostname]</code> with your actual hostname.</li></ul><p>Then you&rsquo;ll need to select the workshop RUM token and define the application and environment names. The wizard will then show a snipped of HTML code that needs to be place at the top at the pages in the <code>&lt;head></code> section. In this example we are using:</p><ul><li>Application Name: <code>&lt;hostname>-petclinic-service</code></li><li>Environment: <code>&lt;hostname>-petclinic-env</code></li></ul><p>Copy the generated code snippet in the wizard or copy and edit the snippet below accordingly. You need to replace <code>&lt;REALM></code>, <code>&lt;RUM_ACCESS_TOKEN></code> and <code>&lt;hostname></code> with the actual values.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>beaconUrl</span><span class=o>:</span> <span class=s2>&#34;https://rum-ingest.&lt;REALM&gt;.signalfx.com/v1/rum&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>rumAuth</span><span class=o>:</span> <span class=s2>&#34;&lt;RUM_ACCESS_TOKEN&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>app</span><span class=o>:</span> <span class=s2>&#34;&lt;hostname&gt;-petclinic-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>environment</span><span class=o>:</span> <span class=s2>&#34;&lt;hostname&gt;-petclinic-env&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>The Spring PetClinic application uses a single HTML page as the &ldquo;layout&rdquo; page, that is reused across all pages of the application. This is the perfect location to insert the Splunk RUM Instrumentation Library as it will be loaded in all pages automatically.</p><p>Let&rsquo;s then edit the layout page:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi src/main/resources/templates/fragments/layout.html
</span></span></code></pre></div><p>Next, insert the snippet we generated above in the <code>&lt;head></code> section of the page. Now we need to rebuild the application and run it again:</p><h2 id=2-rebuild-petclinic>2. Rebuild PetClinic</h2><p>Run the <code>maven</code> command to compile/build/package PetClinic:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.profiler.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.metrics.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql
</span></span></code></pre></div><p>Then let&rsquo;s visit the application using a browser to generate real-user traffic <code>http://&lt;VM_IP_ADDRESS>:8080</code>, now we should see RUM traces being reported.</p><p>Let&rsquo;s visit RUM and see some of the traces and metrics <strong>Hamburger Menu → RUM</strong> and you will see some of the Spring PetClinic URLs showing up in the UI.</p><p>When you drill down into a RUM trace you will see a link to APM in the spans. Clicking on the trace ID will take you to the corresponding APM trace for the current RUM trace.</p><footer class=footline></footer></article><article class=default><h1 id=4-log-observer>4. Log Observer</h1><h2 id=1-introduction>1. Introduction</h2><p>For the Splunk Log Observer component, we will configure the Spring PetClinic application to write logs to a file in the filesystem and configure the Splunk OpenTelemetry Collect to read (tail) that log file and report the information to the Splunk Observability Platform.</p><h2 id=2-fluentd-configuration>2. FluentD Configuration</h2><p>We need to configure the Splunk OpenTelemetry Collector to tail the Spring PetClinic log file and report the data to the Splunk Observability Cloud endpoint.</p><p>The Splunk OpenTelemetry Collector uses FluentD to consume/report logs and to configure the proper setting to report Spring PetClinic logs, we just need to add a FluentD configuration file in the default directory (<code>/etc/otel/collector/fluentd/conf.d/</code>).</p><p>So we need to create the a new FluentD configuration file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/otel/collector/fluentd/conf.d/petclinic.conf
</span></span></code></pre></div><p>Copy and paste in the following configuration, this will read the file <code>/tmp/spring-petclinic.log</code> that will be configured in the next section.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>&lt;source&gt;</span>
</span></span><span class=line><span class=cl>  <span class=na>@type tail</span>
</span></span><span class=line><span class=cl>  <span class=na>@label @SPLUNK</span>
</span></span><span class=line><span class=cl>  <span class=na>tag petclinic.app</span>
</span></span><span class=line><span class=cl>  <span class=na>path /tmp/spring-petclinic.log</span>
</span></span><span class=line><span class=cl>  <span class=na>pos_file /tmp/spring-petclinic.pos_file</span>
</span></span><span class=line><span class=cl>  <span class=na>read_from_head false</span>
</span></span><span class=line><span class=cl>  <span class=na>&lt;parse&gt;</span>
</span></span><span class=line><span class=cl>    <span class=na>@type none</span>
</span></span><span class=line><span class=cl>  <span class=na>&lt;/parse&gt;</span>
</span></span><span class=line><span class=cl><span class=na>&lt;/source&gt;</span>
</span></span></code></pre></div><p>We now need to change permission and ownership of the petclinic.conf file so the agent can read it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chown td-agent:td-agent /etc/otel/collector/fluentd/conf.d/petclinic.conf
</span></span><span class=line><span class=cl>sudo chmod <span class=m>755</span> /etc/otel/collector/fluentd/conf.d/petclinic.conf
</span></span></code></pre></div><p>Now that we have created the new configuration and changed the permissions we need to restart the FluentD process:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart td-agent
</span></span></code></pre></div><h2 id=3-logback-settings>3. Logback Settings</h2><p>The Spring PetClinic application can be configured to use a number of different java logging libraries. In this scenario, we are using logback. We just need to create a file named <code>logback.xml</code> in the configuration folder:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi src/main/resources/logback.xml
</span></span></code></pre></div><p>Copy and paste the following XML content:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE xml&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>scan=</span><span class=s>&#34;true&#34;</span> <span class=na>scanPeriod=</span><span class=s>&#34;30 seconds&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;contextListener</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.classic.jul.LevelChangePropagator&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;resetJUL&gt;</span>true<span class=nt>&lt;/resetJUL&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/contextListener&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;logger</span> <span class=na>name=</span><span class=s>&#34;org.springframework.samples.petclinic&#34;</span> <span class=na>level=</span><span class=s>&#34;debug&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;appender</span> <span class=na>name=</span><span class=s>&#34;file&#34;</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.core.rolling.RollingFileAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;file&gt;</span>/tmp/spring-petclinic.log<span class=nt>&lt;/file&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;rollingPolicy</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;fileNamePattern&gt;</span>springLogFile.%d{yyyy-MM-dd}.log<span class=nt>&lt;/fileNamePattern&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;maxHistory&gt;</span>5<span class=nt>&lt;/maxHistory&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;totalSizeCap&gt;</span>1GB<span class=nt>&lt;/totalSizeCap&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/rollingPolicy&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;encoder&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>        %d{yyyy-MM-dd HH:mm:ss} - %logger{36} - %msg trace_id=%X{trace_id} span_id=%X{span_id} trace_flags=%X{trace_flags} %n service.name=%property{otel.resource.service.name}, deployment.environment=%property{otel.resource.deployment.environment}: %m%n
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/encoder&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/appender&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;root</span> <span class=na>level=</span><span class=s>&#34;debug&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;file&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/root&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></div><p>Now we need to rebuild the application and run it again:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><p>And then run the application again:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.profiler.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dsplunk.metrics.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>-petclinic,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql
</span></span></code></pre></div><p>Then let&rsquo;s visit the application again to generate more traffic, now we should see log messages being reported <code>http://&lt;VM_IP_ADDRESS>:8080</code> (feel free to navigate and click around).</p><p>Then visit:
Hamburger Menu > Log Observer</p><p>And you can add a filter to select only log messages from your host and the Spring PetClinic Application:</p><ul><li>Add Filter → Fields → <code>host.name</code> → <code>&lt;your host name></code></li><li>Add Filter → Fields → <code>service.name</code> → <code>&lt;your host name>-petclinic.service</code></li></ul><h2 id=4-summary>4. Summary</h2><p>This the end of the exercise and we have certainly covered a lot of ground. At this point you should have metrics, traces (APM & RUM), logs, database query performance and code profiling being reported into Splunk Observability Cloud. <strong>Congratulations</strong>!</p><footer class=footline></footer></article></section></div></main></div><script src=../../js/clipboard.min.js?1682429826 defer></script>
<script src=../../js/perfect-scrollbar.min.js?1682429826 defer></script>
<script src=../../js/theme.js?1682429826 defer></script></body></html>