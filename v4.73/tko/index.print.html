<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.12.2+tip"><meta name=description content="TKO 2023 - Observability Workshops"><title>TKO Workshops :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.73/tko/index.html rel=canonical type=text/html title="TKO Workshops :: Splunk Observability Cloud Workshops"><link href=../tko/index.xml rel=alternate type=application/rss+xml title="TKO Workshops :: Splunk Observability Cloud Workshops"><link href=../images/favicon.ico?1680255134 rel=icon type=image/x-icon><link href=../css/fontawesome-all.min.css?1680255135 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css?1680255135 rel=stylesheet></noscript><link href=../css/nucleus.css?1680255135 rel=stylesheet><link href=../css/auto-complete.css?1680255135 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css?1680255135 rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css?1680255135 rel=stylesheet><link href=../css/fonts.css?1680255135 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css?1680255135 rel=stylesheet></noscript><link href=../css/theme.css?1680255135 rel=stylesheet><link href=../css/theme-splunk-light.css?1680255135 rel=stylesheet id=variant-style><link href=../css/variant.css?1680255135 rel=stylesheet><link href=../css/print.css?1680255135 rel=stylesheet media=print><link href=../css/format-print.css?1680255135 rel=stylesheet><link href=../css/ie.css?1680255135 rel=stylesheet><script src=../js/url.js?1680255135></script>
<script src=../js/variant.js?1680255135></script>
<script>window.index_js_url="../index.search.js";var root_url="../",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.73/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script><style>@media screen and (min-width:1300px){#body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1300px;width:100%}}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../tko/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>TKO Workshops</span><meta itemprop=position content="2"></li></ol></div></div></nav><main id=body-inner class="highlightable home" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=home><h1 id=tko-workshops>TKO Workshops</h1><div class="children children-h3 children-sort-"><h3><a href=../tko/session-2/index.html>Getting Data In (GDI) & OTEL</a></h3><p>45 minutes During this technical workshop you will learn how to:
efficiently deploy complex environments capture metrics from these environments to Splunk Observability Cloud auto-instrument a python application enabling OS logging to Splunk Enterprise via Universal Forwarder In order to simplify the workshop modules, a pre-configured AWS EC2 instance is provided.
By the end of this technical workshop you will have an approach to demonstrating metrics collection for complex environments and services.</p><h3><a href=../tko/session-5/index.html>5. How Platform Engineers Observe Kubernetes</a></h3><p>45 minutes This workshop will equip you with the basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector. During the workshop you will deploy PHP/Apache and a load generator.
You will learn about OpenTelemetry Receivers, Kubernetes Namespaces, ReplicaSets, Kubernetes Horizontal Pod AutoScaling and how to monitor all this using the Splunk Observability Cloud. The main learnings from the workshop will be a better understanding of the Kubernetes Navigator (and Dashboards) in Splunk Observability Cloud as well as seeing Kubernetes metrics, events and Detectors.</p><h3><a href=../tko/session-6/index.html>6. O11y - Distributed Tracing for modern applications</a></h3><p>45 minutes Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka !
Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p></div><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of TKO Workshops</h1><article class=default><h1 id=getting-data-in-gdi--otel>Getting Data In (GDI) & OTEL</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>During this technical workshop you will learn how to:</p><ul><li>efficiently deploy complex environments</li><li>capture metrics from these environments to Splunk Observability Cloud</li><li>auto-instrument a python application</li><li>enabling OS logging to Splunk Enterprise via Universal Forwarder</li></ul><p>In order to simplify the workshop modules, a pre-configured AWS EC2 instance is provided.</p><p>By the end of this technical workshop you will have an approach to demonstrating metrics collection for complex environments and services.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Getting Data In (GDI) & OTEL</h1><article class=default><h1 id=getting-started-with-o11y-gdi---real-time-enrichment-workshop>Getting Started with O11y GDI - Real Time Enrichment Workshop</h1><p>Please note to begin the following lab, you must have completed the prework:</p><ul><li>Obtain a Splunk Observability Cloud access key</li><li>Understand cli commands</li></ul><p>Follow these steps if using O11y Workshop EC2 instances</p><ol><li>Verify yelp data files are present</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ll /var/appdata/yelp*
</span></span></code></pre></div><ol start=2><li>Export the following variables.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ACCESS_TOKEN</span><span class=o>=</span>&lt;your-access-token&gt; 
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>REALM</span><span class=o>=</span>&lt;your-o11y-cloud-realm&gt; 
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>clusterName</span><span class=o>=</span>&lt;your-k8s-cluster&gt; 
</span></span></code></pre></div><ol start=3><li>Clone the following repo</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/ubuntu 
</span></span><span class=line><span class=cl>git clone https://github.com/leungsteve/realtime_enrichment.git 
</span></span><span class=line><span class=cl><span class=nb>cd</span> realtime_enrichment/workshop 
</span></span><span class=line><span class=cl>python3 -m venv rtapp-workshop 
</span></span><span class=line><span class=cl><span class=nb>source</span> rtapp-workshop/bin/activate
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=deploy-complex-environments-and-capture-meterics>Deploy complex environments and capture meterics</h1><p><strong>Objective:</strong> Learn how to efficiently deploy complex infrastructure components such as Kafka and MongoDB to demonstrate metrics collection with Splunk O11y IM integrations</p><p><strong>Duration</strong>: 15 Minutes</p><h2 id=scenario>Scenario</h2><p>A prospect uses Kafka and MongoDB in their environment. Since there are integrations for these services, you’d like to demonstrate this to the prospect. What is a quick and efficient way to set up a live environment with these services and have metrics collected?</p><h3 id=1-where-can-i-find-helm-charts>1. Where can I find helm charts?</h3><ul><li>Google “myservice helm chart”</li><li><code>https://artifacthub.io/</code> (<strong>Note:</strong> Look for charts from trusted organizations, with high star count and frequent updates)</li></ul><h3 id=2-review-apache-kafka-packaged-by-bitnamihttpsgithubcombitnamichartstreemainbitnamikafkainstalling-the-chart>2. Review <a href=https://github.com/bitnami/charts/tree/main/bitnami/kafka/#installing-the-chart target=_blank>Apache Kafka packaged by Bitnami</a></h3><p>We will deploy the helm chart with these options enabled:</p><ul><li><code>replicaCount=3</code></li><li><code>metrics.jmx.enabled=true</code></li><li><code>metrics.kafka.enabled=true</code></li><li><code>deleteTopicEnable=true</code></li></ul><h3 id=3-review-mongodbr-packaged-by-bitnamihttpsgithubcombitnamichartstreemasterbitnamimongodbinstalling-the-chart>3. Review <a href=https://github.com/bitnami/charts/tree/master/bitnami/mongodb/#installing-the-chart target=_blank>MongoDB(R) packaged by Bitnami</a></h3><p>We will deploy the helm chart with these options enabled:</p><ul><li><code>version 12.1.31</code></li><li><code>metrics.enabled=true</code></li><li><code>global.namespaceOverride=default</code></li><li><code>auth.rootUser=root</code></li><li><code>auth.rootPassword=splunk</code></li><li><code>auth.enabled=false</code></li></ul><h3 id=4-install-kafka-and-mongodb-with-helm-charts>4. Install Kafka and MongoDB with helm charts</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install kafka --set <span class=nv>replicaCount</span><span class=o>=</span><span class=m>3</span> --set metrics.jmx.enabled<span class=o>=</span><span class=nb>true</span> --set metrics.kafka.enabled<span class=o>=</span><span class=nb>true</span>  --set <span class=nv>deleteTopicEnable</span><span class=o>=</span><span class=nb>true</span> bitnami/kafka
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install mongodb --set metrics.enabled<span class=o>=</span><span class=nb>true</span> bitnami/mongodb --set global.namespaceOverride<span class=o>=</span>default --set auth.rootUser<span class=o>=</span>root --set auth.rootPassword<span class=o>=</span>splunk --set auth.enabled<span class=o>=</span><span class=nb>false</span> --version 12.1.31
</span></span></code></pre></div><p>Verify the helm chart installation</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="helm list" class="tab-nav-button active" onclick='switchTab("default","helm list")'>
<span>helm list</span></button>
<button data-tab-item="helm list output" class=tab-nav-button onclick='switchTab("default","helm list output")'>
<span>helm list output</span></button></div><div class=tab-content><div data-tab-item="helm list" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm list
</span></span></code></pre></div></div><div data-tab-item="helm list output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME    NAMESPACE   REVISION    UPDATED                                 STATUS      CHART           APP VERSION
</span></span><span class=line><span class=cl>kafka   default     1           2022-11-14 11:21:36.328956822 -0800 PST deployed    kafka-19.1.3    3.3.1
</span></span><span class=line><span class=cl>mongodb default     1           2022-11-14 11:19:36.507690487 -0800 PST deployed    mongodb-12.1.31 5.0.10
</span></span></code></pre></div></div></div></div><p>Verify the helm chart installation</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get pods" class="tab-nav-button active" onclick='switchTab("default","kubectl get pods")'>
<span>kubectl get pods</span></button>
<button data-tab-item="kubectl get pods Output" class=tab-nav-button onclick='switchTab("default","kubectl get pods Output")'>
<span>kubectl get pods Output</span></button></div><div class=tab-content><div data-tab-item="kubectl get pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods
</span></span></code></pre></div></div><div data-tab-item="kubectl get pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                              READY   STATUS              RESTARTS   AGE
</span></span><span class=line><span class=cl>kafka-exporter-595778d7b4-99ztt   0/1     ContainerCreating   0          17s
</span></span><span class=line><span class=cl>mongodb-b7c968dbd-jxvsj           0/2     Pending             0          6s
</span></span><span class=line><span class=cl>kafka-1                           0/2     ContainerCreating   0          16s
</span></span><span class=line><span class=cl>kafka-2                           0/2     ContainerCreating   0          16s
</span></span><span class=line><span class=cl>kafka-zookeeper-0                 0/1     Pending             0          17s
</span></span><span class=line><span class=cl>kafka-0                           0/2     Pending             0          17s
</span></span></code></pre></div></div></div></div><p>Use information for each Helm chart and Splunk O11y Data Setup to generate values.yaml for capturing metrics from Kafka and MongoDB.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p><code>values.yaml</code> for the different services will be passed to the Splunk Helm Chart at installation time. These will configure the OTEL collector to capture metrics from these services.</p></div></div><ul><li>References:<ul><li><a href=https://github.com/bitnami/charts/tree/master/bitnami/spark/#installing-the-chart target=_blank>Apache Kafka packaged by Bitnami</a></li><li><a href=https://docs.splunk.com/Observability/gdi/kafka/kafka.html target=_blank>Configure application receivers for databases » Apache Kafka</a></li><li><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/kafkametricsreceiver target=_blank>Kafkametricsreceiver</a></li></ul></li></ul><h4 id=41-example-kafkavaluesyaml>4.1 Example kafka.values.yaml</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>otelAgent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receiver_creator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>smartagent/kafka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>type == &#34;pod&#34; &amp;&amp; name matches &#34;kafka&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c>#endpoint: &#39;`endpoint`:5555&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5555</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>collectd/kafka</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=l>sl-kafka</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>otelK8sClusterReceiver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>k8sEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kafkametrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>brokers</span><span class=p>:</span><span class=w> </span><span class=l>kafka:9092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>protocol_version</span><span class=p>:</span><span class=w> </span><span class=m>2.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>brokers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>topics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>consumers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c>#- prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>k8s_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>kafkametrics</span><span class=w>
</span></span></span></code></pre></div><h4 id=42-example-mongodbvaluesyaml>4.2 Example mongodb.values.yaml</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>otelAgent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receiver_creator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>smartagent/mongodb</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>type == &#34;pod&#34; &amp;&amp; name matches &#34;mongo&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>collectd/mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>mongodb.default.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>27017</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>databases</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;admin&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;O11y&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;local&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>sendCollectionMetrics</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>sendCollectionTopMetrics</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><h4 id=43-example-zookeepervaluesyaml>4.3 Example zookeeper.values.yaml</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>otelAgent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receiver_creator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>smartagent/zookeeper</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>type == &#34;pod&#34; &amp;&amp; name matches &#34;kafka-zookeeper&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>collectd/zookeeper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>kafka-zookeeper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2181</span><span class=w>
</span></span></span></code></pre></div><h3 id=5-install-the-splunk-otel-helm-chart>5. Install the Splunk OTEL helm chart</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/ubuntu/realtime_enrichment/otel_yamls/ 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm repo update
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install --set <span class=nv>provider</span><span class=o>=</span><span class=s1>&#39; &#39;</span> --set <span class=nv>distro</span><span class=o>=</span><span class=s1>&#39; &#39;</span> --set splunkObservability.accessToken<span class=o>=</span><span class=nv>$ACCESS_TOKEN</span> --set <span class=nv>clusterName</span><span class=o>=</span><span class=nv>$clusterName</span> --set splunkObservability.realm<span class=o>=</span><span class=nv>$REALM</span> --set otelCollector.enabled<span class=o>=</span><span class=s1>&#39;false&#39;</span> --set splunkObservability.logsEnabled<span class=o>=</span><span class=s1>&#39;true&#39;</span> --set gateway.enabled<span class=o>=</span><span class=s1>&#39;false&#39;</span> --values kafka.values.yaml --values mongodb.values.yaml --values zookeeper.values.yaml --values alwayson.values.yaml --values k3slogs.yaml --generate-name splunk-otel-collector-chart/splunk-otel-collector
</span></span></code></pre></div><h3 id=6-verify-installation>6. Verify installation</h3><p>Verify that the Kafka, MongoDB and Splunk OTEL Collector helm charts are installed, note that names may differ.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="helm list" class="tab-nav-button active" onclick='switchTab("default","helm list")'>
<span>helm list</span></button>
<button data-tab-item="helm list Output" class=tab-nav-button onclick='switchTab("default","helm list Output")'>
<span>helm list Output</span></button></div><div class=tab-content><div data-tab-item="helm list" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm list
</span></span></code></pre></div></div><div data-tab-item="helm list Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                NAMESPACE   REVISION    UPDATED                                 STATUS      CHART                           APP VERSION
</span></span><span class=line><span class=cl>kafka                               default     1           2021-12-07 12:48:47.066421971 -0800 PST deployed    kafka-14.4.1                    2.8.1
</span></span><span class=line><span class=cl>mongodb                             default     1           2021-12-07 12:49:06.132771625 -0800 PST deployed    mongodb-10.29.2                 4.4.10
</span></span><span class=line><span class=cl>splunk-otel-collector-1638910184    default     1           2021-12-07 12:49:45.694013749 -0800 PST deployed    splunk-otel-collector-0.37.1    0.37.1
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get pods" class="tab-nav-button active" onclick='switchTab("default","kubectl get pods")'>
<span>kubectl get pods</span></button>
<button data-tab-item="kubectl get pods Output" class=tab-nav-button onclick='switchTab("default","kubectl get pods Output")'>
<span>kubectl get pods Output</span></button></div><div class=tab-content><div data-tab-item="kubectl get pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods
</span></span></code></pre></div></div><div data-tab-item="kubectl get pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                              READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>kafka-zookeeper-0                                                 1/1     Running   0          18m
</span></span><span class=line><span class=cl>kafka-2                                                           2/2     Running   1          18m
</span></span><span class=line><span class=cl>mongodb-79cf87987f-gsms8                                          2/2     Running   0          18m
</span></span><span class=line><span class=cl>kafka-1                                                           2/2     Running   1          18m
</span></span><span class=line><span class=cl>kafka-exporter-7c65fcd646-dvmtv                                   1/1     Running   3          18m
</span></span><span class=line><span class=cl>kafka-0                                                           2/2     Running   1          18m
</span></span><span class=line><span class=cl>splunk-otel-collector-1638910184-agent-27s5c                      2/2     Running   0          17m
</span></span><span class=line><span class=cl>splunk-otel-collector-1638910184-k8s-cluster-receiver-8587qmh9l   1/1     Running   0          17m
</span></span></code></pre></div></div></div></div><h3 id=7-verify-dashboards>7. Verify dashboards</h3><p>Verify that out of the box dashboards for Kafka, MongoDB and Zookeeper are populated in the Infrastructure Monitor landing page. Drill down into each component to view granular details for each service.</p><p>Tip: You can use the filter <code>k8s.cluster.name</code> with your cluster name to find your instance.</p><ul><li>Infrastructure Monitoring Landing page:</li></ul><p><a href=#image-8b7d90d898a8a656d38341bb4234e7ad class=lightbox-link><img src=../tko/session-2/deploy/../images/inframon.jpg alt=IM-landing-page style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8b7d90d898a8a656d38341bb4234e7ad><img src=../tko/session-2/deploy/../images/inframon.jpg alt=IM-landing-page class=lightbox-image loading=lazy></a></p><ul><li>K8 Navigator:</li></ul><p><a href=#image-5395af86a76bbdc47643e2ce589c2e37 class=lightbox-link><img src=../tko/session-2/deploy/../images/k8navigator.jpg alt=k8-navigator style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5395af86a76bbdc47643e2ce589c2e37><img src=../tko/session-2/deploy/../images/k8navigator.jpg alt=k8-navigator class=lightbox-image loading=lazy></a></p><ul><li>MongoDB Dashboard:</li></ul><p><a href=#image-052cd8d3cefc316e7b9bd91b8183052b class=lightbox-link><img src=../tko/session-2/deploy/../images/mongoDB.jpg alt=mongodb-dash style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-052cd8d3cefc316e7b9bd91b8183052b><img src=../tko/session-2/deploy/../images/mongoDB.jpg alt=mongodb-dash class=lightbox-image loading=lazy></a></p><ul><li>Kafka Dashboard:</li></ul><p><a href=#image-d3e975ad31d6015ab657ac2c8ce93e6e class=lightbox-link><img src=../tko/session-2/deploy/../images/kafka.jpg alt=kafka-dash style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d3e975ad31d6015ab657ac2c8ce93e6e><img src=../tko/session-2/deploy/../images/kafka.jpg alt=kafka-dash class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><h1 id=code-to-kubernetes---python>Code to Kubernetes - Python</h1><h2 id=code-to-kubernetes---python>Code to Kubernetes - Python</h2><p><strong>Objective:</strong> Understand activities to instrument a python application and run it on Kubernetes.</p><ul><li>Verify the code</li><li>Containerize the app</li><li>Deploy the container in Kubernetes</li></ul><p><strong>Note:</strong> these steps do not involve Splunk</p><p><strong>Duration:</strong> 15 Minutes</p><h2 id=1-verify-the-code---review-service>1. Verify the code - Review service</h2><p>Navigate to the review directory</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/ubuntu/realtime_enrichment/flask_apps/review/
</span></span></code></pre></div><p>Inspect review.py (realtime_enrichment/flask_apps/review)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat review.py
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>review</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>num_reviews</span> <span class=o>=</span> <span class=mi>8635403</span>
</span></span><span class=line><span class=cl><span class=n>num_reviews</span> <span class=o>=</span> <span class=mi>100000</span>
</span></span><span class=line><span class=cl><span class=n>reviews_file</span> <span class=o>=</span> <span class=s1>&#39;/var/appdata/yelp_academic_dataset_review.json&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@review.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hello_world</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>message</span><span class=o>=</span><span class=s1>&#39;Hello, you want to hit /get_review. We have &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>num_reviews</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39; reviews!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@review.route</span><span class=p>(</span><span class=s1>&#39;/get_review&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_review</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>random_review_int</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>num_reviews</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>line_num</span> <span class=o>=</span> <span class=n>random_review_int</span> <span class=o>+</span> <span class=s1>&#39;q;d&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>command</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;sed&#34;</span><span class=p>,</span> <span class=n>line_num</span><span class=p>,</span> <span class=n>reviews_file</span><span class=p>]</span> <span class=c1># sed &#34;7997242q;d&#34; &lt;file&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>random_review</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>random_review</span><span class=o>.</span><span class=n>stdout</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>review</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span> <span class=o>=</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=mi>5000</span><span class=p>,</span> <span class=n>debug</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></div><p>Inspect requirements.txt</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Flask==2.0.2
</span></span></code></pre></div><p>Create a virtual environment and Install the necessary python packages</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/ubuntu/realtime_enrichment/workshop/flask_apps_start/review/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pip freeze <span class=c1>#note output</span>
</span></span><span class=line><span class=cl>pip install -r requirements.txt
</span></span><span class=line><span class=cl>pip freeze <span class=c1>#note output</span>
</span></span></code></pre></div><p>Start the REVIEW service. <strong>Note:</strong> You can stop the app with control+C</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 review.py
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> * Serving Flask app <span class=s1>&#39;review&#39;</span> <span class=o>(</span>lazy loading<span class=o>)</span>
</span></span><span class=line><span class=cl> * Environment: production
</span></span><span class=line><span class=cl>         ...snip...
</span></span><span class=line><span class=cl> * Running on http://10.160.145.246:5000/ <span class=o>(</span>Press CTRL+C to quit<span class=o>)</span>
</span></span><span class=line><span class=cl> * Restarting with stat
</span></span><span class=line><span class=cl>127.0.0.1 - - <span class=o>[</span>17/May/2022 22:46:38<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span><span class=line><span class=cl>127.0.0.1 - - <span class=o>[</span>17/May/2022 22:47:02<span class=o>]</span> <span class=s2>&#34;GET /get_review HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span><span class=line><span class=cl>127.0.0.1 - - <span class=o>[</span>17/May/2022 22:47:58<span class=o>]</span> <span class=s2>&#34;GET /get_review HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span></code></pre></div><p>Verify that the service is working</p><ul><li>Open a new terminal and ssh into your ec2 instance. Then use the curl command in your terminal.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:5000
</span></span></code></pre></div><ul><li>Or hit the URL <code>http://{Your_EC2_IP_address}:5000</code> and <code>http://{Your_EC2_IP_address}:5000/get_review</code> with a browser</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl localhost:5000
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Hello, you want to hit /get_review. We have 100000 reviews!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl localhost:5000/get_review
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;review_id&#34;</span>:<span class=s2>&#34;NjbiESXotcEdsyTc4EM3fg&#34;</span>,<span class=s2>&#34;user_id&#34;</span>:<span class=s2>&#34;PR9LAM19rCM_HQiEm5OP5w&#34;</span>,<span class=s2>&#34;business_id&#34;</span>:<span class=s2>&#34;UAtX7xmIfdd1W2Pebf6NWg&#34;</span>,<span class=s2>&#34;stars&#34;</span>:3.0,<span class=s2>&#34;useful&#34;</span>:0,<span class=s2>&#34;funny&#34;</span>:0,<span class=s2>&#34;cool&#34;</span>:0,<span class=s2>&#34;text&#34;</span>:<span class=s2>&#34;-If you&#39;re into cheap beer (pitcher of bud-light for </span><span class=nv>$7</span><span class=s2>) decent wings and a good time, this is the place for you. Its generally very packed after work hours and weekends. Don&#39;t expect cocktails. \n\n-You run into a lot of sketchy characters here sometimes but for the most part if you&#39;re chilling with friends its not that bad. \n\n-Friendly bouncer and bartenders.&#34;</span>,<span class=s2>&#34;date&#34;</span>:<span class=s2>&#34;2016-04-12 20:23:24&#34;</span><span class=o>}</span>
</span></span></code></pre></div><p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><ul><li>What does this application do?</li><li>Do you see the yelp dataset being used?</li><li>Why did the output of pip freeze differ each time you ran it?</li><li>Which port is the REVIEW app listening on? Can other python apps use this same port?</li></ul></div></div>}</p><h2 id=2-create-a-review-container>2. Create a REVIEW container</h2><p>To create a container image, you need to create a Dockerfile, run docker build to build the image referencing the Docker file and push it up to a remote repository so it can be pulled by other sources.</p><ul><li><a href=https://docs.docker.com/get-started/02_our_app/ target=_blank>Create a Dockerfile</a></li><li>Creating a Dockerfile typically requires you to consider the following:<ul><li>Identify an appropriate container image<ul><li>ubuntu vs. python vs. alpine/slim</li><li>ubuntu - overkill, large image size, wasted resources when running in K8</li><li>this is a python app, so pick an image that is optimized for it</li><li><a href=https://lih-verma.medium.com/alpine-makes-python-docker-builds-way-too-50-slower-and-images-double-2-larger-61d1d43cbc79 target=_blank>avoid alpine for python</a></li></ul></li><li>Order matters<ul><li>you&rsquo;re building layers.</li><li>re-use the layers as much as possible</li><li>have items that change often towards the end</li></ul></li><li><a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/ target=_blank>Other Best practices for writing Dockerfiles</a></li></ul></li></ul><p>Dockerfile for review</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.10-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./review.py /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 5000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span> <span class=s2>&#34;python&#34;</span><span class=p>,</span> <span class=s2>&#34;review.py&#34;</span> <span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>Create a container image (locally)
Run ‘docker build’ to build a local container image referencing the Dockerfile</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker build" class="tab-nav-button active" onclick='switchTab("default","docker build")'>
<span>docker build</span></button>
<button data-tab-item="docker build Output" class=tab-nav-button onclick='switchTab("default","docker build Output")'>
<span>docker build Output</span></button></div><div class=tab-content><div data-tab-item="docker build" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -f Dockerfile -t localhost:8000/review:0.01 .
</span></span></code></pre></div></div><div data-tab-item="docker build Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[+] Building 35.5s (11/11) FINISHED
</span></span><span class=line><span class=cl> =&gt; [internal] load build definition from Dockerfile                              0.0s
</span></span><span class=line><span class=cl>         ...snip...
</span></span><span class=line><span class=cl> =&gt; [3/5] COPY requirements.txt /app                                              0.0s
</span></span><span class=line><span class=cl> =&gt; [4/5] RUN pip install -r requirements.txt                                     4.6s
</span></span><span class=line><span class=cl> =&gt; [5/5] COPY ./review.py /app                                                   0.0s
</span></span><span class=line><span class=cl> =&gt; exporting to image                                                            0.2s
</span></span><span class=line><span class=cl> =&gt; =&gt; exporting layers                                                           0.2s
</span></span><span class=line><span class=cl> =&gt; =&gt; writing image sha256:61da27081372723363d0425e0ceb34bbad6e483e698c6fe439c5  0.0s
</span></span><span class=line><span class=cl> =&gt; =&gt; naming to docker.io/localhost:8000/review:0.1                                   0.0
</span></span></code></pre></div></div></div></div><p>Push the container image into a container repository
Run ‘docker push’ to place a copy of the REVIEW container to a remote location</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker push" class="tab-nav-button active" onclick='switchTab("default","docker push")'>
<span>docker push</span></button>
<button data-tab-item="docker push Output" class=tab-nav-button onclick='switchTab("default","docker push Output")'>
<span>docker push Output</span></button></div><div class=tab-content><div data-tab-item="docker push" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker push localhost:8000/review:0.01
</span></span></code></pre></div></div><div data-tab-item="docker push Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The push refers to repository [docker.io/localhost:8000/review]
</span></span><span class=line><span class=cl>02c36dfb4867: Pushed
</span></span><span class=line><span class=cl>         ...snip...
</span></span><span class=line><span class=cl>fd95118eade9: Pushed
</span></span><span class=line><span class=cl>0.1: digest: sha256:3651f740abe5635af95d07acd6bcf814e4d025fcc1d9e4af9dee023a9b286f38 size: 2202
</span></span></code></pre></div></div></div></div><p>Verify that the image is in Docker Hub. The same info can be found in Docker Desktop</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="get catalog" class="tab-nav-button active" onclick='switchTab("default","get catalog")'>
<span>get catalog</span></button>
<button data-tab-item="get catalog Output" class=tab-nav-button onclick='switchTab("default","get catalog Output")'>
<span>get catalog Output</span></button></div><div class=tab-content><div data-tab-item="get catalog" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -s http://localhost:8000/v2/_catalog
</span></span></code></pre></div></div><div data-tab-item="get catalog Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;repositories&#34;:[&#34;review&#34;]}
</span></span></code></pre></div></div></div></div><h2 id=3-run-review-in-kubernetes>3. Run REVIEW in Kubernetes</h2><p>Create K8 deployment yaml file for the REVIEW app</p><p>Reference: <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment target=_blank>Creating a Deployment</a></p><p>review.deployment.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>imagePullSecrets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>regcred</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>localhost:8000/review:0.01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/appdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>appdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>appdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/appdata</span><span class=w>
</span></span></span></code></pre></div><p>Notes regarding review.deployment.yaml:</p><ul><li>labels - K8 uses labels and selectors to tag and identify resources<ul><li>In the next step, we&rsquo;ll create a service and associate it to this deployment using the label</li></ul></li><li>replicas = 1<ul><li>K8 allows you to scale your deployments horizontally</li><li>We&rsquo;ll leverage this later to add load and increase our ingestion rate</li></ul></li><li>regcred provides this deployment with the ability to access your dockerhub credentials which is necessary to pull the container image.</li><li>The volume definition and volumemount make the yelp dataset visible to the container</li></ul><p>Create a K8 service yaml file for the review app.</p><p>Reference: <a href=https://kubernetes.io/docs/concepts/services-networking/service/#defining-a-service target=_blank>Creating a service:</a></p><p>review.service.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>5000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w>
</span></span></span></code></pre></div><p>Notes about review.service.yaml:</p><ul><li>the selector associates this service to pods with the label app with the value being review</li><li>the review service exposes the review pods as a network service<ul><li>other pods can now ping &lsquo;review&rsquo; and they will hit a review pod.</li><li>a pod would get a review if it ran <code>curl http://review:5000</code></li></ul></li><li>NodePort service<ul><li>the service is accessible to the K8 host by the nodePort, 30000</li><li>Another machine that has this can get a review if it ran <code>curl http://&lt;k8 host ip>:30000</code></li></ul></li></ul><p>Apply the review deployment and service</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f review.service.yaml -f review.deployment.yaml
</span></span></code></pre></div><p>Verify that the deployment and services are running:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get deployments" class="tab-nav-button active" onclick='switchTab("default","kubectl get deployments")'>
<span>kubectl get deployments</span></button>
<button data-tab-item="kubectl get deployments output" class=tab-nav-button onclick='switchTab("default","kubectl get deployments output")'>
<span>kubectl get deployments output</span></button></div><div class=tab-content><div data-tab-item="kubectl get deployments" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments
</span></span></code></pre></div></div><div data-tab-item="kubectl get deployments output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>review                                                  1/1     1            1           19h
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get services" class="tab-nav-button active" onclick='switchTab("default","kubectl get services")'>
<span>kubectl get services</span></button>
<button data-tab-item="kubectl get services output" class=tab-nav-button onclick='switchTab("default","kubectl get services output")'>
<span>kubectl get services output</span></button></div><div class=tab-content><div data-tab-item="kubectl get services" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get services
</span></span></code></pre></div></div><div data-tab-item="kubectl get services output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
</span></span><span class=line><span class=cl>review                     NodePort    10.43.175.21    &lt;none&gt;        5000:30000/TCP                  154d
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="curl localhost" class="tab-nav-button active" onclick='switchTab("default","curl localhost")'>
<span>curl localhost</span></button>
<button data-tab-item="curl localhost Output" class=tab-nav-button onclick='switchTab("default","curl localhost Output")'>
<span>curl localhost Output</span></button></div><div class=tab-content><div data-tab-item="curl localhost" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl localhost:30000
</span></span></code></pre></div></div><div data-tab-item="curl localhost Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;message&#34;: &#34;Hello, you want to hit /get_review. We have 100000 reviews!&#34;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="get review" class="tab-nav-button active" onclick='switchTab("default","get review")'>
<span>get review</span></button>
<button data-tab-item="get review Output" class=tab-nav-button onclick='switchTab("default","get review Output")'>
<span>get review Output</span></button></div><div class=tab-content><div data-tab-item="get review" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl localhost:30000/get_review
</span></span></code></pre></div></div><div data-tab-item="get review Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;review_id&#34;:&#34;Vv9rHtfBrFc-1M1DHRKN9Q&#34;,&#34;user_id&#34;:&#34;EaNqIwKkM7p1bkraKotqrg&#34;,&#34;business_id&#34;:&#34;TA1KUSCu8GkWP9w0rmElxw&#34;,&#34;stars&#34;:3.0,&#34;useful&#34;:1,&#34;funny&#34;:0,&#34;cool&#34;:0,&#34;text&#34;:&#34;This is the first time I&#39;ve actually written a review for Flip, but I&#39;ve probably been here about 10 times.  \n\nThis used to be where I would take out of town guests who wanted a good, casual, and relatively inexpensive meal.  \n\nI hadn&#39;t been for a while, so after a long day in midtown, we decided to head to Flip.  \n\nWe had the fried pickles, onion rings, the gyro burger, their special burger, and split a nutella milkshake.  I have tasted all of the items we ordered previously (with the exception of the special) and have been blown away with how good they were.  My guy had the special which was definitely good, so no complaints there.  The onion rings and the fried pickles were greasier than expected.  Though I&#39;ve thought they were delicious in the past, I probably wouldn&#39;t order either again.  The gyro burger was good, but I could have used a little more sauce.  It almost tasted like all of the ingredients didn&#39;t entirely fit together.  Something was definitely off. It was a friday night and they weren&#39;t insanely busy, so I&#39;m not sure I would attribute it to the staff not being on their A game...\n\nDon&#39;t get me wrong.  Flip is still good.  The wait staff is still amazingly good looking.  They still make delicious milk shakes.  It&#39;s just not as amazing as it once was, which really is a little sad.&#34;,&#34;date&#34;:&#34;2010-10-11 18:18:35&#34;}
</span></span></code></pre></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What changes are required if you need to make an update to your Dockerfile now?</p></div></div><footer class=footline></footer></article><article class=default><h1 id=instrument-reviews-for-tracing>Instrument REVIEWS for Tracing</h1><h2 id=1-use-data-setup-to-instrument-a-python-application>1. Use Data Setup to instrument a Python application</h2><p>Within the O11y Cloud UI:</p><p>Data Management -> Add Integration -> Monitor Applications -> Python (traces) -> Add Integration</p><p>Provide the following to the Configure Integration Wizard:</p><ul><li><p>Service: review</p></li><li><p>Django: no</p></li><li><p>collector endpoint: <code>http://localhost:4317</code></p></li><li><p>Environment: rtapp-workshop-[YOURNAME]</p></li><li><p>Kubernetes: yes</p></li><li><p>Legacy Agent: no</p></li></ul><p><a href=#image-fc64f39d37d1396d7b694af7571dd352 class=lightbox-link><img src=../tko/session-2/instrument/../images/configureintegration.png alt=o11y_cloud_ui style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-fc64f39d37d1396d7b694af7571dd352><img src=../tko/session-2/instrument/../images/configureintegration.png alt=o11y_cloud_ui class=lightbox-image loading=lazy></a></p><p>We are instructed to:</p><ul><li><p>Install the instrumentation packages for your Python environment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>pip install splunk-opentelemetry[all]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>splunk-py-trace-bootstrap
</span></span></code></pre></div></li><li><p>Configure the Downward API to expose environment variables to Kubernetes resources.</p><p>For example, update a Deployment to inject environment variables by adding <code>.spec.template.spec.containers.env</code> like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>your-application</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPLUNK_OTEL_AGENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(SPLUNK_OTEL_AGENT):4317&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;review&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=rtapp-workshop-stevel&#34;</span><span class=w>
</span></span></span></code></pre></div></li><li><p>Enable the Splunk OTel Python agent by editing your Python service command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>splunk-py-trace python3 main.py --port=8000
</span></span></code></pre></div></li><li><p>The actions we must perform include:</p><ul><li>Update the Dockerfile to install the splunk-opentelemetry packages</li><li>Update the deployment.yaml for each service to include these environment variables which will be used by the pod and container.</li><li>Update our Dockerfile for REVIEW so that our program is bootstrapped with splunk-py-trace</li></ul></li></ul><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p>We will accomplish this by 1) generating a new requirements.txt file, 2) generating a new container image with an updated Dockerfile for REVIEW and then 3) update the review.deployment.yaml to capture all of these changes.</p></div></div><h2 id=2-update-the-review-container>2. Update the REVIEW container</h2><ul><li><p>Generate a new container image</p></li><li><p>Update the Dockerfile for REVIEW (<code>/workshop/flask_apps_finish/review</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.10-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install splunk-opentelemetry<span class=o>[</span>all<span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> splk-py-trace-bootstrap<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./review.py /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 5000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span> <span class=s2>&#34;splunk-py-trace&#34;</span> <span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span> <span class=s2>&#34;python&#34;</span><span class=p>,</span> <span class=s2>&#34;review.py&#34;</span> <span class=p>]</span><span class=err>
</span></span></span></code></pre></div></li></ul><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p>Note that the only lines, in bold, added to the Dockerfile</p></div></div><ul><li>Generate a new container image with docker build in the ‘finished’ directory</li><li>Notice that I have changed the repository name from <code>localhost:8000/review:0.01</code> to <code>localhost:8000/review-splkotel:0.01</code></li></ul><p>Ensure you are in the correct directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  <span class=nb>pwd</span>
</span></span><span class=line><span class=cl>  ./workshop/flask_apps_finish/review
</span></span></code></pre></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker build" class="tab-nav-button active" onclick='switchTab("default","docker build")'>
<span>docker build</span></button>
<button data-tab-item="docker build Output" class=tab-nav-button onclick='switchTab("default","docker build Output")'>
<span>docker build Output</span></button></div><div class=tab-content><div data-tab-item="docker build" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -f Dockerfile.review -t localhost:8000/review-splkotel:0.01 .
</span></span></code></pre></div></div><div data-tab-item="docker build Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[+] Building 27.1s (12/12) FINISHED
</span></span><span class=line><span class=cl>=&gt; [internal] load build definition from Dockerfile                                                        0.0s
</span></span><span class=line><span class=cl>=&gt; =&gt; transferring dockerfile: 364B                                                                        0.0s
</span></span><span class=line><span class=cl>=&gt; [internal] load .dockerignore                                                                           0.0s
</span></span><span class=line><span class=cl>=&gt; =&gt; transferring context: 2B                                                                             0.0s
</span></span><span class=line><span class=cl>=&gt; [internal] load metadata for docker.io/library/python:3.10-slim                                         1.6s
</span></span><span class=line><span class=cl>=&gt; [auth] library/python:pull token for registry-1.docker.io                                               0.0s
</span></span><span class=line><span class=cl>=&gt; [1/6] FROM docker.io/library/python:3.10-slim@sha256:54956d6c929405ff651516d5ebbc204203a6415c9d2757aad  0.0s
</span></span><span class=line><span class=cl>=&gt; [internal] load build context                                                                           0.3s
</span></span><span class=line><span class=cl>=&gt; =&gt; transferring context: 1.91kB                                                                         0.3s
</span></span><span class=line><span class=cl>=&gt; CACHED [2/6] WORKDIR /app                                                                               0.0s
</span></span><span class=line><span class=cl>=&gt; [3/6] COPY requirements.txt /app                                                                        0.0s
</span></span><span class=line><span class=cl>=&gt; [4/6] RUN pip install -r requirements.txt                                                              15.3s
</span></span><span class=line><span class=cl>=&gt; [5/6] RUN splk-py-trace-bootstrap                                                                       9.0s
</span></span><span class=line><span class=cl>=&gt; [6/6] COPY ./review.py /app                                                                             0.0s
</span></span><span class=line><span class=cl>=&gt; exporting to image                                                                                      0.6s
</span></span><span class=line><span class=cl>=&gt; =&gt; exporting layers                                                                                     0.6s
</span></span><span class=line><span class=cl>=&gt; =&gt; writing image sha256:164977dd860a17743b8d68bcc50c691082bd3bfb352d1025dc3a54b15d5f4c4d                0.0s
</span></span><span class=line><span class=cl>=&gt; =&gt; naming to docker.io/localhost:8000/review-splkotel:0.01                                              0.0s
</span></span></code></pre></div></div></div></div><ul><li>Push the image to Docker Hub with docker push command</li></ul><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker push" class="tab-nav-button active" onclick='switchTab("default","docker push")'>
<span>docker push</span></button>
<button data-tab-item="docker push Output" class=tab-nav-button onclick='switchTab("default","docker push Output")'>
<span>docker push Output</span></button></div><div class=tab-content><div data-tab-item="docker push" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker push localhost:8000/review-splkotel:0.01
</span></span></code></pre></div></div><div data-tab-item="docker push Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The push refers to repository [docker.io/localhost:8000/review-splkotel]
</span></span><span class=line><span class=cl>682f0e550f2c: Pushed
</span></span><span class=line><span class=cl>dd7dfa312442: Pushed
</span></span><span class=line><span class=cl>917fd8334695: Pushed
</span></span><span class=line><span class=cl>e6782d51030d: Pushed
</span></span><span class=line><span class=cl>c6b19a64e528: Mounted from localhost:8000/review
</span></span><span class=line><span class=cl>8f52e3bfc0ab: Mounted from localhost:8000/review
</span></span><span class=line><span class=cl>f90b85785215: Mounted from localhost:8000/review
</span></span><span class=line><span class=cl>d5c0beb90ce6: Mounted from localhost:8000/review
</span></span><span class=line><span class=cl>3759be374189: Mounted from localhost:8000/review
</span></span><span class=line><span class=cl>fd95118eade9: Mounted from localhost:8000/review
</span></span><span class=line><span class=cl>0.01: digest: sha256:3b251059724dbb510ea81424fc25ed03554221e09e90ef965438da33af718a45 size: 2412
</span></span></code></pre></div></div></div></div><h2 id=3-update-the-review-deployment-in-kubernetes>3. Update the REVIEW deployment in Kubernetes</h2><ul><li><p>review.deployment.yaml must be updated with the following changes:</p><ul><li>Load the new container image on Docker Hub</li><li>Add environment variables so traces can be emitted to the OTEL collector</li></ul></li><li><p>The deployment must be replaced using the updated review.deployment.yaml</p><ul><li>Update review.deployment.yaml (updates highlighted in bold)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>imagePullSecrets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>regcred</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>localhost:8000/review-splkotel:0.01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>review</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/appdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>appdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPLUNK_OTEL_AGENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;review&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPLUNK_METRICS_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(SPLUNK_OTEL_AGENT):9943&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(SPLUNK_OTEL_AGENT):4317&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;deployment.environment=rtapp-workshop-stevel&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>appdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/appdata</span><span class=w>
</span></span></span></code></pre></div></li><li><p>Apply review.deployment.yaml. Kubernetes will automatically pick up the changes to the deployment and redeploy new pods with these updates</p><ul><li>Notice that the review-* pod has been restarted</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f review.deployment.yaml
</span></span><span class=line><span class=cl>  deployment.apps/review configured
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  kubectl get pods
</span></span><span class=line><span class=cl>  NAME                                                              READY   STATUS        RESTARTS   AGE
</span></span><span class=line><span class=cl>  kafka-client                                                      0/1     Unknown       0          155d
</span></span><span class=line><span class=cl>  curl                                                              0/1     Unknown       0          155d
</span></span><span class=line><span class=cl>  kafka-zookeeper-0                                                 1/1     Running       0          26h
</span></span><span class=line><span class=cl>  kafka-2                                                           2/2     Running       0          26h
</span></span><span class=line><span class=cl>  kafka-exporter-647bddcbfc-h9gp5                                   1/1     Running       2          26h
</span></span><span class=line><span class=cl>  mongodb-6f6c78c76-kl4vv                                           2/2     Running       0          26h
</span></span><span class=line><span class=cl>  kafka-1                                                           2/2     Running       1          26h
</span></span><span class=line><span class=cl>  kafka-0                                                           2/2     Running       1          26h
</span></span><span class=line><span class=cl>  splunk-otel-collector-1653114277-agent-n4dfn                      2/2     Running       0          26h
</span></span><span class=line><span class=cl>  splunk-otel-collector-1653114277-k8s-cluster-receiver-5f48v296j   1/1     Running       0          26h
</span></span><span class=line><span class=cl>  splunk-otel-collector-1653114277-agent-jqxhh                      2/2     Running       0          26h
</span></span><span class=line><span class=cl>  review-6686859bd7-4pf5d                                           1/1     Running       0          11s
</span></span><span class=line><span class=cl>  review-5dd8cfd77b-52jbd                                           0/1     Terminating   0          2d10h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl get pods
</span></span><span class=line><span class=cl>  NAME                                                              READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>  kafka-client                                                      0/1     Unknown   0          155d
</span></span><span class=line><span class=cl>  curl                                                              0/1     Unknown   0          155d
</span></span><span class=line><span class=cl>  kafka-zookeeper-0                                                 1/1     Running   0          26h
</span></span><span class=line><span class=cl>  kafka-2                                                           2/2     Running   0          26h
</span></span><span class=line><span class=cl>  kafka-exporter-647bddcbfc-h9gp5                                   1/1     Running   2          26h
</span></span><span class=line><span class=cl>  mongodb-6f6c78c76-kl4vv                                           2/2     Running   0          26h
</span></span><span class=line><span class=cl>  kafka-1                                                           2/2     Running   1          26h
</span></span><span class=line><span class=cl>  kafka-0                                                           2/2     Running   1          26h
</span></span><span class=line><span class=cl>  splunk-otel-collector-1653114277-agent-n4dfn                      2/2     Running   0          26h
</span></span><span class=line><span class=cl>  splunk-otel-collector-1653114277-k8s-cluster-receiver-5f48v296j   1/1     Running   0          26h
</span></span><span class=line><span class=cl>  splunk-otel-collector-1653114277-agent-jqxhh                      2/2     Running   0          26h
</span></span><span class=line><span class=cl>  review-6686859bd7-4pf5d                                           1/1     Running   0          15s
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=monitor-system-logs-with-splunk-universal-forwarder>Monitor System Logs with Splunk Universal Forwarder</h1><p><strong>Objective:</strong> Learn how to monitor Linux system logs with the Universal Forwarder sending logs to Splunk Enterprise</p><p><strong>Duration</strong>: 10 Minutes</p><h2 id=scenario>Scenario</h2><p>You&rsquo;ve been tasked with monitoring the OS logs of the host running your Kubernetes cluster. We are going to utilize a script that will autodeploy the Splunk Universal Forwarder. You will then configure the Universal Forwarder to send logs to the Splunk Enterprise instance assigned to you.</p><h3 id=1-ensure-youre-in-the-correct-directory>1. Ensure You&rsquo;re in the Correct Directory</h3><ul><li>we will need to be in /home/ubuntu/session-2</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/ubuntu/session-2
</span></span></code></pre></div><h3 id=2-review-the-universal-forwarder-install-script>2. Review the Universal Forwarder Install Script</h3><ul><li>Let&rsquo;s take a look at the script that will install the Universal Forwarder and Linux TA automatically for you.<ul><li>This script is primarily used for remote instances.</li><li>Note we are not using a deployment server in this lab, however it is recommended in production we do that.</li><li>What user are we installing Splunk as?</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh  
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># This EXAMPLE script shows how to deploy the Splunk universal forwarder</span>
</span></span><span class=line><span class=cl><span class=c1># to many remote hosts via ssh and common Unix commands.</span>
</span></span><span class=line><span class=cl><span class=c1># For &#34;real&#34; use, this script needs ERROR DETECTION AND LOGGING!!</span>
</span></span><span class=line><span class=cl><span class=c1># --Variables that you must set -----</span>
</span></span><span class=line><span class=cl><span class=c1># Set username using by splunkd to run.</span>
</span></span><span class=line><span class=cl>  <span class=nv>SPLUNK_RUN_USER</span><span class=o>=</span><span class=s2>&#34;ubuntu&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Populate this file with a list of hosts that this script should install to,</span>
</span></span><span class=line><span class=cl><span class=c1># with one host per line. This must be specified in the form that should</span>
</span></span><span class=line><span class=cl><span class=c1># be used for the ssh login, ie. username@host</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Example file contents:</span>
</span></span><span class=line><span class=cl><span class=c1># splunkuser@10.20.13.4</span>
</span></span><span class=line><span class=cl><span class=c1># splunkker@10.20.13.5</span>
</span></span><span class=line><span class=cl>  <span class=nv>HOSTS_FILE</span><span class=o>=</span><span class=s2>&#34;myhost.txt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This should be a WGET command that was *carefully* copied from splunk.com!!</span>
</span></span><span class=line><span class=cl><span class=c1># Sign into splunk.com and go to the download page, then look for the wget</span>
</span></span><span class=line><span class=cl><span class=c1># link near the top of the page (once you have selected your platform)</span>
</span></span><span class=line><span class=cl><span class=c1># copy and paste your wget command between the &#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>WGET_CMD</span><span class=o>=</span><span class=s2>&#34;wget -O splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz &#39;https://download.splunk.com/products/universalforwarder/releases/9.0.3/linux/splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz&#39;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Set the install file name to the name of the file that wget downloads</span>
</span></span><span class=line><span class=cl><span class=c1># (the second argument to wget)</span>
</span></span><span class=line><span class=cl>  <span class=nv>INSTALL_FILE</span><span class=o>=</span><span class=s2>&#34;splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># After installation, the forwarder will become a deployment client of this</span>
</span></span><span class=line><span class=cl><span class=c1># host.  Specify the host and management (not web) port of the deployment server</span>
</span></span><span class=line><span class=cl><span class=c1># that will be managing these forwarder instances.</span>
</span></span><span class=line><span class=cl><span class=c1># Example 1.2.3.4:8089</span>
</span></span><span class=line><span class=cl><span class=c1>#  DEPLOY_SERVER=&#34;x.x.x.x:8089&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># After installation, the forwarder can have additional TA&#39;s added to the </span>
</span></span><span class=line><span class=cl><span class=c1># /app directory please provide the local where TA&#39;s will be. </span>
</span></span><span class=line><span class=cl>  <span class=nv>TA_INSTALL_DIRECTORY</span><span class=o>=</span><span class=s2>&#34;/home/ubuntu/session-2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the seed app folder name for deploymentclien.conf</span>
</span></span><span class=line><span class=cl><span class=c1>#  DEPLOY_APP_FOLDER_NAME=&#34;seed_all_deploymentclient&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Set the new Splunk admin password</span>
</span></span><span class=line><span class=cl>  <span class=nv>PASSWORD</span><span class=o>=</span><span class=s2>&#34;buttercup&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>REMOTE_SCRIPT_DEPLOY</span><span class=o>=</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>  cd /opt
</span></span></span><span class=line><span class=cl><span class=s2>  sudo </span><span class=nv>$WGET_CMD</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  sudo tar xvzf </span><span class=nv>$INSTALL_FILE</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  sudo rm </span><span class=nv>$INSTALL_FILE</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  #sudo useradd </span><span class=nv>$SPLUNK_RUN_USER</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  sudo find </span><span class=nv>$TA_INSTALL_DIRECTORY</span><span class=s2> -name &#39;*.tgz&#39; -exec tar xzvf {} --directory /opt/splunkforwarder/etc/apps \;
</span></span></span><span class=line><span class=cl><span class=s2>  sudo chown -R </span><span class=nv>$SPLUNK_RUN_USER</span><span class=s2>:</span><span class=nv>$SPLUNK_RUN_USER</span><span class=s2> /opt/splunkforwarder
</span></span></span><span class=line><span class=cl><span class=s2>  echo \&#34;[user_info] 
</span></span></span><span class=line><span class=cl><span class=s2>  USERNAME = admin
</span></span></span><span class=line><span class=cl><span class=s2>  PASSWORD = </span><span class=nv>$PASSWORD</span><span class=s2>\&#34; &gt; /opt/splunkforwarder/etc/system/local/user-seed.conf   
</span></span></span><span class=line><span class=cl><span class=s2>  #sudo cp </span><span class=nv>$TA_INSTALL_DIRECTORY</span><span class=s2>/*.tgz /opt/splunkforwader/etc/apps/
</span></span></span><span class=line><span class=cl><span class=s2>  #sudo find /opt/splunkforwarder/etc/apps/ -name &#39;*.tgz&#39; -exec tar xzvf {} \;
</span></span></span><span class=line><span class=cl><span class=s2>  #sudo -u splunk /opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --auto-ports --no-prompt
</span></span></span><span class=line><span class=cl><span class=s2>  /opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --auto-ports --no-prompt
</span></span></span><span class=line><span class=cl><span class=s2>  #sudo /opt/splunkforwarder/bin/splunk enable boot-start -user </span><span class=nv>$SPLUNK_RUN_USER</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  /opt/splunkforwarder/bin/splunk enable boot-start -user </span><span class=nv>$SPLUNK_RUN_USER</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  #sudo cp </span><span class=nv>$TA_INSTALL_DIRECTORY</span><span class=s2>/*.tgz /opt/splunkforwarder/etc/apps/
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  exit
</span></span></span><span class=line><span class=cl><span class=s2> &#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>DIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span> <span class=nb>cd</span> <span class=s2>&#34;</span><span class=k>$(</span> dirname <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BASH_SOURCE</span><span class=p>[0]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>)</span><span class=s2>&#34;</span> &gt;/dev/null <span class=o>&amp;&amp;</span> <span class=nb>pwd</span> <span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#===============================================================================================</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;In 5 seconds, will run the following script on each remote host:&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;====================&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$REMOTE_SCRIPT_DEPLOY</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;====================&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> 
</span></span><span class=line><span class=cl>  sleep <span class=m>5</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Reading host logins from </span><span class=nv>$HOSTS_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Starting.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> DST in <span class=sb>`</span>cat <span class=s2>&#34;</span><span class=nv>$DIR</span><span class=s2>/</span><span class=nv>$HOSTS_FILE</span><span class=s2>&#34;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$DST</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;---------------------------&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Installing to </span><span class=nv>$DST</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Initial UF deployment&#34;</span>
</span></span><span class=line><span class=cl>    sudo ssh -t <span class=s2>&#34;</span><span class=nv>$DST</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$REMOTE_SCRIPT_DEPLOY</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>  
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;---------------------------&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Done&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Please use the following app folder name to override deploymentclient.conf options: </span><span class=nv>$DEPLOY_APP_FOLDER_NAME</span><span class=s2>&#34;</span>
</span></span></code></pre></div><h3 id=3-run-the-install-script>3. Run the install script</h3><p>We will run the install script now. You will see some Warnings at the end. This is totally normal. The script is built for use on remote machines, however for todays lab you will be using localhost.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./install.sh
</span></span></code></pre></div><p>You will be asked <code>Are you sure you want to continue connecting (yes/no/[fingerprint])?</code>
Answer Yes.</p><p>Enter your ssh password when prompted.</p><h3 id=4-verify-installation-of-the-universal-forwarader>4. Verify installation of the Universal Forwarader</h3><ul><li>We need to verify that the Splunk Universal Forwarder is installed and running.<ul><li>You should see a couple PID&rsquo;s return and a &ldquo;Splunk is currently running.&rdquo; message.</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/opt/splunkforwarder/bin/splunk status
</span></span></code></pre></div><h4 id=5-configure-the-universal-forwarder-to-send-data-to-splunk-enterprise>5. Configure the Universal Forwarder to Send Data to Splunk Enterprise.</h4><ul><li>We will be able to send the data to our Splunk Enterprise environment easily by entering one line into the cli.<ul><li><a href=https://docs.splunk.com/Documentation/Forwarder/9.0.3/Forwarder/Configuretheuniversalforwarder target=_blank>Universal Forwarder Config Guide</a></li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/opt/splunkforwarder/bin/splunk add forward-server &lt;your_splunk_enterprise_ip&gt;:9997
</span></span></code></pre></div><h4 id=6-verify-the-data-in-your-splunk-enterprise-environment>6. Verify the Data in Your Splunk Enterprise Environment</h4><ul><li><p>We are now going to take a look at the Splunk Enterprise environment to verify logs are coming in.</p><ul><li>Logs will be coming into <code>index=main</code></li></ul></li><li><p>Open your web browser and navigate to: <code>http://&lt;your_splunk_enterprise_ip:8000</code></p><ul><li>You will use the credentials <code>admin:&lt;your_ssh_password></code></li></ul></li><li><p>In the search bar, type in the following:</p></li><li><p><code>index=main host=&lt;your_host_name></code></p></li><li><p>You should see data from your host. Take note of the interesting fields and the different data sources flowing in.</p></li></ul><footer class=footline></footer></article></section><article class=default><h1 id=5-how-platform-engineers-observe-kubernetes>5. How Platform Engineers Observe Kubernetes</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>This workshop will equip you with the basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector. During the workshop you will deploy PHP/Apache and a load generator.</p><p>You will learn about OpenTelemetry Receivers, Kubernetes Namespaces, ReplicaSets, Kubernetes Horizontal Pod AutoScaling and how to monitor all this using the Splunk Observability Cloud. The main learnings from the workshop will be a better understanding of the Kubernetes Navigator (and Dashboards) in Splunk Observability Cloud as well as seeing Kubernetes metrics, events and Detectors.</p><p>In order to part take in this workshop you will need to have:</p><ul><li>Your laptop</li><li>Already have logged into US Splunk Show via <a href=https://app.us1.signalfx.com target=_blank>https://app.us1.signalfx.com</a> using Google SSO</li><li>Terminal access to the workshop instance via SSH</li><li>Hopefully a stable wi-fi connection, but we can&rsquo;t promise that!</li></ul><p>For this workshop Splunk has prepared an Ubuntu Linux instance in AWS/EC2 all pre-configured for you.</p><p>To get access to the instance that you will be using in the workshop, please visit the URL provided by the workshop leader in the workshop Slack channel.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 5. How Platform Engineers Observe Kubernetes</h1><article class=default><h1 id=deploying-the-opentelemetry-collector-in-kubernetes-using-a-namespace>Deploying the OpenTelemetry Collector in Kubernetes using a NameSpace</h1><h2 id=1-new-kubernetes-navigator-20-ui>1. New Kubernetes Navigator 2.0 UI</h2><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation"></i> Note</div><div class=box-content><p>As the new Kubernetes Navigator is still in Preview, some steps of this workshop might not work as expected. If you encounter any issues, please do the following:</p><ul><li><p>Switch back to the old Kubernetes Navigator by clicking on the big blue
<span class="btn cstyle blue"><button type=button>
Switch to old navigator</button></span> button in the top right corner of the Kubernetes Navigator.</p></li><li><p>Let us know in the <strong>#tko-2023-o11y-session-5 channel</strong> in Slack.</p></li></ul></div></div><p>We will be starting this workshop using the new Kubernetes Navigator so please check that you are already using the new Navigator.</p><p>When you select <strong>Infrastructure</strong> from the main menu on the left, followed by selecting <strong>Kubernetes</strong>, you should see two services panes for Kubernetes, similar like the ones below:</p><p><a href=#image-8b97a0c0aec346c983ca7c6088897e85 class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/k8s-nav2-two.png alt=k8s-navi-v-2 style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8b97a0c0aec346c983ca7c6088897e85><img src=../tko/session-5/deploy-otel/../images/k8s-nav2-two.png alt=k8s-navi-v-2 class=lightbox-image loading=lazy></a></p><p>If you are taken straight to the Kubernetes Navigator v1 Map view after selecting <strong>Kubernetes</strong>, you need to opt-in to the new Navigator yourself for this workshop by clicking on the big blue
<span class="btn cstyle blue"><button type=button>
Switch to new navigator</button>
</span>.</p><p>You should now be in the K8s Node view with chart below the cluster map similar like shown below:</p><p><a href=#image-f22251e74594dd0497792c921a348e02 class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/new-k8s-view.png alt=k8s-navi-v-2 style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f22251e74594dd0497792c921a348e02><img src=../tko/session-5/deploy-otel/../images/new-k8s-view.png alt=k8s-navi-v-2 class=lightbox-image loading=lazy></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Note</div><div class=box-content><p>If you actually see three services for Kubernetes including one that is named <code>K8s clusters</code>, you need to turn off Precognition in the Superpowers view.
To do this, please change the Url in your browser to match the following: <a href=https://app.[REALM].signalfx.com/#/superpowers target=_blank>https://app.[REALM].signalfx.com/#/superpowers</a></p><p>where [REALM] needs to match the Realm we are using for this workshop then remove the Precognition flag like in the example below. This is one of the first options you can set:</p><p><a href=#image-907927a1fbef9768c0eb39d58b7ccb48 class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/precognition.png alt=Set-Precognition style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-907927a1fbef9768c0eb39d58b7ccb48><img src=../tko/session-5/deploy-otel/../images/precognition.png alt=Set-Precognition class=lightbox-image loading=lazy></a></p><p>Once its unset, you can refresh your page and reselect Kubernetes from the Infrastructure Navigator menu.</p></div></div><h2 id=2-connect-to-ec2-instance>2. Connect to EC2 instance</h2><p>You will be able to connect to the workshop instance by using SSH from your Mac, Linux or Windows device. Open the link to the sheet provided in the <strong>#tko-2023-o11y-session-5 channel</strong> in Slack. This sheet contains the IP addresses and the password for the workshop instances. Please</p><p>To use SSH, open a terminal on your system and type <code>ssh ubuntu@x.x.x.x</code> (replacing x.x.x.x with the IP address assigned to you). The password for this workshop is also provided in the sheet.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Note</div><div class=box-content><p>Your workshop instance has been pre-configured with the correct <code>ACCESS_TOKEN</code> and <code>REALM</code> for this workshop. There is no need for you to configure these.</p></div></div><h2 id=3-namespaces-in-kubernetes>3. Namespaces in Kubernetes</h2><p>Most of our customers will make use of some kind of private or public cloud service to run Kubernetes. They often choose to have only a few large Kubernetes clusters as it is easier to manage centrally.</p><p>Namespaces are a way to organize these large Kubernetes clusters into virtual sub-clusters. This can be helpful when different teams or projects share a Kubernetes cluster as this will give them the easy ability to just see and work with their own stuff.</p><p>Any number of namespaces are supported within a cluster, each logically separated from others but with the ability to communicate with each other. Components are only <strong>visible</strong> when selecting a namespace or when adding the <code>--all-namespaces</code> flag to <code>kubectl</code> instead of allowing you to view just the components relevant to your project by selecting your namespace.</p><p>Most customers will want to install the Splunk OpenTelemetry Collector in a separate namespace. This workshop will follow that practice.</p><h2 id=4-install-splunk-otel-using-helm>4. Install Splunk OTel using Helm</h2><p>Install the OpenTelemetry Collector using the Splunk Helm chart. First, add the Splunk Helm chart repository and update.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Repo Add" class="tab-nav-button active" onclick='switchTab("default","Helm Repo Add")'>
<span>Helm Repo Add</span></button>
<button data-tab-item="Helm Repo Add Output" class=tab-nav-button onclick='switchTab("default","Helm Repo Add Output")'>
<span>Helm Repo Add Output</span></button></div><div class=tab-content><div data-tab-item="Helm Repo Add" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update
</span></span></code></pre></div></div><div data-tab-item="Helm Repo Add Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>Hang tight while we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span class=line><span class=cl>Update Complete. ⎈Happy Helming!⎈
</span></span></code></pre></div></div></div></div><p>Install the OpenTelemetry Collector Helm chart into the <code>splunk</code> namespace with the following commands, do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Install" class="tab-nav-button active" onclick='switchTab("default","Helm Install")'>
<span>Helm Install</span></button></div><div class=tab-content><div data-tab-item="Helm Install" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=k>$(</span>hostname<span class=k>)</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.logsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--namespace splunk <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--create-namespace <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/splunk-defaults.yaml
</span></span></code></pre></div></div></div></div><h2 id=5-verify-deployment>5. Verify Deployment</h2><p>You can monitor the progress of the deployment by running <code>kubectl get pods</code> and adding <code>-n splunk</code> to the command to see the pods in the <code>splunk</code> namespace which should typically report that the new pods are up and running after about 30 seconds.</p><p>Ensure the status is reported as <strong>Running</strong> before continuing.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get pods" class="tab-nav-button active" onclick='switchTab("default","kubectl get pods")'>
<span>kubectl get pods</span></button>
<button data-tab-item="kubectl get pods Output" class=tab-nav-button onclick='switchTab("default","kubectl get pods Output")'>
<span>kubectl get pods Output</span></button></div><div class=tab-content><div data-tab-item="kubectl get pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods -n splunk
</span></span></code></pre></div></div><div data-tab-item="kubectl get pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-pvstb                             2/2     Running   0          19s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6c454894f8-mqs8n   1/1     Running   0          19s
</span></span></code></pre></div></div></div></div><p>Use the label set by the <code>helm</code> install to tail logs (You will need to press <code>ctrl + c</code> to exit).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl logs" class="tab-nav-button active" onclick='switchTab("default","kubectl logs")'>
<span>kubectl logs</span></button></div><div class=tab-content><div data-tab-item="kubectl logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector -n splunk
</span></span></code></pre></div></div></div></div><p>Or use the installed <code>k9s</code> terminal UI.</p><p><a href=#image-495861006a3495f2a10506c3c69c19ce class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/k9s.png alt=k9s style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-495861006a3495f2a10506c3c69c19ce><img src=../tko/session-5/deploy-otel/../images/k9s.png alt=k9s class=lightbox-image loading=lazy></a></p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Deleting a failed installation</div><div class=box-content><p>If you make an error installing the Splunk OpenTelemetry Collector you can start over by deleting the installation using:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm delete splunk-otel-collector -n splunk
</span></span></code></pre></div></div></div><footer class=footline></footer></article><article class=default><h1 id=tour-of-the-kubernetes-navigator-v2>Tour of the Kubernetes Navigator v2</h1><h2 id=1-cluster-vs-workload-view>1. Cluster vs Workload View</h2><p>The Kubernetes Navigator offers you two separate use cases to view your Kubernetes data.</p><ul><li>The <strong>K8s workloads</strong> is focusing on providing information in regards to workloads a.k.a. <em>your deployments</em>.</li><li>The <strong>K8s nodes</strong> is focusing on providing insight into the performance of clusters, Nodes, Pods & Containers.</li></ul><p>You initially select either view depending on your need (you can switch between the view on the fly if required). The most common one we will use in this workshop is the workload view and we will focus on that specifically.</p><h3 id=11-finding-your-k8s-cluster-name>1.1 Finding your K8s Cluster name</h3><p>Your first task is to identify and find your own cluster. The cluster will be named after your EC2 instance name.</p><p>To confirm your EC2 instance name, look at the prompt of your EC2 instance. For example, if you are assigned the 7th EC2 instance, the prompt will show:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ubuntu@emea-ws-7 ~ $
</span></span></code></pre></div><p>This means your cluster is named: <code>emea-ws-7-k3s-cluster</code>. Please make a note of your cluster name as you will need this later in the workshop for filtering.</p><h2 id=2-workloads--workload-details-pane>2. Workloads & Workload Details Pane</h2><p>Go to the <strong>Infrastructure</strong> menu item in the Observability UI and select <strong>Kubernetes</strong>. Go to the <strong>Infrastructure</strong> page in the Observability UI and select <strong>Kubernetes</strong>, this will offer you a set of Kubernetes services, one of them being the <strong>K8s workloads</strong> pane.</p><p>The pane will show a tiny graph giving you a bird&rsquo;s eye view of the load being handled across those Workloads. Also, if there are any alerts for one of the workloads, you will see a small alert indicator as shown in the image above.</p><p><a href=#image-5d40ed9493a5aae3cddf01773df8bcc3 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/K8s-Workloads.png alt=k8sWorkloads style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5d40ed9493a5aae3cddf01773df8bcc3><img src=../tko/session-5/check-new-navigator-short/../images/K8s-Workloads.png alt=k8sWorkloads class=lightbox-image loading=lazy></a></p><p>Click on the <strong>K8s workloads</strong> pane and you will be taken to the workload view.</p><p>Initially, you will see all the workloads that are reported by your clusters into your Observability Cloud Org. If an alert has fired for any of the workloads, it will be highlighted on the top right <em>as marked with a red stripe</em> in the image below. You can go directly to the alert by clicking it to expand it.</p><p><a href=#image-8f452ab3754529121396bbe1cc831f41 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-screen.png alt=Workloads style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8f452ab3754529121396bbe1cc831f41><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-screen.png alt=Workloads class=lightbox-image loading=lazy></a></p><p>Now, let&rsquo;s find your own cluster by filtering on the field <code>k8s.cluster.name</code> in the filter toolbar, <em>as marked with a blue stripe</em>. Note: you can enter a partial name into the search box, such as &rsquo;emea-ws-7*&rsquo;, to quickly find your Cluster. Also it&rsquo;s a very good idea to switch the default time from the default <strong>-3h</strong> back to last 15 minutes (<strong>-15m</strong>).</p><p>You should now just see information for your own cluster.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many workloads are running & how many namespaces are in your Cluster?</p></div></div><h3 id=21-using-the-navigator-selection-chart>2.1 Using the Navigator Selection chart</h3><p>The <strong>K8s workloads</strong> table is a common feature used across most of the Navigator&rsquo;s and will offer you a list view of the data you are viewing. In our case, it shows a list of <code>Pods Failed</code> grouped by <code>k8s.namespace.name</code>.</p><p>You will find this pane used in various Navigators in this workshop (ex: Workloads & Apache Servers). The way the selection pane works is similar across the Navigators in that the information shown will match the selection criteria in your filters.</p><p><a href=#image-08bffa1b7ca8f37f54f8b5c627525025 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/workload-selection.png alt=k8s-workload-list style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-08bffa1b7ca8f37f54f8b5c627525025><img src=../tko/session-5/check-new-navigator-short/../images/workload-selection.png alt=k8s-workload-list class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s change the list view to a heat map view by selecting either the Heat map icon or List icon in the upper-right corner of the screen <em>(as marked with a purple line)</em>.</p><p>Changing this option will result in the following representation, which is one we will use most of the time in this workshop:</p><p><a href=#image-f3ddbcd01166ac3a90bd6def26332d22 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/heatmap.png alt=k8s-Heat-map style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f3ddbcd01166ac3a90bd6def26332d22><img src=../tko/session-5/check-new-navigator-short/../images/heatmap.png alt=k8s-Heat-map class=lightbox-image loading=lazy></a></p><p>In this view, you will note that each workload is now a colored rectangle. These rectangles change color according to the <strong>Color by</strong> option you selected, <em>as marked by a green line</em> above. The colors give a visual indication of health and/or usage. You can check the meaning by hovering over the <strong>legend</strong> exclamation icon
<i class="fa-fw fas fa-exclamation-circle"></i>
bottom right of the heatmaps.</p><p>Another valuable option in this screen is <strong>Find Outliers</strong> which provides historical analytics of your clusters based on what is selected in the <strong>Color by</strong> dropdown.</p><p>Now, let&rsquo;s select the <strong>File system usage (bytes)</strong> from the <strong>Color by</strong> drop down box, <em>as marked with a green line</em> then click on the <strong>Find outliers</strong> drop down <em>as marked by a yellow stripe</em> in the above image and make sure you change the Strategy in the dialog to <strong>Deviation from Median</strong> as below:</p><p><a href=#image-1eb67ac4725f396d88639f414fc48449 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/set-find-outliers.png alt=k8s-Heat-map style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1eb67ac4725f396d88639f414fc48449><img src=../tko/session-5/check-new-navigator-short/../images/set-find-outliers.png alt=k8s-Heat-map class=lightbox-image loading=lazy></a></p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What happened to the Heatmap?</p></div></div><p>The <strong>Find outliers</strong> view is very useful when you need to view a selection of your workloads (or any service depending on the Navigator used) and quickly need to figure out if something has changed.</p><p>It will give you fast insight into items (workloads in our case) that are performing differently (both increased or decreased) which helps to make it easier to spot problems.</p><p>Now switch the <strong>Find Outliers</strong> option back to off.</p><h3 id=22-the-workload-overview-pane>2.2 The Workload Overview pane</h3><p>The workload overview gives you a quick insight of the status of your deployment. You can see at once if the pods of your deployments are Pending, Running, Failed, Succeeded or in an unknown state.</p><p><a href=#image-6d299f1d3ab2d440509ecfbebc07c5e4 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-overview.png alt=k8s-workload-overview style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-6d299f1d3ab2d440509ecfbebc07c5e4><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-overview.png alt=k8s-workload-overview class=lightbox-image loading=lazy></a></p><ul><li><em>Running:</em> Pods are deployed and in a running state</li><li><em>Pending:</em> Waiting to be deployed</li><li><em>Succeeded:</em> Pod has been deployed and completed its job and is finished</li><li><em>Failed:</em> Containers in the pod have run and returned some kind of error</li><li><em>Unknown:</em> Kubernetes isn&rsquo;t reporting any of the known states. (This may be during start or stopping of pods, for example).</li></ul><p>You can expand the Workload name by hovering your mouse on it, in case the name is longer than the chart allows.</p><p><a href=#image-8d9e02ddbc5efda487c75edb8068424f class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-hoover.png alt=k8s-workload-hoover style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8d9e02ddbc5efda487c75edb8068424f><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-hoover.png alt=k8s-workload-hoover class=lightbox-image loading=lazy></a></p><p>To filter to a specific workload, you can click on three dots <code>...</code> next to the workload name in the <strong>k8s.workload.name</strong> column and choose <strong>Filter</strong> from the dropdown box.</p><p><a href=#image-600d6ce657fe738f80d65f2cdebc0177 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/workload-add-filter.png alt=workload-add-filter style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-600d6ce657fe738f80d65f2cdebc0177><img src=../tko/session-5/check-new-navigator-short/../images/workload-add-filter.png alt=workload-add-filter class=lightbox-image loading=lazy></a></p><p>This will add the selected workload to your filters. Try this for the <strong>splunk-otel-collector-k8s-cluster-receiver</strong> workload. It should give you a single rectangle in the <code>splunk</code> namespace.</p><p>Confirm that you have the right filter by hovering over the rectangle, and if it is indeed the <strong>splunk-otel-collector-k8s-cluster-receiver</strong> workload, by double-clicking on it. This brings you to a more detailed view of your workload.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What are the CPU request & CPU limit units for the otel-collector?</p></div></div><p>At this point you can drill into the information of the pods, but that is outside the scope of this workshop, for now reset your view by removing the filter for the <strong>splunk-otel-collector-k8s-cluster-receiver</strong> workload and setting the <strong>Color by</strong> option to <strong>Pods Running</strong>.</p><h2 id=3-pivot-sidebar>3. Pivot Sidebar</h2><p>Later in the workshop, you will deploy an Apache server into your cluster which will create a new icon in the <strong>Pivot Sidebar</strong>.</p><p>As soon as any metric that is used by a Navigator, is flowing into your Observability org, the system will add that service to the Pivot Sidebar.</p><p>The Pivot Sidebar will expand and a link to the discovered service will be added as seen in the image below:</p><p><a href=#image-0441825812b215c7c512f862531ceb79 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/pivotbar.png alt=pivotbar style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0441825812b215c7c512f862531ceb79><img src=../tko/session-5/check-new-navigator-short/../images/pivotbar.png alt=pivotbar class=lightbox-image loading=lazy></a></p><p>This will allow for easy switching between Navigators. The same applies for your Apache server instance, it will have a Pivot Sidebar allowing you to quickly jump back to the Kubernetes navigator.</p><footer class=footline></footer></article><article class=default><h1 id=deploying-phpapache>Deploying PHP/Apache</h1><h2 id=1--dns-and-services-in-kubernetes>1. DNS and Services in Kubernetes</h2><p>The Domain Name System (DNS) is a mechanism for linking various sorts of information with easy-to-remember names, such as IP addresses. Using a DNS system to translate request names into IP addresses makes it easy for end-users to reach their target domain name effortlessly.</p><p>Most Kubernetes clusters include an internal DNS service configured by default to offer a lightweight approach for service discovery. Even when Pods and Services are created, deleted, or shifted between nodes, built-in service discovery simplifies applications to identify and communicate with services on the Kubernetes clusters.</p><p>In short, the DNS system for Kubernetes will create a DNS entry for each Pod and Service. In general, a Pod has the following DNS resolution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>pod-name.my-namespace.pod.cluster-domain.example
</span></span></code></pre></div><p>For example, if a Pod in the <code>default</code> namespace has the Pod name <code>my_pod</code>, and the domain name for your cluster is <code>cluster.local</code>, then the Pod has a DNS name:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>my_pod.default.pod.cluster.local
</span></span></code></pre></div><p>Any Pods exposed by a Service have the following DNS resolution available:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>my_pod.service-name.my-namespace.svc.cluster-domain.example
</span></span></code></pre></div><p>More information can be found here : <a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/ target=_blank>DNS for Service and Pods</a></p><h2 id=2-review-otel-receiver-for-phpapache>2. Review OTel receiver for PHP/Apache</h2><p>Inspect the YAML file <code>~/workshop/k3s/otel-apache.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/otel-apache.yaml
</span></span></code></pre></div><p>This file contains the configuration for the OpenTelemetry agent to monitor the PHP/Apache deployment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receiver_creator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>smartagent/apache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>type == &#34;port&#34; &amp;&amp; pod.name matches &#34;apache&#34; &amp;&amp; port == 80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>collectd/apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://php-apache-svc.apache.svc.cluster.local/server-status?auto</span><span class=w>
</span></span></span></code></pre></div><h2 id=3--observation-rules-in-the-opentelemetry-config>3. Observation Rules in the OpenTelemetry config</h2><p>The above file contains an observation rule for Apache using the OTel <code>receiver_creator</code>. This receiver can instantiate other receivers at runtime based on whether observed endpoints match a configured rule.</p><p>The configured rules will be evaluated for each endpoint discovered. If the rule evaluates to true, then the receiver for that rule will be started as configured against the matched endpoint.</p><p>In the file above we tell the OpenTelemetry agent to look for Pods that match the name <code>apache</code> and have port <code>80</code> open. Once found, the agent will configure an Apache receiver to read Apache metrics from the configured URL. Note, the K8s DNS based URL in the above YAML for the service.</p><p>To use the Apache configuration, you can upgrade the existing Splunk OpenTelemetry Collector Helm chart to use the <code>otel-apache.yaml</code> file with the following command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Upgrade" class="tab-nav-button active" onclick='switchTab("default","Helm Upgrade")'>
<span>Helm Upgrade</span></button></div><div class=tab-content><div data-tab-item="Helm Upgrade" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=k>$(</span>hostname<span class=k>)</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.logsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--namespace splunk <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/splunk-defaults.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-apache.yaml
</span></span></code></pre></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> NOTE</div><div class=box-content><p>The <strong>REVISION</strong> number of the deployment has changed, which is a helpful way to keep track of your changes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Release &#34;splunk-otel-collector&#34; has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Tue Jan 31 16:57:22 2023
</span></span><span class=line><span class=cl>NAMESPACE: splunk
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: 2
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span></code></pre></div></div></div><h2 id=4-kubernetes-configmaps>4. Kubernetes ConfigMaps</h2><p>A ConfigMap is an object in Kubernetes consisting of key-value pairs which can be injected into your application. With a ConfigMap, you can separate configuration from your Pods.</p><p>Using ConfigMap, you can prevent hardcoding configuration data. ConfigMaps are useful for storing and sharing non-sensitive, unencrypted configuration information.</p><p>The OpenTelemetry collector/agent uses ConfigMaps to store the configuration of the agent and the K8s Cluster receiver. You can/will always verify the current configuration of an agent after a change by running the following commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm -n splunk
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many ConfigMaps are used by the collector?</p></div></div><p>When you have list of ConfigMaps from the namespace, select the one for the <code>otel-agent</code> and view it with the following command:</p><p><strong>Note:</strong> The option <code>-o yaml</code> will print the content of the ConfigMap in a YAML format.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm splunk-otel-collector-otel-agent -n splunk -o yaml
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Is the content of <code>otel-apache.yaml</code> saved in the ConfigMap for the collector agent?</p></div></div><h2 id=5-review-phpapache-deployment-yaml>5. Review PHP/Apache deployment YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/php-apache.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/php-apache.yaml
</span></span></code></pre></div><p>This file contains the configuration for the PHP/Apache deployment and will create a new StatefulSet with a single replica of the PHP/Apache image.</p><p>A stateless application is one that does not care which network it is using, and it does not need permanent storage. Examples of stateless apps may include web servers such as Apache, Nginx, or Tomcat.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;php-apache-svc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/splunk/php-apache:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;9Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache-svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span></code></pre></div><h2 id=6-deploy-phpapache>6. Deploy PHP/Apache</h2><p>Create an apache namespace then deploy the PHP/Apache application to the cluster.</p><p>Create the <code>apache</code> namespace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create namespace apache
</span></span></code></pre></div><p>Deploy the PHP/Apache application:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What metrics for your Apache instance are being reported in the Apache Navigator?</p><p><strong>Tip:</strong> Click on <strong>Infrastructure → Web Server → Apache web servers</strong> to go to the Navigator and look for a server with the same name as your EC2 host.</p></div></div><p>Ensure the deployment has been created:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get statefulset -n apache
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Using the Observability Kubernetes Navigator, can you find the status of the <code>php-apache</code> <strong>Workload</strong>?</p><p><strong>HINT:</strong> Filter by <code>k8s.cluster.name</code> to isolate your instance!</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Where else has the issue with <code>php-apache</code> been logged? What is being reported?</p><p><strong>HINT:</strong> Adjust your <strong>Table settings</strong> by clicking on the cog to use only <code>k8s.cluster.name</code>, <code>object.involvedObject.name</code> & <code>object.message</code>. Make sure you unselect <code>_raw</code>!</p></div></div><footer class=footline></footer></article><article class=default><h1 id=fix-phpapache-issue>Fix PHP/Apache Issue</h1><h2 id=1-kubernetes-resources>1. Kubernetes Resources</h2><p>Especially in Production Kubernetes Clusters, CPU and Memory are considered precious resources. Cluster Operators will normally require you to specify the amount of CPU and Memory your Pod or Service will require in the deployment, so they can have the Cluster automatically manage on which Node(s) your solution will be placed.</p><p>You do this by placing a Resource section in the deployment of you application/Pod</p><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>         </span><span class=c># Maximum amount of CPU &amp; memory for peek use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8&#34;</span><span class=w>      </span><span class=c># Maximum of 8 cores of CPU allowed at for peek use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;9Mi&#34;</span><span class=w> </span><span class=c># Maximum allowed 9Mb of memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>       </span><span class=c># Request are the expected amount of CPU &amp; memory for normal use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6&#34;</span><span class=w>      </span><span class=c># Requesting 4 cores of a CPU</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4Mi&#34;</span><span class=w> </span><span class=c># Requesting 4Mb of memory</span><span class=w>
</span></span></span></code></pre></div><p>More information can be found here : <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/ target=_blank>Resource Management for Pods and Containers</a></p><p>If your application or Pod will go over the limits set in your deployment, Kubernetes will kill and restart your Pod to protect the other applications on the Cluster.</p><p>Another scenario that you will run into is when there is not enough Memory or CPU on a Node. In that case, the Cluster will try to reschedule your Pod(s) on a different Node with more space.</p><p>If that fails, or if there is not enough space when you deploy your application, the Cluster will put your workload/deployment in schedule mode until there is enough room on any of the available Nodes to deploy the Pods according their limits.</p><h2 id=2-fix-phpapache-deployment>2. Fix PHP/Apache Deployment</h2><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Before we start, let&rsquo;s check the current status of the PHP/Apache deployment. Under <strong>Alerts & Detectors</strong> which <strong>[TKO]</strong> detector has fired? Where else can you find this information?</p></div></div><p>To fix the PHP/Apache StatefulSet, edit <code>~/workshop/k3s/php-apache.yaml</code> using the following commands to reduce the CPU resources:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim ~/workshop/k3s/php-apache.yaml
</span></span></code></pre></div><p>Find the resources section and reduce the CPU limits to <strong>1</strong> and the CPU requests to <strong>0.5</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;9Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4Mi&#34;</span><span class=w>
</span></span></span></code></pre></div><p>Save the changes youhave made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><p>Now, we must delete the existing StatefulSet and re-create it. StatefulSets are immutable, so we must delete the existing one and re-create it with the new changes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete statefulset php-apache -n apache
</span></span></code></pre></div><p>Now, deploy your changes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache
</span></span></code></pre></div><h2 id=3-validate-the-changes>3. Validate the changes</h2><p>You can validate the changes have been applied by running the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe statefulset php-apache -n apache
</span></span></code></pre></div><p>Validate the Pod is now running in Splunk Observability Cloud.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Is the <strong>Apache Web Servers</strong> dashboard showing any data now?</p><p><strong>Tip:</strong> Don&rsquo;t forget to use filters and time frames to narrow down your data.</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Another <strong>[TKO]</strong> Detector has fired, which one is it this time?</p></div></div><h2 id=4-fix-memory-issue>4. Fix memory issue</h2><p>If you navigate back to the Apache dashboard, you will notice that metrics are no longer coming in. We have another resource issue and this time we are Out of Memory. Let&rsquo;s edit the stateful set and increase the memory to what is shown in the image below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl edit statefulset php-apache -n apache
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>16Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>12Mi</span><span class=w>
</span></span></span></code></pre></div><p>Save the changes you have made.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-exclamation"></i> Hint</div><div class=box-content><p><code>kubectl edit</code> will open the contents in the <code>vi</code> editor, use <code>Esc</code> followed by <code>:wq!</code> to save your changes.</p></div></div><p>Because StatefulSets are immutable, we must delete the existing Pod and let the StatefulSet re-create it with the new changes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete pod php-apache-0 -n apache
</span></span></code></pre></div><p>Validate the changes have been applied by running the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe statefulset php-apache -n apache
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=deploy-load-generator>Deploy Load Generator</h1><p>Now let&rsquo;s see how the autoscaler reacts to increased load. To do this, you&rsquo;ll start a different Pod to act as a client. The container within the client Pod runs in an infinite loop, sending queries to the <code>php-apache</code> service.</p><h2 id=1-review-loadgen-yaml>1. Review loadgen YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/loadgen.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/loadgen.yaml
</span></span></code></pre></div><p>This file contains the configuration for the load generator and will create a new StatefulSet with a single replica of the load generator image.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;loadgen&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>infinite-calls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;while true; do wget -q -O- http://php-apache-svc.apache.svc.cluster.local; done&#34;</span><span class=w>
</span></span></span></code></pre></div><h2 id=2-create-a-new-namespace>2. Create a new namespace</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl create namespace loadgen
</span></span></code></pre></div><h2 id=3-deploy-the-loadgen-yaml>3. Deploy the loadgen YAML</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/loadgen.yaml --namespace loadgen
</span></span></code></pre></div><p>Once you have deployed the load generator, you can see the Pod running in the <code>loadgen</code> namespace. Use previous similar commands to check the status of the Pod from the command line.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What metrics in the Apache Dashboard have now significantly increased?</p></div></div><h2 id=4-scale-the-load-generator>4. Scale the load generator</h2><p>A ReplicaSet is a process that runs multiple instances of a Pod and keeps the specified number of Pods constant. Its purpose is to maintain the specified number of Pod instances running in a cluster at any given time to prevent users from losing access to their application when a Pod fails or is inaccessible.</p><p>ReplicaSet helps bring up a new instance of a Pod when the existing one fails, scale it up when the running instances are not up to the specified number, and scale down or delete Pods if another instance with the same label is created. A ReplicaSet ensures that a specified number of Pod replicas are running continuously and helps with load-balancing in case of an increase in resource usage.</p><p>Let&rsquo;s scale our ReplicaSet to 4 replicas using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl scale statefulset/loadgen --replicas 4 -n loadgen
</span></span></code></pre></div><p>Validate the replicas are running from both the command line and Splunk Observability Cloud:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl get statefulset loadgen -n loadgen
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What impact did this have? Where in O11y can you see the increased replica number?</p></div></div><p>Let the load generator run for around 2-3 minutes and keep observing the metrics in the Kubernetes Navigator and the Apache Navigator.</p><footer class=footline></footer></article><article class=default><h1 id=setup-horizontal-pod-autoscaling-hpa>Setup Horizontal Pod Autoscaling (HPA)</h1><p>In Kubernetes, a HorizontalPodAutoscaler automatically updates a workload resource (such as a Deployment or StatefulSet), with the aim of automatically scaling the workload to match demand.</p><p>Horizontal scaling means that the response to increased load is to deploy more Pods. This is different from vertical scaling, which for Kubernetes would mean assigning more resources (for example: memory or CPU) to the Pods that are already running for the workload.</p><p>If the load decreases, and the number of Pods is above the configured minimum, the HorizontalPodAutoscaler instructs the workload resource (the Deployment, StatefulSet, or other similar resource) to scale back down.</p><h2 id=1-setup-hpa>1. Setup HPA</h2><p>Inspect the <code>~/workshop/k3s/hpa.yaml</code> file and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/hpa.yaml
</span></span></code></pre></div><p>This file contains the configuration for the Horizontal Pod Autoscaler and will create a new HPA for the <code>php-apache</code> deployment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span></code></pre></div><p>Once deployed, <code>php-apache</code> will autoscale when either the average CPU usage goes above 50% and average memory usage for the deployment goes above 75%, with a minimum of 1 pod and a maximum of 4 pods.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/hpa.yaml
</span></span></code></pre></div><h2 id=2-validate-hpa>2. Validate HPA</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl get hpa -n apache
</span></span></code></pre></div><p>Go to the <strong>Workloads</strong> or <strong>Node Detail</strong> tab in Kubernetes and check the HPA deployment.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many additional <code>php-apache-x</code> pods have been created?</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Which metrics in the Apache Dashboards have significantly increased again?</p></div></div><h2 id=3-increase-the-hpa-replica-count>3. Increase the HPA replica count</h2><p>Increase the <code>maxReplicas</code> to 8</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl edit hpa php-apache -n apache
</span></span></code></pre></div><p>Save the changes youhave made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many pods are now in a running state? How many are pending? Why are they pending?</p></div></div><p><strong>Congratulations!</strong> You have successfully completed the workshop.</p><footer class=footline></footer></article></section><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka !</p><p>Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p><p>We now have a total of 6 locations !</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 6. O11y - Distributed Tracing for modern applications</h1><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><h2 id=ec2-access>EC2 Access</h2><p>Select an ec2 on the Spreadsheet provided</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh ubuntu@your.ec2.ip.address
</span></span></code></pre></div><p>For the rest of the lab we are going to be assuming you are starting from the project&rsquo;s root directory.</p><p>Let&rsquo;s go there now:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/javashop-otel-TKO-23
</span></span></code></pre></div><h2 id=set-environment-variables>Set Environment Variables</h2><ul><li>Using nano edit the <code>.env</code> file.<ul><li><strong>Important Note</strong>: Do not put any spaces in your name</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano .env
</span></span></code></pre></div><ul><li>Set the following values:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>SHOP_USER</span><span class=o>=</span><span class=s>&lt;your_name&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>SPLUNK_ACCESS_TOKEN</span><span class=o>=</span><span class=s>&lt;your_token&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>SPLUNK_REALM</span><span class=o>=</span><span class=s>&lt;your_realm&gt;</span>
</span></span></code></pre></div><ul><li>Save in nano with <code>[CTRL]-o</code> <strong>[ENTER]</strong></li><li>Exit nano with <code>[CTRL]-x</code></li></ul><h2 id=build-and-deploy-application>Build and Deploy Application</h2><p>Let&rsquo;s get started by building and deploying our Application, the Buttercup Instrument Shop. Run the commands below to begin and start reading ahead as your traces are coming up !</p><ul><li>Build the app</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh
</span></span></code></pre></div><h2 id=users-and-workflows>Users and Workflows</h2><p>As we go through this workshop we will be switching roles from SRE to Developer. First we will start with alert responders or SREs who will identify an issue in Splunk Observability UI. Next, we will jump to a Developer Role to see how a Developer will debug and repair/fix a software problem using trace data provided by our SRE.</p><p>Of course, we are not requiring 2 people for this workshop as each participant will play both roles.</p><h2 id=today-we-will-learn>Today we will learn</h2><p>Today we will learn the type of data ( In the form of a trace ) that an SRE or alert responder would send to a developer to then repair/fix software. We will do this with both Auto-Instrumentation data and Custom attributes, via Manual Instrumentation data.</p><p>While we will be spending time Debugging code, &mldr;. Don&rsquo;t worry, &mldr;there is no programming experience necessary, as our goal here is for everyone in the audience to understand how using Custom Attributes in Splunk APM @ Full Fidelity can accelerate Mean Time to Repair Software problems for our customers.</p><p>Translated, Developers are High Cost resources, with high opportunity cost. Less time on fixing problems = more time for features.</p><h2 id=lets-define-a-few-terms-for-those-new-to-apm--software-development-or-java>Let&rsquo;s define a few terms for those new to APM / Software Development or Java</h2><ol><li><strong>What is a Function in Java?</strong>
A Function in most languages includeing Java, is a logical chunk of code when executed solves a repeatable task. This is basically what our customers Dev teams spend thier time building and where software issues will most commonly be.</li><li><strong>What is a Method in Java?</strong>
See What&rsquo;s a function -> Function and method are synonomous.</li><li><strong>What is an Exception in Java?</strong>
An Exceptional error condition that indicates abonormal or unhandled condition, that interrupts program execution abnormally.</li></ol><h2 id=view-service-map>View Service Map</h2><p>Please note it may take 3-4 minutes for traces to show up and you will see full map &ldquo;form&rdquo; as traces are coming in, so you may have to refresh the page a few times each time we Build and Deploy.</p><p>It is recommended to use a -15m look back during this lab. You may need to change it from time to time (for example to -5m or a custom -10m) to make sure you are only looking at the newer traces after your changes.</p><p><a href=#image-22e1e49a3efd2f411ae6c51d3e07c875 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/219972238-36a91449-119b-4ce9-ba3c-d5ea354a8aeb.png alt="Screen Shot 2023-02-14 at 8 25 19 PM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-22e1e49a3efd2f411ae6c51d3e07c875><img src=https://user-images.githubusercontent.com/32849847/219972238-36a91449-119b-4ce9-ba3c-d5ea354a8aeb.png alt="Screen Shot 2023-02-14 at 8 25 19 PM" class=lightbox-image loading=lazy></a></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>NOTE: Typically, to identify root cause and route an issue, an SRE or alert responder would check metrics and logs to determine if it is a software or hardware related issue, and thus route to the correct party. In this excercise we are ONLY handling software issues, so we are skipping the metrics and logs parts of normal triage.</p></div></div><p>If your instrumentation was successful, the service-map will show latency from the shop service to the products service.</p><p><a href=#image-da2e18d569f3c2d5dde5c631f72e7c17 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-da2e18d569f3c2d5dde5c631f72e7c17><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>Ok let&rsquo;s triage this SOFTWARE ISSUE and skip directly to the traces.</p><ul><li>Click on <code>shop</code> service</li><li>Click <strong>Traces</strong> ( on the right side )</li><li>Sort by Duration</li><li>Select the longest duration trace ( or one of the obvious much longer ones )</li></ul><p><a href=#image-4c54e9d41fb8b065e9c63a3cb7ba0d86 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4c54e9d41fb8b065e9c63a3cb7ba0d86><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace class=lightbox-image loading=lazy></a></p><p>Now we can see the long latency occurred in the products service and if we click on products: /products we can see the offending method was products:ProductResource.getAllProducts
÷≥«</p><p><a href=#image-e33e9b31e8857ece42995d0070799970 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e33e9b31e8857ece42995d0070799970><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts class=lightbox-image loading=lazy></a></p><p>Our next step here would be to send that trace to a developer by clicking download trace and
they will have to debug the function. Since we will be the developer there is no need to download the trace. Just remember that is normal workflow for alert responders to route an issue to the &ldquo;Repairers&rdquo; while providing trace data.</p><p>Before we do that please take note of the Tags available for the developer to leverage to find root cause. We see standard out of the box Otel tags on the span, environmental information, but no indcations of data specific to something inside custom code ( which is where the problem always is. )</p><h2 id=now-lets-play-the-role-of-the-developer>Now let&rsquo;s play the role of the developer</h2><p>As a developer we must debug the function products:ProductResource.getAllProducts to find the problem.</p><h2 id=debugging-101-the-line-by-line-method>Debugging 101, the Line by Line method</h2><p>Without anything to go on other than &ldquo;BAD FUNCTION&rdquo;, a Developer must then look at code visually line by line to find and fix the problem. To make this worse, Functions, call Functions and it can get very messy in bad code scenarios.</p><p>We will do the visual inspection mehtod next.</p><ul><li>Using Nano:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><ul><li>Search in Nano: <code>[CTRL]-w</code></li><li>Enter in: <code>getAllProducts</code> <strong>[Enter]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>  <span class=nd>@GET</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Response</span> <span class=nf>getAllProducts</span><span class=o>(</span><span class=nd>@DefaultValue</span><span class=o>(</span><span class=s>&#34;California&#34;</span><span class=o>)</span> <span class=nd>@QueryParam</span><span class=o>(</span><span class=s>&#34;location&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>location</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// STEP X: All we know right now is somewhere in this function, latency was introduced.
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>      <span class=n>myCoolFunction1</span><span class=o>(</span><span class=n>location</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>myCoolFunction2</span><span class=o>(</span><span class=n>location</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>myCoolFunction10</span><span class=o>(</span><span class=n>location</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>myCoolFunction13</span><span class=o>(</span><span class=n>location</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>myCoolFunction5</span><span class=o>(</span><span class=n>location</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>myCoolFunction6</span><span class=o>(</span><span class=n>location</span><span class=o>);</span>
</span></span></code></pre></div><p>We can see here in getAllProducts, the first call is to <code>myCoolFunction1()</code>, so as may have guessed our next step is to go look at <code>myCoolFunction1()</code>.</p><ul><li>Search in Nano: <code>[CTRL]-w</code></li><li>Enter in: <code>myCoolFunction1</code> <strong>[Enter]</strong></li><li>Find the next occurrence: <code>[CTRL]-w</code> <strong>[Enter]</strong></li><li>Keep repeating <code>[CTRL]-w</code> <strong>[Enter]</strong> until you get to the actual function definition</li></ul><p>It looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>myCoolFunction1</span><span class=o>(</span><span class=n>String</span> <span class=n>location</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Generate a FAST sleep of 0 time !
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kt>int</span> <span class=n>sleepy</span> <span class=o>=</span> <span class=n>lookupLocation1</span><span class=o>(</span><span class=n>location</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span><span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>sleepy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><p>Now, <code>myCoolFunction1</code> calls <code>lookupLocation1(location)</code></p><ul><li>Search in Nano: <code>[CTRL]-w</code></li><li>Enter in: <code>lookupLocation1</code> <strong>[Enter]</strong></li></ul><p>I think you get the picture by now, you have no choice but to inspect every line of code and every function called and visually inspect them for problems. This can be a VERY long process and kills our customers Mean Time to Repair. This happens quite often to our customers with our competition beacsue they can&rsquo;t provide all the traces 100% of the time and most can&rsquo;t scale to add more data, via Custom Attributes on top of that!</p><p>Remember, without Full Fidelty, you have to either reproduce errors / latency in another environment or inspect code line by line.</p><p>So they are stuck where we are, quite often.</p><p>OK, enough fun ..let&rsquo;s make this easier for our developer&mldr; and show off some Splunk APM Scale!</p><p>Ok exit your editor:</p><ul><li>Exit nano: <code>[CTRL]-X</code><ul><li><strong>Optional</strong>: If it asks you to save, hit <code>N</code></li></ul></li></ul><h2 id=custom-attribution>Custom Attribution</h2><p>To take a deeper look at this issue and make this much easier to debug we will implement Custom Attributes via Opentelemetry Manual Instrumentation.</p><p>To speed up manual instrumentation in Java you can leverage <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a>, which automatically create a span around a method without modifying the actual code inside the method. This can be very valuable if you are working with an SRE that may have limited access to source code changes.</p><p>To add even more information to help our developers find the root cause faster,
<a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> can be used to generate span tags with parameter values for the method in question. This is incredibly important to mean time to Repair, because as a Developer, if I know the parameter values of a function at the time of latency or error, I can debug this without having to reproduce an issue in another environment if I have Full Fidelity Tracing.</p><p>Splunk Full Fidelity APM allows our customers development teams to debug their code as it ran in production, 100% of the time . Add with Custom Attribution, you are providing repeatable Mean Time to Repair reduction&mldr; 100% of the time, only with Full Fidelity tracing.</p><p>To expedite manual instrumentation implementation for this exercise, we have provided a tool which will annotate the entirety of the &ldquo;shop&rdquo; and &ldquo;products&rdquo; services with OpenTelemetry standard annotations for every function call without having to write any code. This &ldquo;annotator&rdquo; tool will also tag every parameter in every function, which adds a span tag with <code>Parameter=Value</code>.</p><h2 id=run-manual-instrumentation-tool>Run Manual Instrumentation Tool</h2><ul><li>Run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./AutomateManualInstrumentation.sh
</span></span></code></pre></div><h2 id=rebuild-and-deploy-application>Rebuild and Deploy Application</h2><ul><li>Run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>Go back to the Splunk Observability UI and let&rsquo;s see if these annotations help us narrow down the root cause more quickly.</p><p>Let&rsquo;s try to find our latency root cause again, this time with every function and every parameter spanned and tagged respectively&mldr;. You will see exactly what this means and how it benefits developers in a moment&mldr;</p><p><a href=#image-bfde73b4a7308ef5b3ab232f56120fbb class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-bfde73b4a7308ef5b3ab232f56120fbb><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><ul><li>Click on <code>shop</code> service</li><li>Click <strong>Traces</strong> ( on the right side )</li><li>Sort by Duration</li><li>Select the longest duration trace ( or one of the obvious much longer ones )</li></ul><p><a href=#image-41cd14ecd070689239f40c9b98751f83 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/219955286-f55cfc0e-3936-45be-ac95-3c4b547f2007.png alt=213582624-66466a19-00fa-4dda-acd0-f6970d594ba1 style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-41cd14ecd070689239f40c9b98751f83><img src=https://user-images.githubusercontent.com/32849847/219955286-f55cfc0e-3936-45be-ac95-3c4b547f2007.png alt=213582624-66466a19-00fa-4dda-acd0-f6970d594ba1 class=lightbox-image loading=lazy></a></p><p>We can see that the actual function call that has the latency was not ProductResource.getAllProducts but the function call &ldquo;ProductResource.myCoolFunction234234234&rdquo; !</p><p>Since we now have the parameter tagged as part of our span metadata the actual root cause is seemingly related to the &ldquo;location&rdquo; Colorado ! And it appears the one custom attribute that was tagged for function &ldquo;ProductResource.myCoolFunction234234234&rdquo; was &ldquo;myInt&rdquo; with a value of 999. With this information a Developer can debug very quickly.</p><p>NOTE: We added additional span information, which we call &ldquo;Custom Attributes&rdquo; here at Splunk, in this case our &ldquo;Custom Attributes&rdquo; are &ldquo;Parameter Values at Time of Latency&rdquo;.</p><p>In our exmaple the &ldquo;myInt&rdquo; tag was created due our handy Annotator, that did the <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> for us.</p><ul><li>Using nano:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><ul><li>Search in Nano: <code>[CTRL]-w</code></li><li>Enter in: <code>999</code> <strong>[Enter]</strong></li></ul><p>We can see here, someone wrote some very bad code in the form of a long Sleep!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=mi>999</span><span class=o>==</span><span class=n>myInt</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=n>sleepy</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=mi>5000</span> <span class=o>-</span> <span class=mi>3000</span><span class=o>)</span> <span class=o>+</span> <span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span></code></pre></div><p>How did we get here ? How did the 999 end up in the trace as a Custom Attribute ?</p><p>Take a look at the function signature</p><p><code>private void myCoolFunction234234234(@SpanAttribute("myInt") int myInt)</code></p><p><code>@SpanAttribute("myint")</code> is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> that was added by our Java Otel Annotator tool.</p><p>Let&rsquo;s fix our code.</p><ul><li>Change this:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>myCoolFunction234234234</span><span class=o>(</span><span class=nd>@SpanAttribute</span><span class=o>(</span><span class=s>&#34;myInt&#34;</span><span class=o>)</span> <span class=kt>int</span> <span class=n>myInt</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Generate a FAST sleep of 0 time !
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Random</span> <span class=n>sleepy</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=mi>999</span><span class=o>==</span><span class=n>myInt</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span>
</span></span><span class=line><span class=cl><span class=n>sleepy</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=mi>5000</span> <span class=o>-</span> <span class=mi>3000</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>){</span>
</span></span></code></pre></div><p>to this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>myCoolFunction234234234</span><span class=o>(</span><span class=nd>@SpanAttribute</span><span class=o>(</span><span class=s>&#34;myInt&#34;</span><span class=o>)</span> <span class=kt>int</span> <span class=n>myInt</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Generate a FAST sleep of 0 time !
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Random</span> <span class=n>sleepy</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=c1>// if (999==myInt)
</span></span></span><span class=line><span class=cl><span class=c1>// Thread.sleep(
</span></span></span><span class=line><span class=cl><span class=c1>// sleepy.nextInt(5000 - 3000)
</span></span></span><span class=line><span class=cl><span class=c1>// + 3000);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>){</span>
</span></span></code></pre></div><p>which is basically placing comments (<code>//</code>) before the lines in <code>myCoolFunction234234234</code> that are causing the slowness:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// if (999==myInt)
</span></span></span><span class=line><span class=cl><span class=c1>// Thread.sleep(
</span></span></span><span class=line><span class=cl><span class=c1>// sleepy.nextInt(5000 - 3000)
</span></span></span><span class=line><span class=cl><span class=c1>// + 3000);
</span></span></span></code></pre></div><ul><li>Save the changes: <code>[CTRL]-o</code> <strong>[Enter]</strong></li><li>Exit: <code>[CTRL]-x</code></li></ul><p><strong>Important Note</strong>: Until we rebuild and restart our application this change isn&rsquo;t implemented.</p><p>Let&rsquo;s go see if our manual instrumentation uncovered any other issues we did not see before</p><p>So you may be asking yourself: <strong>&ldquo;How does manual instrumentation alone show us &ldquo;more problems&rdquo; than before? Latency is latency, isn&rsquo;t it?&rdquo;</strong></p><p>The answer is with auto-instrumentation you are in most situations NOT covering functions our customers&rsquo; development teams wrote, which is of course the bulk of what developers do. They write functions&mldr;. and of course this is where the bulk of software problems occur.</p><p>You may have noticed a new exception in our trace that was not present with Auto-Instrumentation during our latency fix use-case. Since we skipped over this, let&rsquo;s walk you through it.</p><ul><li>Return to the service map</li><li>Click on <code>shop</code> service</li><li>Click <strong>Traces</strong> ( on the right side )</li><li>Click <strong>Errors Only</strong></li></ul><p><a href=#image-8237edc2d457f62d6efa3e3b647fcb86 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8237edc2d457f62d6efa3e3b647fcb86><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" class=lightbox-image loading=lazy></a></p><p><strong>Important Note</strong>: We haven&rsquo;t changed the code at all by adding annotations.</p><ul><li>Click on a trace with an error present</li></ul><p><a href=#image-958a69c508ab58d79afa853bced1a5f2 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-958a69c508ab58d79afa853bced1a5f2><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" class=lightbox-image loading=lazy></a></p><p>We can see our Exception is <code>InvalidLocaleException</code>.</p><p>The real problem must be related to the new data associated with <strong>Sri Lanka</strong> as the Exception says <code>"Non English Characters found in Instrument Data"</code>.</p><p>This exception had not surfaced in previous traces based on ONLY Auto-Instrumentation because the method where it was thrown was NOT covered with Auto-Instrumentation.</p><p>Once we completed the Manual Instrumentation via the Otel Annotator, this method was instrumented and we can now see we had a buried Exception being thrown.</p><h2 id=lets-play-developer-once-again-and-fix-our-issue>Let&rsquo;s play Developer once again and fix our issue</h2><p>We already know exactly what file to look in and what method to look at as it is called out in the trace.</p><p><a href=#image-0d0eb587e861a04b64fc89e5ac38a037 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0d0eb587e861a04b64fc89e5ac38a037><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" class=lightbox-image loading=lazy></a></p><ul><li>Using nano:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java
</span></span></code></pre></div><ul><li>Search in Nano: <code>[CTRL]-w</code></li><li>Enter in: <code>buildForLocale</code> <strong>[Enter]</strong></li></ul><p>Look just above the <code>buildForLocale</code> function, notice the Annotation <code>@WithSpan</code>? <code>@WithSpan</code> is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> for Java that automatically generates a span around a the function that follows.</p><p><a href=#image-92af6799a8cd7fd25f5858bc26017a7b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-92af6799a8cd7fd25f5858bc26017a7b><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s fix this code. We are going to simply comment this out for now and see if it fixes our latency issue.</p><ul><li>Place comments in front of the entire if statement as follows:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(!</span><span class=n>isEnglish</span><span class=o>(</span><span class=n>title</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidLocaleException</span><span class=o>(</span><span class=s>&#34;Non English Characters found in Instrument Data&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl> <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Characters OK &#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// if (!isEnglish(title)) {
</span></span></span><span class=line><span class=cl><span class=c1>//   throw new InvalidLocaleException(&#34;Non English Characters found in Instrument Data&#34;);
</span></span></span><span class=line><span class=cl><span class=c1>// } else {
</span></span></span><span class=line><span class=cl><span class=c1>//   System.out.println(&#34;Characters OK &#34;);
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span></code></pre></div><ul><li>Save the changes: <code>[CTRL]-o</code> <strong>[Enter]</strong></li><li>Exit: <code>[CTRL]-x</code></li></ul><p>Make sure you saved your changes to shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java</p><h2 id=rebuild-and-deploy-application-1>Rebuild and Deploy Application</h2><ul><li>Run</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh
</span></span></code></pre></div><p>We are waiting a few minutes . . .</p><ul><li>Return to the service map</li></ul><p>If you do NOT see RED in your service map, you have completed the Latency Repair for the Colorado Location!</p><p>Now let&rsquo;s check for our exception in the traces.</p><ul><li>Click on <code>shop</code> service</li><li>Click <strong>Traces</strong> ( on the right side )</li><li>Click <strong>Errors Only</strong></li></ul><p>If you do not have red in your service map and you do not see Errors in traces, you have successfully completed our Inventory application review for Sri Lanka and Colorado locations!!! Well done!</p><h2 id=we-are-nearly-done-one-more-location-to-go-chicago>We are nearly done, one more location to go&mldr; Chicago</h2><p>Last, but not least, let&rsquo;s ensure Chicago was on-boarded correctly. However, since we have been having so many issues related to &ldquo;location&rdquo; and we have added that custom attribute via Opentelemetry Manual Instrumentation, lets go to the Splunk Observability UI and look at an APM metric set around that tag that I created for us.</p><p><a href=#image-20357b3c048682ad933c8baf8cae3adc class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-20357b3c048682ad933c8baf8cae3adc><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image class=lightbox-image loading=lazy></a></p><ul><li>Open a browser and navigate to <code>http://[EC2-Address]:8010</code><ul><li>Replace <strong>[EC2-Address]</strong> with the ip address of your host</li></ul></li><li>Select a few locations and hit the <strong>Login</strong> button.<ul><li>Make sure to also select the <strong>Chicago</strong> Location and hit the <strong>Login</strong> button.</li></ul></li></ul><p><a href=#image-8983e8971fc65c34e65b69680918af0a class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8983e8971fc65c34e65b69680918af0a><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image class=lightbox-image loading=lazy></a></p><p>Uh oh! We received a 500 error, something is wrong there as well.</p><p><a href=#image-61563aaac789750c40bff6bdfcdff2c9 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-61563aaac789750c40bff6bdfcdff2c9><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" class=lightbox-image loading=lazy></a></p><ul><li>Return to the Splunk Observability UI and lets look once again at our Service Map</li><li>Select the <code>Instruments</code> Service</li><li>Click the <code>Breakdowns</code> dropdown on the right and select <code>location</code></li></ul><p><a href=#image-663e54399bd513171d06096eb4aac78d class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/214941419-2eaae297-e246-460b-a913-28c2a28fcd6a.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-663e54399bd513171d06096eb4aac78d><img src=https://user-images.githubusercontent.com/32849847/214941419-2eaae297-e246-460b-a913-28c2a28fcd6a.png alt=image class=lightbox-image loading=lazy></a></p><p>We see there was an un-handled exception thrown in the <code>Instruments</code> service, and some latency from our database that is related to the Chicago location!</p><ul><li>Click on Traces on the right</li><li>Click <strong>Errors Only</strong></li><li>Click one of the traces</li></ul><p><a href=#image-6f1ed872cc4598f6144525714e72aae8 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-6f1ed872cc4598f6144525714e72aae8><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" class=lightbox-image loading=lazy></a></p><p>We can see the exception was thrown by Hibernate, however it was thrown in our method <code>instruments: InstrumentRepository.findInstruments</code></p><p><a href=#image-01b3946135258cdf016ab76f2a06b19e class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-01b3946135258cdf016ab76f2a06b19e><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" class=lightbox-image loading=lazy></a></p><h2 id=lets-play-developer-again>Let&rsquo;s play developer again</h2><p>Edit the file &ldquo;instruments: InstrumentRepository.findInstruments&rdquo;</p><ul><li>Using nano:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano instruments/src/main/java/com/shabushabu/javashop/instruments/repositories/FindInstrumentRepositoryImpl.java
</span></span></code></pre></div><ul><li>Find the method: <code>findInstruments</code><ul><li>You know how to do this now, right?</li></ul></li></ul><p><a href=#image-15d4d5afe2427f295a811ba5ef5cf57c class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349802-06135d9d-d70b-4cf1-aaea-3ba737e5c2b9.png alt="Screen Shot 2022-11-28 at 8 20 24 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-15d4d5afe2427f295a811ba5ef5cf57c><img src=https://user-images.githubusercontent.com/32849847/204349802-06135d9d-d70b-4cf1-aaea-3ba737e5c2b9.png alt="Screen Shot 2022-11-28 at 8 20 24 AM" class=lightbox-image loading=lazy></a></p><p>We can see the developer accidently added the Instruments database with the Chicago Instruments database!</p><p>Let&rsquo;s change the query and fix this, remove <code>instruments_for_sale</code> from our query.</p><ul><li>Change this:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>findInstruments</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>LOGGER</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;findInstruments Called (All)&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Object</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>entityManager</span><span class=o>.</span><span class=na>createNativeQuery</span><span class=o>(</span> <span class=s>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span class=o>).</span><span class=na>getResultList</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>obj</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>to This:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>findInstruments</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>LOGGER</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;findInstruments Called (All)&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Object</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>entityManager</span><span class=o>.</span><span class=na>createNativeQuery</span><span class=o>(</span> <span class=s>&#34;SELECT * FROM instruments_for_sale_chicago&#34;</span><span class=o>).</span><span class=na>getResultList</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>obj</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><ul><li>Save the changes: <code>[CTRL]-o</code> <strong>[Enter]</strong></li><li>Exit: <code>[CTRL]-x</code></li></ul><h2 id=build-and-deploy-application-1>Build and Deploy Application</h2><ul><li>Run</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now let&rsquo;s test the Chicago location once again</p><ul><li>Open a browser and navigate to <code>http://[EC2-Address]:8010</code></li><li>Select the <code>Chicago</code> location and <code>Login</code></li></ul><p>We now see the 500 error is gone!</p><p>Let&rsquo;s confirm a clean Service Map:</p><p><a href=#image-7c25f018ebfbfd7c96345aadb2a8d47a class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7c25f018ebfbfd7c96345aadb2a8d47a><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" class=lightbox-image loading=lazy></a></p><p>If you see a clean service map, free of errors and Latency you have successfully completed the Java Instrumentation Workshop !</p><h2 id=have-a-lovely-day>Have a lovely day</h2><footer class=footline></footer></article><article class=default><h1 id=build-a-distributed-trace-in-lambda>Build a Distributed Trace in Lambda</h1><p>This lab will make a tracing superhero out of you!</p><p>In this lab you will learn how a distributed trace is constructed for a small serverless application that runs on <a href=https://aws.amazon.com/lambda/ target=_blank>AWS Lambda</a>, producing and consuming your message via <a href=https://aws.amazon.com/kinesis/ target=_blank>AWS Kinesis</a>.</p><p><a href=#image-40eac631269255a2bcdcc202eb0e69c7 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219358330-50022c0d-7882-47a3-a047-c4edda81de0d.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-40eac631269255a2bcdcc202eb0e69c7><img src=https://user-images.githubusercontent.com/5187861/219358330-50022c0d-7882-47a3-a047-c4edda81de0d.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=pre-requisites>Pre-Requisites</h2><p>You should already have the lab content available on your EC2 lab host.</p><p>Ensure that this lab&rsquo;s required folder <code>o11y-lambda-lab</code> is on your home directory:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button>
<button data-tab-item=Output class=tab-nav-button onclick='switchTab("default","Output")'>
<span>Output</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~ <span class=o>&amp;&amp;</span> ls
</span></span></code></pre></div></div><div data-tab-item=Output class=tab-content-text><p>o11y-lambda-lab</p></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>If you don&rsquo;t see it, fetch the lab contents by running the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/kdroukman/o11y-lambda-lab.git
</span></span></code></pre></div></div></div><h3 id=1-set-environment-variables>1. Set Environment Variables</h3><p>In your Splunk Observability Cloud Organisation (Org) obtain your Access Token and Realm Values.</p><p>Please reset your environment variables from the earlier lab. Take care that for this lab we may be using different names - make sure to match the Environment Variable names bellow.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Export Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Export Environment Variables")'>
<span>Export Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Export Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ACCESS_TOKEN</span><span class=o>=</span>CHANGE_ME <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nb>export</span> <span class=nv>REALM</span><span class=o>=</span>CHANGE_ME <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nb>export</span> <span class=nv>PREFIX</span><span class=o>=</span><span class=k>$(</span>hostname<span class=k>)</span>
</span></span></code></pre></div></div></div></div><h3 id=2-update-auto-instrumentation-serverless-template>2. Update Auto-instrumentation serverless template</h3><p>Update your auto-instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Substitute Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Substitute Environment Variables")'>
<span>Substitute Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Substitute Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/auto/serverless_unset.yml <span class=p>|</span> envsubst &gt; ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Check file contents" class="tab-nav-button active" onclick='switchTab("default","Check file contents")'>
<span>Check file contents</span></button>
<button data-tab-item="Expected Content" class=tab-nav-button onclick='switchTab("default","Expected Content")'>
<span>Expected Content</span></button></div><div class=tab-content><div data-tab-item="Check file contents" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div><div data-tab-item="Expected Content" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># USER SET VALUES =====================              
</span></span><span class=line><span class=cl>custom: 
</span></span><span class=line><span class=cl>  accessToken: &lt;updated to your Access Token&gt;
</span></span><span class=line><span class=cl>  realm: &lt;updated to your Realm&gt;
</span></span><span class=line><span class=cl>  prefix: &lt;updated to your Hostname&gt;
</span></span><span class=line><span class=cl>#====================================== 
</span></span></code></pre></div></div></div></div><h3 id=3-update-manual-instrumentation-template>3. Update Manual instrumentation template</h3><p>Update your manual instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Substitute Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Substitute Environment Variables")'>
<span>Substitute Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Substitute Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/manual/serverless_unset.yml <span class=p>|</span> envsubst &gt; ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Check file contents" class="tab-nav-button active" onclick='switchTab("default","Check file contents")'>
<span>Check file contents</span></button>
<button data-tab-item="Expected Content" class=tab-nav-button onclick='switchTab("default","Expected Content")'>
<span>Expected Content</span></button></div><div class=tab-content><div data-tab-item="Check file contents" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div><div data-tab-item="Expected Content" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># USER SET VALUES =====================              
</span></span><span class=line><span class=cl>custom: 
</span></span><span class=line><span class=cl>  accessToken: &lt;updated to your Access Token&gt;
</span></span><span class=line><span class=cl>  realm: &lt;updated to your Realm&gt;
</span></span><span class=line><span class=cl>  prefix: &lt;updated to your Hostname&gt;
</span></span><span class=line><span class=cl>#====================================== 
</span></span></code></pre></div></div></div></div><h3 id=4-set-your-aws-credentials>4. Set your AWS Credentials</h3><p>You will be provided with AWS Access Key ID and AWS Secret Access Key values - substitue these values in place of <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_ACCESS_KEY_SECRET</code> in the bellow command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Set AWS Credentials" class="tab-nav-button active" onclick='switchTab("default","Set AWS Credentials")'>
<span>Set AWS Credentials</span></button></div><div class=tab-content><div data-tab-item="Set AWS Credentials" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls config credentials --provider aws --key AWS_ACCCESS_KEY_ID --secret AWS_ACCESS_KEY_SECRET
</span></span></code></pre></div></div></div></div><p>This command will create a file <code>~/.aws/credentials</code> with your AWS Credentails populated.</p><p>Note that we are using <code>sls</code> here, which is a <a href=https://www.serverless.com/ target=_blank>Serverless</a> framework for developing and deploying AWS Lambda functions. We will be using this command throughout the lab.</p><p>Now you are set up and ready go!</p><h2 id=auto-instrumentation>Auto-Instrumentation</h2><p>Navigate to the <code>auto</code> directory that contains auto-instrumentation code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-lab/auto
</span></span></code></pre></div></div></div></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat serverless.yml
</span></span></code></pre></div></div></div></div><ol><li>Can you identify which AWS entities are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?</li><li>Can you determine which instrumentation information is being provided by the Environment Variables?</li></ol><p>You should see the Splunk OpenTelemetry Lambda layer being added to each fuction.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>layers:
</span></span><span class=line><span class=cl>      - arn:aws:lambda:us-east-1:254067382080:layer:splunk-apm:70
</span></span></code></pre></div><p>You can see the relevant layer ARNs (Amazon Resource Name) and latest versions for each AWS region here: <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md target=_blank>https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md</a></p><p>You should also see a section where the Environment variables that are being set.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> environment:
</span></span><span class=line><span class=cl>      AWS_LAMBDA_EXEC_WRAPPER: /opt/nodejs-otel-handler
</span></span><span class=line><span class=cl>      OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${self:custom.prefix}-apm-lambda
</span></span><span class=line><span class=cl>      OTEL_SERVICE_NAME: consumer-lambda
</span></span><span class=line><span class=cl>      SPLUNK_ACCESS_TOKEN: ${self:custom.accessToken}
</span></span><span class=line><span class=cl>      SPLUNK_REALM: ${self:custom.realm}
</span></span></code></pre></div><p>Using the environment variables we are configuring and enriching our auto-instrumentation.</p><p>Here we provide minimum information, such as NodeJS wrapper location in the Splunk APM Layer, environment name, service name, and our Splunk Org credentials. We are sending trace data directly to Splunk Observability Cloud. You could alternatively export traces to an OpenTelemetry Collector set up in <a href=https://opentelemetry.io/docs/collector/deployment/#gateway target=_blank>Gateway</a> mode.</p><p>Take a look at the function code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat handler.js
</span></span></code></pre></div></div></div></div><ol><li>Can you identify the code for <strong>producer</strong> function?</li><li>Can you identify the code for <strong>consumer</strong> function?</li></ol><p>Notice there is no mention of Splunk or OpenTelemetry in the code. We are adding the instrumentation using the Lambda layer and Environment Variables only.</p><h3 id=deploy-your-lambdas>Deploy your Lambdas</h3><p>Run the following command to deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Command" class="tab-nav-button active" onclick='switchTab("default","Deploy Command")'>
<span>Deploy Command</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls deploy
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Deploying hostname-lambda-lab to stage dev (us-east-1)
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span><span class=line><span class=cl>functions:
</span></span><span class=line><span class=cl>  producer: hostname-lambda-lab-dev-producer (1.6 kB)
</span></span><span class=line><span class=cl>  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)
</span></span></code></pre></div></div></div></div><p>This command will follow the instructions in your <code>serverless.yml</code> template to create your Lambda functions and your Kinesis stream.
Note it may take a <em>1-2 minutes</em> to execute.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><code>serverless.yml</code> is in fact a CloudFormation template. CloudFormation is an infrastructure as code service from AWS. You can read more about it here - <a href=https://aws.amazon.com/cloudformation/ target=_blank>https://aws.amazon.com/cloudformation/</a></p></div></div><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls info
</span></span></code></pre></div></div></div></div><p>Take note of your endpoint value:</p><p><a href=#image-22fb37ed4a619099d43f4c7d67f5e8f4 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219366650-2babbe19-8253-43a0-8521-f47c1dda7200.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-22fb37ed4a619099d43f4c7d67f5e8f4><img src=https://user-images.githubusercontent.com/5187861/219366650-2babbe19-8253-43a0-8521-f47c1dda7200.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic>Send some Traffic</h3><p>Use the <code>curl</code> command to send a payload to your <strong>producer</strong> function.
Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -d <span class=s1>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div></div></div></div><p>For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span><span class=s2>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Internal server error&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: <em>re-send that messate <strong>5+ times</strong></em>.
You should keep seeing a success message after each send.</p><p>Check the lambda logs output.</p><h4 id=producer-function-logs>Producer function logs</h4><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Producer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Producer Function Logs")'>
<span>Producer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Producer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f producer
</span></span></code></pre></div></div></div></div><h4 id=consumer-function-logs>Consumer function logs</h4><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Consumer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Consumer Function Logs")'>
<span>Consumer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Consumer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f consumer
</span></span></code></pre></div></div></div></div><p>Examine the logs carefully. Do you see OpenTelemetry being loaded? Look out for lines with <code>splunk-extension-wrapper</code>.</p><h3 id=find-your-lambda-data-in-splunk-apm>Find your Lambda data in Splunk APM</h3><p>Now it&rsquo;s time to check how your Lambda traffic has been captured in Splunk APM.</p><p>Navigate to your <a href=https://app.us1.signalfx.com target=_blank>Splunk Observability Cloud</a></p><p>Select APM from the Main Menu and then select your APM Environment. Your APM environment should be in the format <code>$(hostname)-apm-lambda</code> where the hostname value is a four letter name of your lab host. (Check it by looking at your command prompt, or by running <code>echo $(hostname)</code>)</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>It may take a few minutes for you traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environement name in the list of Envrionments</p></div></div><p><a href=#image-ba25c08ceb098f631bee25a1479add09 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219368081-20a1522e-a908-40d8-b635-942bffdbb0bd.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ba25c08ceb098f631bee25a1479add09><img src=https://user-images.githubusercontent.com/5187861/219368081-20a1522e-a908-40d8-b635-942bffdbb0bd.png alt=image class=lightbox-image loading=lazy></a></p><p>Go to Explore the Service Map to see the Dependencies between your Lambda Functions.</p><p><a href=#image-323a624b35d23a084d8de2c2649a8f61 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-323a624b35d23a084d8de2c2649a8f61><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <code>producer-lambda</code> and the call it is making to <code>Kinesis</code> service. What about your <code>consumer-lambda</code>?
<a href=#image-5f3b85b0e8c36b543714a1561e6ec392 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219368350-5bebb65b-d658-42be-9895-5d39a8d60a2d.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5f3b85b0e8c36b543714a1561e6ec392><img src=https://user-images.githubusercontent.com/5187861/219368350-5bebb65b-d658-42be-9895-5d39a8d60a2d.png alt=image class=lightbox-image loading=lazy></a></p><p>Click into <em>Traces</em> and examine some traces that container <strong>procuder</strong> function calls and traces with <strong>consumer</strong> function calls.
<a href=#image-b342d5376989dc67d5ad4582e69b7efe class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b342d5376989dc67d5ad4582e69b7efe><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see the <code>producer-lambda</code> putting a Record on the Kinesis stream. But the action of <code>consumer-function</code> is disconnected!</p><p>This is because the <strong>Trace Context</strong> is not being propagated.</p><p>This is not something that is supported automatically Out-of-the-Box by Kinesis service at the time of this lab. Our Distributed Trace stops at <em>Kinesis</em> inferred service, and we can&rsquo;t see the propagation any further.</p><p>Not yet&mldr;</p><p>Let&rsquo;s see how we work around this in the next section of this lab.</p><h2 id=manual-instrumentation>Manual Instrumentation</h2><p>Navigate to the <code>manual</code> directory that contains manually instrumentated code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-lab/manual
</span></span></code></pre></div></div></div></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat serverless.yml
</span></span></code></pre></div></div></div></div><p>Do you see any difference from the same file in your <code>auto</code> directory?</p><p>You can try to compare them with a <code>diff</code> command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Diff Command" class="tab-nav-button active" onclick='switchTab("default","Diff Command")'>
<span>Diff Command</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Diff Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-lab/auto/serverless.yml ~/o11y-lambda-lab/manual/serverless.yml 
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>19c19
</span></span><span class=line><span class=cl>&lt; #======================================    
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>&gt; #======================================   
</span></span></code></pre></div></div></div></div><p>There is no difference! <em>(Well, there shouldn&rsquo;t be. Ask your lab facilitator to assist you if there is)</em></p><p>Now compare <code>handler.js</code> it with the same file in <code>auto</code> directory using the <code>diff</code> command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Diff Command" class="tab-nav-button active" onclick='switchTab("default","Diff Command")'>
<span>Diff Command</span></button></div><div class=tab-content><div data-tab-item="Diff Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-lab/auto/handler.js ~/o11y-lambda-lab/manual/handler.js 
</span></span></code></pre></div></div></div></div><p>Look at all these differences!</p><p><em>You may wish to view the entire file with <code>cat handler.js</code> command and examine its content.</em></p><p>Notice how we are now importing some OpenTelemetry libraries directly into our function to handle some of the manual instrumenation tasks we require.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>const otelapi  = require(&#39;@opentelemetry/api&#39;);
</span></span><span class=line><span class=cl>const otelcore = require(&#39;@opentelemetry/core&#39;);
</span></span></code></pre></div><p>We are using <a href=https://www.npmjs.com/package/@opentelemetry/api target=_blank>https://www.npmjs.com/package/@opentelemetry/api</a> to manipulate the tracing logic in our functions.
We are using <a href=https://www.npmjs.com/package/@opentelemetry/core target=_blank>https://www.npmjs.com/package/@opentelemetry/core</a> to access the <strong>Propagator</strong> objects that we will use to manually propagate our context with.</p><h3 id=inject-trace-context-in-producer-function>Inject Trace Context in Producer Function</h3><p>The bellow code executes the following steps inside the Producer function:</p><ol><li>Get the current Active Span.</li><li>Create a Propagator.</li><li>Initialize a context carrier object.</li><li>Inject the context of the active span into the carrier object.</li><li>Modify the record we are about to put on our Kinesis stream to include the carrier that will carry the active span&rsquo;s context to the consumer.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>const activeSpan = otelapi.trace.getSpan(otelapi.context.active());
</span></span><span class=line><span class=cl>const propagator = new otelcore.W3CTraceContextPropagator();
</span></span><span class=line><span class=cl>let carrier = {};
</span></span><span class=line><span class=cl>propagator.inject(otelapi.trace.setSpanContext(otelapi.ROOT_CONTEXT, activeSpan.spanContext()),
</span></span><span class=line><span class=cl>                 carrier,
</span></span><span class=line><span class=cl>                otelapi.defaultTextMapSetter
</span></span><span class=line><span class=cl>        );
</span></span><span class=line><span class=cl>const data = &#34;{\&#34;tracecontext\&#34;: &#34; + JSON.stringify(carrier) + &#34;, \&#34;record\&#34;:&#34; + event.body + &#34;}&#34;;
</span></span><span class=line><span class=cl>console.log(`Record with Trace Context added: 
</span></span><span class=line><span class=cl>             ${data}`);
</span></span></code></pre></div><h4 id=extract-trace-context-in-consumer-function>Extract Trace Context in Consumer Function</h4><p>The bellow code executes the following steps inside the Consumer function:</p><ol><li>Extract the context that we obtained from the Producer into a carrier object.</li><li>Create a Propagator.</li><li>Extract the context from the carrier object in Customer function&rsquo;s parent span context.</li><li>Start a new span with the parent span context.</li><li>Bonus: Add extra attributes to your span, including custom ones with the values from your message!</li><li>Once completed, end the span.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>const carrier = JSON.parse( message ).tracecontext;
</span></span><span class=line><span class=cl>const propagator = new otelcore.W3CTraceContextPropagator();
</span></span><span class=line><span class=cl>const parentContext = propagator.extract(otelapi.ROOT_CONTEXT, carrier, otelapi.defaultTextMapGetter);
</span></span><span class=line><span class=cl>const tracer = otelapi.trace.getTracer(process.env.OTEL_SERVICE_NAME);
</span></span><span class=line><span class=cl>const span = tracer.startSpan(&#34;Kinesis.getRecord&#34;, undefined, parentContext);
</span></span><span class=line><span class=cl>                         
</span></span><span class=line><span class=cl>span.setAttribute(&#34;span.kind&#34;, &#34;server&#34;);
</span></span><span class=line><span class=cl>const body = JSON.parse( message ).record;
</span></span><span class=line><span class=cl>if (body.name) {
</span></span><span class=line><span class=cl>    span.setAttribute(&#34;custom.tag.name&#34;, body.name);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl> if (body.superpower) {
</span></span><span class=line><span class=cl>    span.setAttribute(&#34;custom.tag.superpower&#34;, body.superpower);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>  --- function does some work
</span></span><span class=line><span class=cl> span.end();
</span></span></code></pre></div><p>Now let&rsquo;s see the difference this makes.</p><h3 id=re-deploy-your-lambdas>Re-deploy your Lambdas</h3><p>While remaining in your <code>manual</code> directory, run the following commandd to re-deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Producer Code" class="tab-nav-button active" onclick='switchTab("default","Deploy Producer Code")'>
<span>Deploy Producer Code</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Producer Code" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls deploy -f producer
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Deploying function producer to stage dev (us-east-1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✔ Function code deployed (6s)
</span></span><span class=line><span class=cl>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Consumer Code" class="tab-nav-button active" onclick='switchTab("default","Deploy Consumer Code")'>
<span>Deploy Consumer Code</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Consumer Code" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls deploy -f consumer
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Deploying function consumer to stage dev (us-east-1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✔ Function code deployed (6s)
</span></span><span class=line><span class=cl>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div><p>Note that this deployment now only updates the code changes within the function. Our configuration remains the same.</p><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls info
</span></span></code></pre></div></div></div></div><p>You endpoint value should remain the same:</p><p><a href=#image-9a1e573b14501f2b3ecc9e35256372a4 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219371979-4e474746-2633-4824-9d7a-1b39d3d2ce3f.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-9a1e573b14501f2b3ecc9e35256372a4><img src=https://user-images.githubusercontent.com/5187861/219371979-4e474746-2633-4824-9d7a-1b39d3d2ce3f.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic-again>Send some Traffic again</h3><p>Use the <code>curl</code> command to send a payload to your <strong>producer</strong> function.
Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -d <span class=s1>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div></div></div></div><p>For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span><span class=s2>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Internal server error&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: <em>re-send that messate <strong>5+ times</strong></em>. You should keep seeing a success message after each send.</p><p>Check the lambda logs output.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Producer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Producer Function Logs")'>
<span>Producer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Producer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f producer
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Consumer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Consumer Function Logs")'>
<span>Consumer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Consumer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f consumer
</span></span></code></pre></div></div></div></div><p>Examine the logs carefully. Do you notice the difference?</p><p>Note that we are logging our Record together with the Trace context that we have added to it. Copy one of the underlined sub-sections of your trace parent context, and save it for later.</p><p><a href=#image-e31ae6693da4eb360f9cac0e115f36c2 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219372916-ed1afce5-176f-4baf-a9a3-0aae29e3f01b.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e31ae6693da4eb360f9cac0e115f36c2><img src=https://user-images.githubusercontent.com/5187861/219372916-ed1afce5-176f-4baf-a9a3-0aae29e3f01b.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=find-your-updated-lambda-data-in-splunk-apm>Find your updated Lambda data in Splunk APM</h3><p>Navigate back to APM in <a href=https://app.us1.signalfx.com/#/apm target=_blank>Splunk Observabilty Cloud</a></p><p>Go back to your Service Dependency map. Notice the difference?</p><p><a href=#image-3b9822eeb7aa8787e5d187ed86786079 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219373312-0d556475-9f27-4729-af38-ac94f0773c5c.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-3b9822eeb7aa8787e5d187ed86786079><img src=https://user-images.githubusercontent.com/5187861/219373312-0d556475-9f27-4729-af38-ac94f0773c5c.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <strong>consumer-lambda</strong> now clearly connected to the <strong>producer-lambda</strong>.</p><p>Remember the value you copied from your producer logs? You can run <code>sls logs -f consumer</code> command again on your EC2 lab host to fetch one.</p><p>Take that value, and paste it into trace search:</p><p><a href=#image-b708664d3d93883192236ada1158aa74 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219373635-cc5a5841-5afb-49f9-baea-9d4d45aabfb6.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b708664d3d93883192236ada1158aa74><img src=https://user-images.githubusercontent.com/5187861/219373635-cc5a5841-5afb-49f9-baea-9d4d45aabfb6.png alt=image class=lightbox-image loading=lazy></a></p><p>Click on <em>Go</em> and you should be able to find the logged Trace:</p><p><a href=#image-3ae9f958c3ecd50cf5f8a785fa661e50 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219374024-de32aa68-f34a-43eb-8f00-5cc698864b00.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-3ae9f958c3ecd50cf5f8a785fa661e50><img src=https://user-images.githubusercontent.com/5187861/219374024-de32aa68-f34a-43eb-8f00-5cc698864b00.png alt=image class=lightbox-image loading=lazy></a></p><p>Notice that the <strong>Trace ID</strong> is something that makes up the trace <em>context</em> that we propagated.</p><p>You can read up on the two common propagation standards:</p><ol><li>W3C: <a href=https://www.w3.org/TR/trace-context/#traceparent-header target=_blank>https://www.w3.org/TR/trace-context/#traceparent-header</a></li><li>B3: <a href=https://github.com/openzipkin/b3-propagation#overall-process target=_blank>https://github.com/openzipkin/b3-propagation#overall-process</a></li></ol><p>Which one are we using? <em>It should be self-explanatory from the Propagator we are creating in the Functions</em></p><p><strong>Bonus Question:</strong> What happens if we mix and match the W3C and B3 headers?</p><p>Expand the <strong>consumer-lambda</strong> span. Can you find the attributes from your message?</p><p><a href=#image-5dbae2c965065da881e57183322f107e class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219374303-d143515b-d1b1-46b4-bd03-0c4653ea08c0.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5dbae2c965065da881e57183322f107e><img src=https://user-images.githubusercontent.com/5187861/219374303-d143515b-d1b1-46b4-bd03-0c4653ea08c0.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=before-you-go>Before you Go</h2><p>Please kindly clean up your lab using the following command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Remove Functions" class="tab-nav-button active" onclick='switchTab("default","Remove Functions")'>
<span>Remove Functions</span></button></div><div class=tab-content><div data-tab-item="Remove Functions" class="tab-content-text active"><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls remove
</span></span></code></pre></div></div></div></div><h2 id=conclusion>Conclusion</h2><p>Congratuations on finishing the lab. You have seen how we complement auto-instrumentation with manual steps to force <strong>Producer</strong> function&rsquo;s context to be sent to <strong>Consumer</strong> function via a Record put on a Kinesis stream. This allowed us to build the expected Distributed Trace.</p><p><a href=#image-d5d0ba88ade5ebf0a689a7327d3df227 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219375907-5a5e23ce-b9bb-4939-865d-7dbbaa668c53.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d5d0ba88ade5ebf0a689a7327d3df227><img src=https://user-images.githubusercontent.com/5187861/219375907-5a5e23ce-b9bb-4939-865d-7dbbaa668c53.png alt=image class=lightbox-image loading=lazy></a></p><p>You can now built out a Trace manually by linking two different functions together. This is very powerful when your auto-instrumenation, or third-party systems, do not support context propagation out of the box.</p><footer class=footline></footer></article></section></section></div></main></div><script src=../js/clipboard.min.js?1680255135 defer></script>
<script src=../js/perfect-scrollbar.min.js?1680255135 defer></script>
<script src=../js/theme.js?1680255135 defer></script></body></html>